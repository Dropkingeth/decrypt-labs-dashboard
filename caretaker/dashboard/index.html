<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Decrypt Labs ‚Äî Mission Control</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöÄ</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
  <style>
    :root {
      --bg-dark: #0a0a12;
      --bg-card: rgba(255,255,255,0.03);
      --bg-card-hover: rgba(255,255,255,0.06);
      --accent-cyan: #00d4ff;
      --accent-green: #00ff88;
      --accent-red: #ff4455;
      --accent-orange: #ffaa00;
      --accent-purple: #aa66ff;
      --accent-yellow: #ffdd44;
      --text-primary: #ffffff;
      --text-secondary: #88889a;
      --text-dim: #555566;
      --border-color: rgba(255,255,255,0.08);
      --border-glow-cyan: rgba(0,212,255,0.3);
      --border-glow-green: rgba(0,255,136,0.3);
      --border-glow-purple: rgba(170,102,255,0.3);
    }

    /* Live Signal Monitor */
    .signal-monitor-grid {
      display: grid;
      grid-template-columns: 60% 40%;
      gap: 20px;
      margin: 24px auto;
      max-width: 1200px;
    }
    @media (max-width: 900px) {
      .signal-monitor-grid { grid-template-columns: 1fr; }
    }
    .monitor-card {
      background: rgba(255,255,255,0.03);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 24px;
      height: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    .monitor-card.active-signal {
      border-color: var(--accent-green);
      box-shadow: 0 0 20px rgba(0,255,136,0.1);
      animation: pulse-border 2s infinite;
    }
    @keyframes pulse-border {
      0% { border-color: rgba(0,255,136,0.3); }
      50% { border-color: rgba(0,255,136,0.8); }
      100% { border-color: rgba(0,255,136,0.3); }
    }
    .monitor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      padding-bottom: 12px;
    }
    .monitor-title {
      font-size: 14px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }
    .signal-badge-large {
      font-size: 14px;
      font-weight: 800;
      padding: 6px 14px;
      border-radius: 6px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .signal-badge-large.bull { background: rgba(0,255,136,0.15); color: var(--accent-green); border: 1px solid rgba(0,255,136,0.3); }
    .signal-badge-large.bear { background: rgba(255,68,68,0.15); color: var(--accent-red); border: 1px solid rgba(255,68,68,0.3); }

    .monitor-data-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }
    .data-item-label { font-size: 11px; color: var(--text-dim); margin-bottom: 4px; }
    .data-item-value { font-size: 15px; color: var(--text-primary); font-family: 'SF Mono', monospace; }
    .data-highlight { color: var(--accent-cyan); }

    .confidence-bar-bg {
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 6px;
    }
    .confidence-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple));
      width: 0%;
      transition: width 0.5s ease;
    }

    .x-preview-box {
      background: rgba(0,0,0,0.4);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      font-size: 14px;
      line-height: 1.5;
      color: #fff;
      white-space: pre-wrap;
      margin-bottom: 16px;
      flex: 1;
    }
    .x-btn {
      width: 100%;
      padding: 12px;
      background: var(--text-dim);
      color: rgba(0,0,0,0.5);
      border: none;
      border-radius: 8px;
      font-weight: 700;
      cursor: not-allowed;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
    }
    .x-btn.ready {
      background: #fff;
      color: #000;
      cursor: pointer;
    }
    .x-btn.ready:hover { opacity: 0.9; }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    /* === PASSWORD GATE === */
    #auth-gate {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: var(--bg-dark);
      display: flex; align-items: center; justify-content: center;
      z-index: 99999;
      transition: opacity 0.4s ease;
    }
    #auth-gate.hidden { opacity: 0; pointer-events: none; }
    .auth-box {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 48px 40px;
      text-align: center;
      max-width: 380px;
      width: 90%;
      backdrop-filter: blur(20px);
      box-shadow: 0 0 60px rgba(0,212,255,0.05);
    }
    .auth-box .auth-icon { font-size: 48px; margin-bottom: 16px; }
    .auth-box h2 {
      font-family: 'Orbitron', monospace;
      font-size: 18px;
      color: var(--accent-cyan);
      margin-bottom: 6px;
      letter-spacing: 2px;
    }
    .auth-box .auth-sub {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 28px;
    }
    .auth-box input {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
      margin-bottom: 16px;
    }
    .auth-box input:focus { border-color: var(--accent-cyan); }
    .auth-box input::placeholder { color: var(--text-dim); }
    .auth-box button {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
      border: none;
      border-radius: 8px;
      color: #000;
      font-family: 'Orbitron', monospace;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 2px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .auth-box button:hover { opacity: 0.85; }
    .auth-box .auth-error {
      color: var(--accent-red);
      font-size: 11px;
      margin-top: 12px;
      min-height: 16px;
    }
    .auth-box .auth-lock {
      font-size: 10px;
      color: var(--text-dim);
      margin-top: 16px;
    }

    body {
      font-family: 'JetBrains Mono', monospace;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: 
        radial-gradient(ellipse at 20% 20%, rgba(0,212,255,0.03) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(170,102,255,0.03) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 50%, rgba(0,255,136,0.02) 0%, transparent 60%);
      pointer-events: none;
      z-index: 0;
    }

    h1, h2, h3, h4, h5, h6, .font-heading {
      font-family: 'Orbitron', sans-serif;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NAV BAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .navbar {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(10,10,18,0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      padding: 0 16px;
      height: 52px;
      gap: 2px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .navbar::-webkit-scrollbar { height: 0; }

    .nav-tab {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      white-space: nowrap;
      transition: all 0.2s;
      border: 1px solid transparent;
      font-family: 'JetBrains Mono', monospace;
    }

    .nav-tab:hover {
      color: var(--text-primary);
      background: rgba(255,255,255,0.05);
    }

    .nav-tab.active {
      color: var(--text-primary);
      background: rgba(255,255,255,0.08);
      border-color: var(--border-color);
    }

    .nav-tab .icon { font-size: 15px; }

    .nav-divider {
      display: flex;
      align-items: center;
      padding: 0 6px;
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      color: var(--accent-primary);
      white-space: nowrap;
      opacity: 0.6;
      border-left: 1px solid rgba(255,255,255,0.08);
      margin-left: 4px;
      padding-left: 12px;
      height: 28px;
      font-family: 'JetBrains Mono', monospace;
    }

    .nav-spacer { flex: 1; }

    .server-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-secondary);
      padding: 4px 10px;
      border-radius: 20px;
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border-color);
      white-space: nowrap;
    }

    .status-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      display: inline-block;
      flex-shrink: 0;
    }

    .status-dot.green { background: var(--accent-green); box-shadow: 0 0 6px var(--accent-green); }
    .status-dot.yellow { background: var(--accent-yellow); box-shadow: 0 0 6px var(--accent-yellow); }
    .status-dot.red { background: var(--accent-red); box-shadow: 0 0 6px var(--accent-red); }
    .status-dot.grey { background: #555; }
    .status-dot.orange { background: var(--accent-orange); box-shadow: 0 0 6px var(--accent-orange); }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN CONTENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .main-content {
      position: relative;
      z-index: 1;
      padding: 24px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .section-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .section-subtitle {
      color: var(--text-secondary);
      font-size: 13px;
      margin-bottom: 24px;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CARDS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      transition: all 0.2s;
    }

    .card:hover {
      background: var(--bg-card-hover);
      border-color: rgba(255,255,255,0.12);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .card-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB 1: MISSION CONTROL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 2px;
    }

    .stat-card.cyan::before { background: linear-gradient(90deg, var(--accent-cyan), transparent); }
    .stat-card.green::before { background: linear-gradient(90deg, var(--accent-green), transparent); }
    .stat-card.purple::before { background: linear-gradient(90deg, var(--accent-purple), transparent); }
    .stat-card.orange::before { background: linear-gradient(90deg, var(--accent-orange), transparent); }

    .stat-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .stat-value {
      font-family: 'Orbitron', sans-serif;
      font-size: 28px;
      font-weight: 700;
    }

    .stat-card.cyan .stat-value { color: var(--accent-cyan); }
    .stat-card.green .stat-value { color: var(--accent-green); }
    .stat-card.purple .stat-value { color: var(--accent-purple); }
    .stat-card.orange .stat-value { color: var(--accent-orange); }

    .stat-change {
      font-size: 11px;
      margin-top: 4px;
      color: var(--text-dim);
    }

    .stat-change.positive { color: var(--accent-green); }
    .stat-change.negative { color: var(--accent-red); }

    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    @media (max-width: 900px) {
      .dashboard-grid { grid-template-columns: 1fr; }
    }

    .upcoming-task {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-color);
      font-size: 13px;
    }

    .upcoming-task:last-child { border-bottom: none; }

    .upcoming-task-name { color: var(--text-primary); }
    .upcoming-task-time { color: var(--text-dim); font-size: 11px; }

    /* Projects completed list */
    .project-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-color);
      font-size: 13px;
    }
    .project-item:last-child { border-bottom: none; }
    .project-check { color: var(--accent-green); font-size: 14px; flex-shrink: 0; }
    .project-name { color: var(--text-primary); }

    /* Team badge */
    .team-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 14px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border-color);
    }
    .team-badge .role { color: var(--text-dim); font-weight: 400; font-size: 11px; }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB 2: TASKS (KANBAN) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .kanban-board {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      min-height: 500px;
    }

    @media (max-width: 1000px) {
      .kanban-board { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 600px) {
      .kanban-board { grid-template-columns: 1fr; }
    }

    .kanban-column {
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      min-height: 400px;
    }

    .kanban-column-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .kanban-column-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .kanban-count {
      font-size: 11px;
      background: rgba(255,255,255,0.08);
      padding: 2px 8px;
      border-radius: 10px;
      color: var(--text-secondary);
    }

    .task-card {
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 14px;
      margin-bottom: 10px;
      cursor: grab;
      transition: all 0.2s;
    }

    .task-card:hover {
      background: rgba(255,255,255,0.07);
      border-color: rgba(255,255,255,0.15);
      transform: translateY(-1px);
    }

    .task-card.dragging {
      opacity: 0.5;
      transform: rotate(2deg);
    }

    .task-title { font-size: 13px; font-weight: 600; margin-bottom: 6px; }
    .task-desc { font-size: 11px; color: var(--text-secondary); margin-bottom: 10px; line-height: 1.4; }

    .task-meta {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .task-tag {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .task-tag.high { background: rgba(255,68,85,0.15); color: var(--accent-red); border: 1px solid rgba(255,68,85,0.3); }
    .task-tag.medium { background: rgba(255,170,0,0.15); color: var(--accent-orange); border: 1px solid rgba(255,170,0,0.3); }
    .task-tag.low { background: rgba(0,212,255,0.15); color: var(--accent-cyan); border: 1px solid rgba(0,212,255,0.3); }

    .task-assignee {
      font-size: 10px;
      color: var(--text-dim);
      margin-left: auto;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB 3: CALENDAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .calendar-controls {
      display: flex;
      gap: 8px;
    }

    .cal-btn {
      padding: 6px 14px;
      border: 1px solid var(--border-color);
      background: rgba(255,255,255,0.05);
      color: var(--text-primary);
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      font-family: 'JetBrains Mono', monospace;
      transition: all 0.2s;
    }

    .cal-btn:hover { background: rgba(255,255,255,0.1); }
    .cal-btn.active { background: rgba(0,212,255,0.15); border-color: var(--accent-cyan); color: var(--accent-cyan); }

    .always-running {
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 20px;
    }

    .always-running-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--accent-cyan);
    }

    .always-running-pills {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .cron-pill {
      font-size: 11px;
      padding: 5px 12px;
      border-radius: 20px;
      background: rgba(0,212,255,0.12);
      border: 1px solid rgba(0,212,255,0.25);
      color: var(--accent-cyan);
    }

    /* Pipeline Status Board */
    .pipeline-step { position: relative; }
    .pipeline-node {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-left: 3px solid;
      border-radius: 10px;
      padding: 14px 16px;
      transition: all 0.2s;
    }
    .pipeline-node:hover { background: rgba(255,255,255,0.06); transform: translateX(4px); }
    .pipeline-header { display: flex; align-items: center; gap: 12px; margin-bottom: 6px; }
    .pipeline-icon {
      width: 36px; height: 36px; border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; flex-shrink: 0;
    }
    .pipeline-title { font-size: 13px; font-weight: 600; color: var(--text-primary); }
    .pipeline-agent { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
    .pipeline-status {
      font-size: 11px; color: var(--text-secondary);
      display: flex; align-items: center; gap: 6px; flex-shrink: 0;
      padding: 3px 10px; border-radius: 12px; background: rgba(0,255,136,0.08);
    }
    .pipeline-status .status-dot { width: 6px; height: 6px; }
    .pipeline-detail {
      font-size: 11px; color: var(--text-secondary); line-height: 1.6;
      padding: 4px 0 4px 48px;
    }
    .pipeline-detail code {
      background: rgba(0,212,255,0.1); padding: 1px 6px; border-radius: 4px;
      font-size: 10px; color: var(--accent-green);
    }
    .pipeline-meta {
      display: flex; flex-wrap: wrap; gap: 12px; padding: 4px 0 0 48px;
      font-size: 10px; color: rgba(255,255,255,0.35);
    }
    .pipeline-meta code { background: rgba(0,212,255,0.08); padding: 1px 5px; border-radius: 3px; font-size: 10px; }
    .pipeline-arrow {
      text-align: center; color: rgba(255,255,255,0.15); font-size: 14px;
      padding: 2px 0; line-height: 1;
    }
    @media (max-width: 768px) {
      .pipeline-detail, .pipeline-meta { padding-left: 0; }
      .pipeline-header { flex-wrap: wrap; }
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-bottom: 24px;
    }

    @media (max-width: 900px) {
      .calendar-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 500px) {
      .calendar-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    .cal-day {
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 12px;
      min-height: 220px;
    }

    .cal-day-name {
      font-family: 'Orbitron', sans-serif;
      font-size: 12px;
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--text-secondary);
    }

    .cal-event {
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 11px;
      margin-bottom: 6px;
      font-weight: 500;
      line-height: 1.3;
    }

    .cal-event .cal-event-time {
      font-size: 9px;
      opacity: 0.7;
      margin-top: 2px;
    }

    .cal-event.cyan { background: rgba(0,212,255,0.15); color: var(--accent-cyan); border-left: 3px solid var(--accent-cyan); }
    .cal-event.green { background: rgba(0,255,136,0.12); color: var(--accent-green); border-left: 3px solid var(--accent-green); }
    .cal-event.purple { background: rgba(170,102,255,0.15); color: var(--accent-purple); border-left: 3px solid var(--accent-purple); }
    .cal-event.orange { background: rgba(255,170,0,0.15); color: var(--accent-orange); border-left: 3px solid var(--accent-orange); }
    .cal-event.red { background: rgba(255,68,85,0.12); color: var(--accent-red); border-left: 3px solid var(--accent-red); }
    .cal-event.yellow { background: rgba(255,221,68,0.12); color: var(--accent-yellow); border-left: 3px solid var(--accent-yellow); }

    .cal-today { border-color: var(--accent-cyan) !important; background: rgba(0,212,255,0.04) !important; }
    .cal-today .cal-day-name { color: var(--accent-cyan); }
    .cal-weekend { opacity: 0.5; }
    .cal-weekend .cal-day-name { color: rgba(255,255,255,0.3); }

    .countdown-section {
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
    }

    .countdown-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 16px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .countdown-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-color);
      font-size: 13px;
    }

    .countdown-item:last-child { border-bottom: none; }

    .countdown-label { display: flex; align-items: center; gap: 8px; }
    .countdown-label .dot { width: 6px; height: 6px; border-radius: 50%; }
    .countdown-value { color: var(--text-dim); font-size: 12px; }

    /* Monthly expenses */
    .expenses-section {
      margin-top: 24px;
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
    }

    .expenses-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 16px;
      color: var(--accent-orange);
      text-transform: uppercase;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .expense-table {
      width: 100%;
      border-collapse: collapse;
    }

    .expense-table th {
      font-family: 'Orbitron', sans-serif;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-dim);
      text-align: left;
      padding: 8px 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .expense-table th:last-child { text-align: right; }

    .expense-table td {
      font-size: 13px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }

    .expense-table tr:last-child td { border-bottom: none; }

    .expense-table td:last-child {
      text-align: right;
      font-family: 'Orbitron', sans-serif;
      font-weight: 600;
      color: var(--accent-orange);
    }

    .expense-table .expense-name { color: var(--text-primary); }
    .expense-table .expense-note { color: var(--text-dim); font-size: 11px; }
    .expense-table .expense-free { color: var(--accent-green); }

    .todo-note-input {
      width: 100%;
      padding: 4px 8px;
      margin-top: 4px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 4px;
      color: var(--text-secondary);
      font-size: 11px;
      font-family: 'JetBrains Mono', monospace;
      outline: none;
      transition: all 0.2s;
    }
    .todo-note-input:focus {
      border-color: var(--accent-cyan);
      background: rgba(0,212,255,0.06);
      color: var(--text-primary);
    }
    .todo-note-input::placeholder { color: rgba(255,255,255,0.2); }
    .todo-note-saved {
      font-size: 11px;
      color: var(--text-dim);
      margin-top: 4px;
      font-style: italic;
    }
    .todo-sent-badge {
      display: inline-block;
      font-size: 9px;
      padding: 1px 6px;
      border-radius: 3px;
      background: rgba(0,255,136,0.1);
      color: var(--accent-green);
      margin-left: 6px;
    }

    .expense-table td[contenteditable="true"] {
      outline: none;
      cursor: text;
    }
    .expense-table td[contenteditable="true"]:hover {
      background: rgba(255,255,255,0.04);
      border-radius: 4px;
    }
    .expense-table td[contenteditable="true"]:focus {
      background: rgba(0,212,255,0.08);
      border-radius: 4px;
      box-shadow: 0 0 0 1px var(--accent-cyan);
    }
    .expense-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .expense-btn {
      padding: 6px 14px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: rgba(255,255,255,0.03);
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
      font-family: 'JetBrains Mono', monospace;
      transition: all 0.2s;
    }
    .expense-btn:hover { background: rgba(255,255,255,0.08); color: var(--text-primary); }
    .expense-btn.add { border-color: rgba(0,212,255,0.3); color: var(--accent-cyan); }
    .expense-btn.add:hover { background: rgba(0,212,255,0.1); }
    .expense-btn.save { border-color: rgba(0,255,136,0.3); color: var(--accent-green); }
    .expense-btn.save:hover { background: rgba(0,255,136,0.1); }
    .expense-btn.remove { border-color: rgba(255,68,85,0.3); color: var(--accent-red); font-size: 10px; padding: 2px 6px; }
    .expense-btn.remove:hover { background: rgba(255,68,85,0.1); }

    .expense-total {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 2px solid var(--border-color);
    }

    .expense-total-label {
      font-family: 'Orbitron', sans-serif;
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .expense-total-value {
      font-family: 'Orbitron', sans-serif;
      font-size: 22px;
      font-weight: 700;
      color: var(--accent-orange);
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB 6: PERSONAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .personal-calendar-section {
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .personal-cal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .personal-cal-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 13px;
      font-weight: 700;
      color: var(--accent-cyan);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .personal-cal-subtitle {
      font-size: 11px;
      color: var(--text-dim);
      margin-top: 4px;
    }

    .personal-cal-legend {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 10px;
      color: var(--text-secondary);
    }

    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }

    .personal-cal-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }

    .pcal-day {
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      min-height: 280px;
      display: flex;
      flex-direction: column;
    }

    .pcal-day-header {
      padding: 10px 12px 6px;
      font-family: 'Orbitron', sans-serif;
      font-size: 11px;
      font-weight: 700;
      color: var(--text-primary);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .pcal-day-header .pcal-today-badge {
      font-size: 8px;
      background: var(--accent-cyan);
      color: #000;
      padding: 1px 6px;
      border-radius: 3px;
      font-weight: 700;
    }

    .pcal-tasks {
      flex: 1;
      padding: 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      overflow-y: auto;
    }

    .pcal-task {
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid;
      background: rgba(255,255,255,0.03);
    }

    .pcal-task:hover {
      background: rgba(255,255,255,0.07);
      transform: translateX(2px);
    }

    .pcal-task.cat-trading { border-left-color: #00ff88; }
    .pcal-task.cat-content { border-left-color: #aa66ff; }
    .pcal-task.cat-business { border-left-color: #00d4ff; }
    .pcal-task.cat-personal { border-left-color: #ffdd44; }

    .pcal-task-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 11px;
    }

    .pcal-task-time {
      font-size: 9px;
      color: var(--text-dim);
      margin-top: 2px;
      font-family: 'JetBrains Mono', monospace;
    }

    .pcal-task.editing {
      background: rgba(0,212,255,0.08);
      box-shadow: 0 0 0 1px var(--accent-cyan);
    }

    .pcal-task-edit-input {
      width: 100%;
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-size: 11px;
      font-family: 'JetBrains Mono', monospace;
      outline: none;
      font-weight: 600;
    }

    .pcal-task-time-input {
      width: 100%;
      background: transparent;
      border: none;
      color: var(--text-dim);
      font-size: 9px;
      font-family: 'JetBrains Mono', monospace;
      outline: none;
      margin-top: 2px;
    }

    .pcal-add-btn {
      width: 100%;
      padding: 4px;
      background: transparent;
      border: 1px dashed rgba(255,255,255,0.1);
      border-radius: 4px;
      color: var(--text-dim);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: auto;
    }

    .pcal-add-btn:hover {
      border-color: var(--accent-cyan);
      color: var(--accent-cyan);
      background: rgba(0,212,255,0.05);
    }

    .personal-next-up {
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .personal-next-up .countdown-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 13px;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
    }

    .personal-next-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      font-size: 13px;
    }

    .personal-next-item:last-child { border-bottom: none; }

    .personal-next-label {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .personal-next-label .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }

    .personal-next-value {
      color: var(--text-dim);
      font-size: 12px;
      font-family: 'JetBrains Mono', monospace;
    }

    /* Category select dropdown in add modal */
    .pcal-cat-select {
      width: 100%;
      padding: 4px 6px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 10px;
      font-family: 'JetBrains Mono', monospace;
      outline: none;
      margin-top: 4px;
    }

    .pcal-cat-select option { background: #1a1a2e; }

    /* Task edit modal overlay */
    .pcal-edit-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }

    .pcal-edit-overlay.active { display: flex; }

    .pcal-edit-modal {
      background: #1a1a2e;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      width: 340px;
      max-width: 90vw;
    }

    .pcal-edit-modal h3 {
      font-family: 'Orbitron', sans-serif;
      font-size: 13px;
      color: var(--accent-cyan);
      margin-bottom: 16px;
    }

    .pcal-edit-modal label {
      display: block;
      font-size: 10px;
      color: var(--text-secondary);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .pcal-edit-modal input, .pcal-edit-modal select {
      width: 100%;
      padding: 8px 10px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 13px;
      font-family: 'JetBrains Mono', monospace;
      outline: none;
      margin-bottom: 12px;
    }

    .pcal-edit-modal input:focus, .pcal-edit-modal select:focus {
      border-color: var(--accent-cyan);
    }

    .pcal-edit-modal select option { background: #1a1a2e; }

    .pcal-edit-actions {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    .pcal-edit-actions button {
      flex: 1;
      padding: 8px;
      border-radius: 6px;
      font-family: 'Orbitron', monospace;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 1px;
      cursor: pointer;
      border: 1px solid var(--border-color);
      transition: all 0.2s;
    }

    .pcal-edit-actions .pcal-save-btn {
      background: rgba(0,255,136,0.1);
      color: var(--accent-green);
      border-color: rgba(0,255,136,0.3);
    }
    .pcal-edit-actions .pcal-save-btn:hover { background: rgba(0,255,136,0.2); }

    .pcal-edit-actions .pcal-cancel-btn {
      background: rgba(255,255,255,0.03);
      color: var(--text-secondary);
    }
    .pcal-edit-actions .pcal-cancel-btn:hover { background: rgba(255,255,255,0.08); }

    .pcal-edit-actions .pcal-delete-btn {
      background: rgba(255,68,85,0.1);
      color: var(--accent-red);
      border-color: rgba(255,68,85,0.3);
      flex: 0 0 auto;
      padding: 8px 12px;
    }
    .pcal-edit-actions .pcal-delete-btn:hover { background: rgba(255,68,85,0.2); }

    @media (max-width: 900px) {
      .personal-cal-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      .pcal-day { min-height: 200px; }
    }

    @media (max-width: 600px) {
      .personal-cal-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB 4: ORG CHART ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .org-chart {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 30px 0;
    }

    .org-node {
      background: rgba(255,255,255,0.03);
      border: 2px solid var(--border-color);
      border-radius: 14px;
      padding: 22px 28px;
      min-width: 280px;
      max-width: 360px;
      position: relative;
      transition: all 0.3s;
    }

    .org-node:hover {
      background: rgba(255,255,255,0.06);
      transform: translateY(-2px);
    }

    .org-node.purple-border { border-color: rgba(170,102,255,0.5); box-shadow: 0 0 20px rgba(170,102,255,0.1); }
    .org-node.cyan-border { border-color: rgba(0,212,255,0.5); box-shadow: 0 0 20px rgba(0,212,255,0.1); }
    .org-node.green-border { border-color: rgba(0,255,136,0.4); box-shadow: 0 0 20px rgba(0,255,136,0.08); }

    .org-node-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }

    .org-avatar {
      width: 40px; height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .org-avatar.purple { background: rgba(170,102,255,0.2); }
    .org-avatar.cyan { background: rgba(0,212,255,0.2); }
    .org-avatar.green { background: rgba(0,255,136,0.2); }

    .org-name { font-family: 'Orbitron', sans-serif; font-size: 15px; font-weight: 700; }
    .org-role { font-size: 12px; color: var(--text-secondary); }

    .org-status {
      position: absolute;
      top: 18px;
      right: 20px;
    }

    .org-model {
      font-size: 11px;
      color: var(--text-dim);
      background: rgba(255,255,255,0.05);
      padding: 3px 10px;
      border-radius: 4px;
      margin: 8px 0;
      display: inline-block;
    }

    .org-cost {
      font-size: 11px;
      color: var(--text-dim);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .org-skills {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 10px;
    }

    .skill-tag {
      font-size: 10px;
      padding: 3px 10px;
      border-radius: 4px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--text-secondary);
    }

    .org-connector {
      width: 2px;
      height: 40px;
      background: linear-gradient(to bottom, rgba(255,255,255,0.15), rgba(255,255,255,0.05));
      position: relative;
    }

    .org-connector::after {
      content: '‚ñæ';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      color: rgba(255,255,255,0.2);
      font-size: 14px;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB 5: DECRYPT LABS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .dl-section {
      margin-bottom: 32px;
    }

    .dl-section-header {
      font-family: 'Orbitron', sans-serif;
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .dl-section-desc {
      font-size: 12px;
      color: var(--text-dim);
      margin-bottom: 16px;
    }

    .bots-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
      gap: 16px;
    }

    @media (max-width: 500px) {
      .bots-grid { grid-template-columns: 1fr; }
    }

    .bot-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 22px;
      transition: all 0.2s;
    }

    .bot-card:hover {
      background: var(--bg-card-hover);
      border-color: rgba(0,255,136,0.2);
    }

    .bot-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .bot-card-avatar {
      width: 44px; height: 44px;
      border-radius: 10px;
      background: rgba(0,255,136,0.12);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      overflow: hidden;
    }

    .bot-card-name { font-family: 'Orbitron', sans-serif; font-size: 14px; font-weight: 700; }
    .bot-card-subtitle { font-size: 11px; color: var(--text-secondary); }

    .bot-card-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }

    .bot-stat {
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      padding: 12px;
    }

    .bot-stat-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
    .bot-stat-value { font-family: 'Orbitron', sans-serif; font-size: 16px; font-weight: 700; margin-top: 4px; }

    .drawdown-gauge {
      margin-bottom: 16px;
    }

    .gauge-header {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-bottom: 6px;
    }

    .gauge-label { color: var(--text-secondary); }
    .gauge-value { color: var(--text-primary); font-weight: 600; }

    .gauge-bar {
      height: 8px;
      background: rgba(255,255,255,0.06);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .gauge-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .gauge-fill.safe { background: linear-gradient(90deg, var(--accent-green), #00cc66); }
    .gauge-fill.warning { background: linear-gradient(90deg, var(--accent-orange), #ff8800); }
    .gauge-fill.danger { background: linear-gradient(90deg, var(--accent-red), #cc0033); }

    .progress-section {
      margin-bottom: 16px;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-bottom: 6px;
    }

    .progress-bar {
      height: 6px;
      background: rgba(255,255,255,0.06);
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple));
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .bot-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 12px;
      border-top: 1px solid var(--border-color);
      font-size: 11px;
      color: var(--text-dim);
    }

    .mini-chart {
      height: 40px;
      background: rgba(255,255,255,0.02);
      border-radius: 6px;
      margin-bottom: 16px;
      display: flex;
      align-items: flex-end;
      padding: 4px;
      gap: 2px;
      overflow: hidden;
    }

    .chart-bar {
      flex: 1;
      border-radius: 2px 2px 0 0;
      min-height: 2px;
      transition: height 0.3s;
    }

    .chart-bar.positive { background: rgba(0,255,136,0.4); }
    .chart-bar.negative { background: rgba(255,68,85,0.4); }

    /* Signals styles (for Decrypt Labs tab) */
    .signals-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .auto-refresh-badge {
      font-size: 11px;
      padding: 4px 12px;
      border-radius: 20px;
      background: rgba(0,255,136,0.1);
      border: 1px solid rgba(0,255,136,0.25);
      color: var(--accent-green);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pulse-dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--accent-green);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .signal-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 18px;
      margin-bottom: 12px;
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }

    .signal-card.bullish { border-left-color: var(--accent-green); }
    .signal-card.bearish { border-left-color: var(--accent-red); }
    .signal-card.neutral { border-left-color: var(--accent-orange); }

    .signal-card:hover {
      background: var(--bg-card-hover);
    }

    .signal-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .signal-trigger {
      font-size: 14px;
      font-weight: 700;
    }

    .signal-confidence {
      font-size: 11px;
      padding: 3px 10px;
      border-radius: 4px;
      font-weight: 600;
    }

    .confidence-high { background: rgba(0,255,136,0.15); color: var(--accent-green); }
    .confidence-medium { background: rgba(255,170,0,0.15); color: var(--accent-orange); }
    .confidence-low { background: rgba(255,68,85,0.15); color: var(--accent-red); }

    .signal-body {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .signal-field-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
    .signal-field-value { font-size: 13px; font-weight: 600; margin-top: 2px; }

    .signal-timestamp {
      font-size: 10px;
      color: var(--text-dim);
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border-color);
    }

    /* Project status cards */
    .project-status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 12px;
    }

    .project-status-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .project-status-icon {
      font-size: 24px;
      flex-shrink: 0;
    }

    .project-status-label {
      font-size: 11px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .project-status-value {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      margin-top: 2px;
    }

    .project-status-value a {
      color: var(--accent-cyan);
      text-decoration: none;
    }
    .project-status-value a:hover { text-decoration: underline; }

    .status-badge {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .status-badge.live { background: rgba(0,255,136,0.15); color: var(--accent-green); }
    .status-badge.pending { background: rgba(255,170,0,0.15); color: var(--accent-orange); }
    .status-badge.complete { background: rgba(0,212,255,0.15); color: var(--accent-cyan); }
    .status-badge.pre-launch { background: rgba(170,102,255,0.15); color: var(--accent-purple); }

    /* Buyback & Burn */
    .burn-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .burn-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 16px;
      text-align: center;
    }

    .burn-card-label {
      font-size: 10px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .burn-card-value {
      font-family: 'Orbitron', sans-serif;
      font-size: 20px;
      font-weight: 700;
      color: var(--accent-orange);
    }

    .burn-allocation {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .burn-alloc-pill {
      font-size: 11px;
      padding: 5px 12px;
      border-radius: 20px;
      background: rgba(255,170,0,0.1);
      border: 1px solid rgba(255,170,0,0.2);
      color: var(--accent-orange);
    }

    .burn-alloc-pill.primary {
      background: rgba(255,68,85,0.12);
      border-color: rgba(255,68,85,0.3);
      color: var(--accent-red);
      font-weight: 600;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê UTILITIES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-dim);
    }

    .empty-state .icon { font-size: 40px; margin-bottom: 12px; }
    .empty-state .message { font-size: 14px; }

    .refresh-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      font-size: 11px;
      color: var(--text-dim);
      background: rgba(10,10,18,0.9);
      padding: 6px 12px;
      border-radius: 20px;
      border: 1px solid var(--border-color);
      z-index: 50;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

    /* Smooth transitions for tab switching */
    .tab-content {
      animation: none;
    }
    .tab-content.active {
      animation: fadeIn 0.25s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Loading skeleton */
    .skeleton {
      background: linear-gradient(90deg, rgba(255,255,255,0.03) 25%, rgba(255,255,255,0.06) 50%, rgba(255,255,255,0.03) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 4px;
    }
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    /* Beta Tab Styles */
    .status-badge.review { background: rgba(255, 193, 7, 0.2); color: #ffc107; border: 1px solid rgba(255, 193, 7, 0.3); }
    .status-badge.approved { background: rgba(76, 175, 80, 0.2); color: #4caf50; border: 1px solid rgba(76, 175, 80, 0.3); }
    .status-badge.rejected { background: rgba(244, 67, 54, 0.2); color: #f44336; border: 1px solid rgba(244, 67, 54, 0.3); }
    .status-badge.live { background: rgba(0, 188, 212, 0.2); color: #00bcd4; border: 1px solid rgba(0, 188, 212, 0.3); }

    .beta-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    
    .beta-btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
      color: #ccc;
      cursor: pointer;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.2s ease;
    }
    
    .beta-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-1px);
    }

    .beta-btn.approve:hover { background: rgba(76, 175, 80, 0.2); border-color: #4caf50; color: #4caf50; }
    .beta-btn.reject:hover { background: rgba(244, 67, 54, 0.2); border-color: #f44336; color: #f44336; }
    .beta-btn.golive:hover { background: rgba(0, 188, 212, 0.2); border-color: #00bcd4; color: #00bcd4; }
    .beta-btn.rebuild:hover { background: rgba(255, 152, 0, 0.2); border-color: #ff9800; color: #ff9800; }

    .stats-pill-container {
        display: flex;
        gap: 15px;
    }
    .stats-pill {
        background: rgba(0,0,0,0.3);
        padding: 5px 10px;
        border-radius: 12px;
        font-size: 0.85rem;
        border: 1px solid rgba(255,255,255,0.05);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ACCESS CONTROL & WALLET SCANNER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .ac-stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }
    @media (max-width: 768px) {
      .ac-stats-row { grid-template-columns: repeat(2, 1fr); }
    }
    .ac-stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px 20px;
      text-align: center;
    }
    .ac-stat-value {
      font-family: 'Orbitron', sans-serif;
      font-size: 28px;
      font-weight: 700;
      background: linear-gradient(90deg, var(--accent-cyan), var(--accent-green));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .ac-stat-value.warning {
      background: linear-gradient(90deg, var(--accent-orange), var(--accent-red));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .ac-stat-label {
      font-size: 11px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 4px;
    }

    .ac-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: 20px;
    }
    .ac-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
      background: rgba(0,0,0,0.2);
    }
    .ac-card-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-family: 'Orbitron', sans-serif;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--accent-cyan);
    }
    .ac-card-body {
      padding: 20px;
    }

    .ac-table {
      width: 100%;
      border-collapse: collapse;
    }
    .ac-table th {
      text-align: left;
      padding: 12px 16px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border-color);
      background: rgba(0,0,0,0.2);
    }
    .ac-table td {
      padding: 14px 16px;
      font-size: 13px;
      border-bottom: 1px solid var(--border-color);
    }
    .ac-table tr:hover {
      background: var(--bg-card-hover);
    }

    .ac-request-type {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .ac-type-indicator { background: rgba(0,212,255,0.2); color: var(--accent-cyan); }
    .ac-type-strategy { background: rgba(170,102,255,0.2); color: var(--accent-purple); }

    .ac-tier-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
    }
    .ac-tier-bronze { background: rgba(205,127,50,0.2); color: #cd7f32; }
    .ac-tier-gold { background: rgba(255,215,0,0.2); color: #ffd700; }
    .ac-tier-diamond { background: rgba(185,242,255,0.2); color: #b9f2ff; }

    .ac-action-btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'JetBrains Mono', monospace;
    }
    .ac-action-btn.approve {
      background: var(--accent-green);
      color: var(--bg-dark);
    }
    .ac-action-btn.reject {
      background: rgba(255,68,85,0.2);
      color: var(--accent-red);
      border: 1px solid rgba(255,68,85,0.3);
    }
    .ac-action-btn:hover {
      transform: translateY(-1px);
    }

    .ac-wallet-address {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--text-secondary);
    }
    .ac-tv-username {
      color: var(--accent-cyan);
      font-weight: 600;
    }

    .ac-scan-btn {
      padding: 8px 16px;
      background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple));
      border: none;
      border-radius: 8px;
      color: var(--bg-dark);
      font-weight: 600;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'JetBrains Mono', monospace;
    }
    .ac-scan-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(0,212,255,0.3);
    }
    .ac-scan-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .ac-scanner-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
    }
    .ac-wallet-card {
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      transition: all 0.2s;
    }
    .ac-wallet-card.warning { border-color: var(--accent-orange); }
    .ac-wallet-card.danger { border-color: var(--accent-red); background: rgba(255,68,85,0.05); }
    .ac-wallet-card.healthy { border-color: var(--accent-green); }

    .ac-wallet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .ac-wallet-tv { font-weight: 600; color: var(--accent-cyan); }
    .ac-wallet-status {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
    }
    .ac-status-healthy { background: rgba(0,255,136,0.2); color: var(--accent-green); }
    .ac-status-warning { background: rgba(255,170,0,0.2); color: var(--accent-orange); }
    .ac-status-danger { background: rgba(255,68,85,0.2); color: var(--accent-red); }

    .ac-wallet-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 12px;
    }
    .ac-wallet-detail {
      display: flex;
      justify-content: space-between;
    }
    .ac-wallet-detail-label { color: var(--text-secondary); }
    .ac-wallet-detail-value { font-weight: 600; }

    .ac-wallet-actions {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 8px;
    }

    .ac-empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }
    .ac-empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê THE FOUNTAIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .ft-filter-btn {
      padding: 5px 14px;
      border: 1px solid var(--border-color);
      background: rgba(255,255,255,0.03);
      color: var(--text-secondary);
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      font-family: 'JetBrains Mono', monospace;
      transition: all 0.2s;
    }
    .ft-filter-btn:hover { background: rgba(255,255,255,0.08); color: var(--text-primary); }
    .ft-filter-btn.active { background: rgba(255,152,0,0.15); border-color: rgba(255,152,0,0.4); color: #ff9800; }

    .ft-trend-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 18px;
      transition: all 0.2s;
      border-left: 3px solid #ff9800;
    }
    .ft-trend-card:hover { background: var(--bg-card-hover); border-color: rgba(255,152,0,0.3); }

    .ft-idea-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 18px;
      transition: all 0.2s;
    }
    .ft-idea-card:hover { background: var(--bg-card-hover); }
    .ft-idea-card.status-lab { border: 1px solid rgba(255,213,79,0.4); box-shadow: 0 0 12px rgba(255,213,79,0.08); }
    .ft-idea-card.status-pipeline { border: 1px solid rgba(129,199,132,0.4); box-shadow: 0 0 12px rgba(129,199,132,0.08); }

    .ft-score-bar {
      height: 6px;
      background: rgba(255,255,255,0.06);
      border-radius: 3px;
      overflow: hidden;
      flex: 1;
    }
    .ft-score-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.4s ease;
    }

    .ft-tag {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 4px;
      background: rgba(255,152,0,0.12);
      border: 1px solid rgba(255,152,0,0.25);
      color: #ffb74d;
    }

    .ft-promote-btn {
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'JetBrains Mono', monospace;
      border: 1px solid;
    }
    .ft-promote-btn.to-lab {
      background: rgba(255,213,79,0.1);
      border-color: rgba(255,213,79,0.3);
      color: #ffd54f;
    }
    .ft-promote-btn.to-lab:hover { background: rgba(255,213,79,0.2); }
    .ft-promote-btn.to-pipeline {
      background: rgba(129,199,132,0.1);
      border-color: rgba(129,199,132,0.3);
      color: #81c784;
    }
    .ft-promote-btn.to-pipeline:hover { background: rgba(129,199,132,0.2); }

    .ft-agent-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }

    /* Bills Calendar Styles */
    .bills-calendar-section {
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      margin-top: 24px;
    }
    .bills-cal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .bills-cal-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 14px;
      font-weight: 700;
      color: var(--accent-green);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .bills-cal-subtitle { font-size: 11px; color: var(--text-dim); margin-top: 4px; }
    
    .bills-cal-controls { display: flex; align-items: center; gap: 8px; }
    .bills-nav-btn {
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      width: 28px; height: 28px;
      border-radius: 6px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 10px;
    }
    .bills-nav-btn:hover { background: rgba(255,255,255,0.1); }
    .bills-month-label {
      font-family: 'Orbitron', sans-serif;
      font-size: 13px;
      font-weight: 600;
      min-width: 120px;
      text-align: center;
    }
    .bills-today-btn {
      background: rgba(0,212,255,0.1);
      border: 1px solid rgba(0,212,255,0.3);
      color: var(--accent-cyan);
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
    }
    .bills-add-btn {
      background: rgba(0,255,136,0.1);
      border: 1px solid rgba(0,255,136,0.3);
      color: var(--accent-green);
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      margin-left: 8px;
    }
    
    .bills-cal-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: var(--border-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
    }
    .bill-day-cell {
      background: #0a0a12;
      min-height: 100px;
      padding: 8px;
      position: relative;
    }
    .bill-day-cell.other-month { opacity: 0.3; background: rgba(0,0,0,0.3); }
    .bill-day-cell.today { background: rgba(0,212,255,0.03); }
    .bill-day-num {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 6px;
      font-family: 'JetBrains Mono', monospace;
    }
    .bill-day-cell.today .bill-day-num {
      color: var(--accent-cyan);
      font-weight: 700;
      background: rgba(0,212,255,0.1);
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
    }
    
    .bill-pill {
      font-size: 9px;
      padding: 3px 6px;
      border-radius: 4px;
      margin-bottom: 4px;
      cursor: pointer;
      border-left: 2px solid;
      background: rgba(255,255,255,0.05);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: all 0.2s;
    }
    .bill-pill:hover { transform: translateX(2px); background: rgba(255,255,255,0.08); }
    .bill-pill.paid { opacity: 0.5; text-decoration: line-through; }
    
    .bills-summary-bar {
      display: flex;
      gap: 20px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
      flex-wrap: wrap;
    }
    .bill-summary-item .label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 2px; }
    .bill-summary-item .value { font-family: 'Orbitron', sans-serif; font-size: 16px; font-weight: 600; color: var(--text-primary); }
    
    .bill-color-picker { display: flex; gap: 8px; margin-bottom: 16px; }
    .bill-color-picker .color-opt {
      width: 20px; height: 20px; border-radius: 50%; cursor: pointer;
      border: 2px solid transparent;
    }
    .bill-color-picker .color-opt.active { border-color: #fff; box-shadow: 0 0 0 2px rgba(255,255,255,0.2); }
    /* Beta Tab Styles */
    .status-badge.review { background: rgba(255, 193, 7, 0.2); color: #ffc107; border: 1px solid rgba(255, 193, 7, 0.3); }
    .status-badge.approved { background: rgba(76, 175, 80, 0.2); color: #4caf50; border: 1px solid rgba(76, 175, 80, 0.3); }
    .status-badge.rejected { background: rgba(244, 67, 54, 0.2); color: #f44336; border: 1px solid rgba(244, 67, 54, 0.3); }
    .status-badge.live { background: rgba(0, 188, 212, 0.2); color: #00bcd4; border: 1px solid rgba(0, 188, 212, 0.3); }

    .beta-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    
    .beta-btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
      color: #ccc;
      cursor: pointer;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.2s ease;
    }
    
    .beta-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-1px);
    }

    .beta-btn.approve:hover { background: rgba(76, 175, 80, 0.2); border-color: #4caf50; color: #4caf50; }
    .beta-btn.reject:hover { background: rgba(244, 67, 54, 0.2); border-color: #f44336; color: #f44336; }
    .beta-btn.golive:hover { background: rgba(0, 188, 212, 0.2); border-color: #00bcd4; color: #00bcd4; }
    .beta-btn.rebuild:hover { background: rgba(255, 152, 0, 0.2); border-color: #ff9800; color: #ff9800; }

    .stats-pill-container {
        display: flex;
        gap: 15px;
    }
    .stats-pill {
        background: rgba(0,0,0,0.3);
        padding: 5px 10px;
        border-radius: 12px;
        font-size: 0.85rem;
        border: 1px solid rgba(255,255,255,0.05);
        display: flex;
        align-items: center;
        gap: 6px;
    }

  </style>
</head>
<body>

<!-- Server-side auth handles login ‚Äî no client-side gate needed -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NAVBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="app-content">
<nav class="navbar">
  <!-- PERSONAL -->
  <div class="nav-tab active" data-tab="mission-control">
    <span class="icon">‚ú¶</span>
    <span>Mission Control</span>
  </div>
  <div class="nav-tab" data-tab="tasks">
    <span class="icon">üìã</span>
    <span>Tasks</span>
  </div>
  <div class="nav-tab" data-tab="calendar">
    <span class="icon">üìÖ</span>
    <span>Calendar</span>
  </div>
  <div class="nav-tab" data-tab="ideas">
    <span class="icon">üí°</span>
    <span>Ideas</span>
  </div>

  <!-- DECRYPT LABS -->
  <div class="nav-divider">Decrypt Labs</div>
  <div class="nav-tab" data-tab="decrypt-schedule">
    <span class="icon">‚ö°</span>
    <span>Schedule</span>
  </div>
  <div class="nav-tab" data-tab="goddard">
    <span class="icon">üêï‚Äçü¶∫</span>
    <span>Goddard</span>
  </div>
  <div class="nav-tab" data-tab="org">
    <span class="icon">üë•</span>
    <span>Org</span>
  </div>
  <div class="nav-tab" data-tab="decrypt-labs">
    <span class="icon">üî¨</span>
    <span>Dashboard</span>
  </div>

  <!-- VENTURES -->
  <div class="nav-divider">Ventures</div>
  <div class="nav-tab" data-tab="fountain">
    <span class="icon">üåä</span>
    <span>The Fountain</span>
  </div>
  <div class="nav-tab" data-tab="forge">
    <span class="icon">üî®</span>
    <span>The Forge</span>
  </div>
  <div class="nav-tab" data-tab="prototype">
    <span class="icon">üöÄ</span>
    <span>Prototype</span>
  </div>
  <div class="nav-tab" data-tab="beta">
    <span class="icon">üß™</span>
    <span>Beta</span>
  </div>
  <div class="nav-spacer"></div>
  <div class="server-status" id="server-status">
    <span class="status-dot grey" id="health-dot"></span>
    <span id="health-text">Connecting...</span>
  </div>
</nav>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN CONTENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="main-content">

  <!-- ‚ïê‚ïê‚ïê TAB 1: MISSION CONTROL ‚ïê‚ïê‚ïê -->
  <div class="tab-content active" id="tab-mission-control">
    <h1 class="section-title">Mission Control</h1>
    <p class="section-subtitle">Decrypt Labs ‚Äî Automated Trading Operations</p>
    
    <!-- Blockchain Info -->
    <div class="blockchain-info" style="background: rgba(0,212,255,0.05); border: 1px solid rgba(0,212,255,0.2); border-radius: 8px; padding: 12px 16px; margin-bottom: 20px; font-size: 12px;">
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
        <span style="color: #00e5ff;">üîó</span>
        <strong style="color: #fff;">On-Chain Bots</strong>
        <span style="color: #666; font-size: 11px;">(4 NFTs minted on Base)</span>
      </div>
      <div style="color: #888; line-height: 1.4;">
        <div>Contract: 
          <a href="https://basescan.org/address/0x743EBDfcED2dBA082E282689c35D5c0E173C7728" target="_blank" style="color: #00e5ff; text-decoration: none;">
            0x743EBDfcED2dBA082E282689c35D5c0E173C7728
          </a>
        </div>
        <div style="font-size: 11px; margin-top: 4px;">
          Each bot is represented by an NFT character. Token IDs: Code Screamer(#0), Neon Stalker(#1), Rekt Reaper(#2), Signal Sage(#3)
        </div>
      </div>
    </div>

    <!-- Team -->
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px;">
      <div class="team-badge">
        <span>üëë</span>
        <span style="color:var(--accent-purple)">DropKing</span>
        <span class="role">CEO</span>
      </div>
      <div class="team-badge">
        <span>üß†</span>
        <span style="color:var(--accent-cyan)">Jimmy Neutron</span>
        <span class="role">COO</span>
      </div>
    </div>

    <div class="stats-grid" id="stats-grid">
      <div class="stat-card cyan">
        <div class="stat-label">Total AUM</div>
        <div class="stat-value" id="stat-aum">‚Äî</div>
        <div class="stat-change" id="stat-aum-change"></div>
      </div>
      <div class="stat-card green">
        <div class="stat-label">Active Bots</div>
        <div class="stat-value" id="stat-bots">‚Äî</div>
        <div class="stat-change" id="stat-bots-change">Across 4 accounts</div>
      </div>
      <div class="stat-card purple">
        <div class="stat-label">Today's P&L</div>
        <div class="stat-value" id="stat-pnl">‚Äî</div>
        <div class="stat-change" id="stat-pnl-change"></div>
      </div>
      <div class="stat-card orange">
        <div class="stat-label">Signals (24h)</div>
        <div class="stat-value" id="stat-signals">‚Äî</div>
        <div class="stat-change">ICT analysis feed</div>
      </div>
    </div>

    <div class="dashboard-grid">
      <!-- Projects Completed -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">üöÄ Projects Completed</div>
        </div>
        <div class="project-item"><span class="project-check">‚úÖ</span><span class="project-name">Decrypt Labs website (decryptlabs.io)</span></div>
        <div class="project-item"><span class="project-check">‚úÖ</span><span class="project-name">Cipher City 3D Dashboard</span></div>
        <div class="project-item"><span class="project-check">‚úÖ</span><span class="project-name">20 NFT Collection on IPFS</span></div>
        <div class="project-item"><span class="project-check">‚úÖ</span><span class="project-name">Smart Contracts on Base</span></div>
        <div class="project-item"><span class="project-check">‚úÖ</span><span class="project-name">Pitch Video (82s cinematic)</span></div>
        <div class="project-item"><span class="project-check">‚úÖ</span><span class="project-name">ICT Analysis Pipeline</span></div>
        <div class="project-item"><span class="project-check">‚úÖ</span><span class="project-name">Bot Caretaker Server</span></div>
        <div class="project-item"><span class="project-check">‚úÖ</span><span class="project-name">Mission Control Dashboard</span></div>
      </div>

      <!-- $CIPHER Launch To-Do -->
      <div class="card" style="grid-column: 1 / -1;">
        <div class="card-header">
          <div class="card-title">üöÄ $CIPHER Launch ‚Äî To Do</div>
          <span style="font-size:11px;color:var(--accent-orange);font-family:'Orbitron',sans-serif;">THIS WEEK</span>
        </div>
        <div id="launch-todo" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;"></div>
      </div>

      <!-- Upcoming Schedule -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">‚è∞ Upcoming Schedule</div>
        </div>
        <div id="upcoming-schedule"></div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê TAB 2: TASKS ‚ïê‚ïê‚ïê -->
  <div class="tab-content" id="tab-tasks">
    <h1 class="section-title">Task Board</h1>
    <p class="section-subtitle">Kanban view of active work items</p>

    <div style="display:flex;gap:12px;margin-bottom:16px;">
      <button onclick="addKanbanTask('todo')" style="background:linear-gradient(135deg,var(--accent-cyan),var(--accent-purple));color:#000;border:none;padding:8px 16px;border-radius:8px;font-weight:700;cursor:pointer;font-size:12px;font-family:'JetBrains Mono',monospace;">+ New Task</button>
    </div>

    <div class="kanban-board" id="kanban-board">
      <div class="kanban-column" data-column="todo">
        <div class="kanban-column-header">
          <div class="kanban-column-title" style="color: var(--accent-cyan);">To Do</div>
          <div class="kanban-count" id="count-todo">0</div>
        </div>
        <div class="kanban-items" id="col-todo"></div>
      </div>
      <div class="kanban-column" data-column="in-progress">
        <div class="kanban-column-header">
          <div class="kanban-column-title" style="color: var(--accent-orange);">In Progress</div>
          <div class="kanban-count" id="count-in-progress">0</div>
        </div>
        <div class="kanban-items" id="col-in-progress"></div>
      </div>
      <div class="kanban-column" data-column="done">
        <div class="kanban-column-header">
          <div class="kanban-column-title" style="color: var(--accent-green);">Done</div>
          <div class="kanban-count" id="count-done">0</div>
        </div>
        <div class="kanban-items" id="col-done"></div>
      </div>
      <div class="kanban-column" data-column="blocked">
        <div class="kanban-column-header">
          <div class="kanban-column-title" style="color: var(--accent-red);">Blocked</div>
          <div class="kanban-count" id="count-blocked">0</div>
        </div>
        <div class="kanban-items" id="col-blocked"></div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê TAB: DECRYPT SCHEDULE (Bot Macro Calendar) ‚ïê‚ïê‚ïê -->
  <div class="tab-content" id="tab-decrypt-schedule">
    <div class="calendar-header">
      <div>
        <h1 class="section-title">Scheduled Tasks</h1>
        <p class="section-subtitle">Jimmy's automated routines</p>
      </div>
      <div class="calendar-controls">
        <button class="cal-btn active">Week</button>
        <button class="cal-btn">Today</button>
        <button class="cal-btn" onclick="location.reload()">‚Üª</button>
      </div>
    </div>

    <div class="always-running">
      <div class="always-running-label">
        ‚ö° Always Running (Background Automation)
      </div>
      <div class="always-running-pills">
        <span class="cron-pill">üì° ICT Signal Compiler (Cindy) ‚Ä¢ 5 AM‚Äì12 PM, Mon‚ÄìFri</span>
        <span class="cron-pill">üê¶ X Post Pipeline (Jimmy) ‚Ä¢ 5 AM‚Äì12 PM, Mon‚ÄìFri</span>
        <span class="cron-pill">üìä Balance Scrape (Jimmy) ‚Ä¢ 12:30 PM PT</span>
        <span class="cron-pill">üìà EOD Performance (Discord) ‚Ä¢ 1 PM PT, Mon‚ÄìFri</span>
        <span class="cron-pill">‚òÄÔ∏è Premarket Analysis (Jimmy) ‚Ä¢ 5:30 AM PT, Mon‚ÄìFri</span>
        <span class="cron-pill">üìä Mid-Session Analysis (Jimmy) ‚Ä¢ 9:30 AM PT, Mon‚ÄìFri</span>
        <span class="cron-pill">üîÑ Health Check ‚Ä¢ Every heartbeat</span>
        <span class="cron-pill">üì• Webhook Listeners ‚Ä¢ 24/7 (Caretaker)</span>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PIPELINE STATUS BOARD ‚ïê‚ïê‚ïê -->
    <div style="margin-bottom:24px;">
      <div class="always-running-label" style="color:var(--accent-purple);margin-bottom:12px;">
        üîó ICT Signal ‚Üí X Post Pipeline
      </div>

      <!-- Pipeline Flow Visual -->
      <div id="pipeline-board" style="display:flex;flex-direction:column;gap:0;">

        <!-- Step 1: TradingView Alert -->
        <div class="pipeline-step" data-step="1">
          <div class="pipeline-node" style="border-color:rgba(0,212,255,0.4);">
            <div class="pipeline-header">
              <div class="pipeline-icon" style="background:rgba(0,212,255,0.15);color:var(--accent-cyan);">üì°</div>
              <div style="flex:1;">
                <div class="pipeline-title">‚ë† TradingView Alert</div>
                <div class="pipeline-agent">Source: ICT Smart Entry Indicator</div>
              </div>
              <div class="pipeline-status" id="pipe-step1-status"><span class="status-dot green"></span> Listening</div>
            </div>
            <div class="pipeline-detail">TradingView fires ICT Smart Entry alert ‚Üí <code>/webhook/ict-analysis</code></div>
            <div class="pipeline-meta">
              <span>Endpoint: <code style="color:var(--accent-green);">/webhook/ict-analysis</code></span>
              <span id="pipe-step1-last">Last signal: <span id="pipe-last-signal-time">‚Äî</span></span>
            </div>
          </div>
          <div class="pipeline-arrow">‚ñº</div>
        </div>

        <!-- Step 2: Caretaker Stores -->
        <div class="pipeline-step" data-step="2">
          <div class="pipeline-node" style="border-color:rgba(0,255,136,0.4);">
            <div class="pipeline-header">
              <div class="pipeline-icon" style="background:rgba(0,255,136,0.15);color:var(--accent-green);">üóÑÔ∏è</div>
              <div style="flex:1;">
                <div class="pipeline-title">‚ë° Caretaker Stores Signal</div>
                <div class="pipeline-agent">Service: Railway API Server</div>
              </div>
              <div class="pipeline-status" id="pipe-step2-status"><span class="status-dot green"></span> Online</div>
            </div>
            <div class="pipeline-detail">Signal stored in logs ‚Üí available at <code>/api/signals/ict</code></div>
            <div class="pipeline-meta">
              <span>API: <code style="color:var(--accent-green);">/api/signals/ict</code></span>
              <span id="pipe-step2-count">Signals stored: <span id="pipe-signal-count">‚Äî</span></span>
            </div>
          </div>
          <div class="pipeline-arrow">‚ñº</div>
        </div>

        <!-- Step 3: Cindy Compiles -->
        <div class="pipeline-step" data-step="3">
          <div class="pipeline-node" style="border-color:rgba(255,170,0,0.4);">
            <div class="pipeline-header">
              <div class="pipeline-icon" style="background:rgba(255,170,0,0.15);color:var(--accent-orange);">‚ö°</div>
              <div style="flex:1;">
                <div class="pipeline-title">‚ë¢ Cindy Compiles Signal</div>
                <div class="pipeline-agent">Agent: Cindy Vortex (DeepSeek) ‚Ä¢ Cron: Every 5 min</div>
              </div>
              <div class="pipeline-status" id="pipe-step3-status"><span class="status-dot green"></span> Running</div>
            </div>
            <div class="pipeline-detail">Pulls <code>/api/signals/ict</code> ‚Üí compiles & logs ‚Üí if conviction ‚â• 60%: captures TradingView chart screenshot ‚Üí writes <code>pending-tweet-signal.json</code> + <code>pending-chart.jpg</code></div>
            <div class="pipeline-meta">
              <span>Filter: Conviction ‚â• 60% + trigger = CONVICTION_CROSSED or PRE_MARKET</span>
              <span>Screenshot: <code style="color:var(--accent-cyan);">pending-chart.jpg</code></span>
              <span>Output: <code style="color:var(--accent-yellow);">pending-tweet-signal.json</code></span>
            </div>
          </div>
          <div class="pipeline-arrow">‚ñº</div>
        </div>

        <!-- Step 4: Sheen Posts to X -->
        <div class="pipeline-step" data-step="4">
          <div class="pipeline-node" style="border-color:rgba(0,255,136,0.4);">
            <div class="pipeline-header">
              <div class="pipeline-icon" style="background:rgba(170,102,255,0.15);color:var(--accent-purple);">üöÄ</div>
              <div style="flex:1;">
                <div class="pipeline-title">‚ë£ Jimmy Posts to X + Discord</div>
                <div class="pipeline-agent">Agent: Jimmy Neutron (Opus) ‚Ä¢ Cron: Every 5 min</div>
              </div>
              <div class="pipeline-status" id="pipe-step4-status"><span class="status-dot green"></span> Running</div>
            </div>
            <div class="pipeline-detail">Reads pending signal + chart image ‚Üí formats engaging tweet ‚Üí attaches chart screenshot ‚Üí posts to <a href="https://x.com/PriceCipherHQ" target="_blank" style="color:var(--accent-cyan);text-decoration:none;">@Decrypt_Labs</a> ‚Üí mirrors to Discord <code>#twitter-feed</code></div>
            <div class="pipeline-meta">
              <span>X: @Decrypt_Labs (with chart image)</span>
              <span>Discord: #twitter-feed (1466796654073217247)</span>
              <span>Sign-off: "‚Äî Jimmy üß™"</span>
            </div>
          </div>
          <div class="pipeline-arrow">‚ñº</div>
        </div>

        <!-- Step 5: Dashboard Feed -->
        <div class="pipeline-step" data-step="5">
          <div class="pipeline-node" style="border-color:rgba(170,102,255,0.4);">
            <div class="pipeline-header">
              <div class="pipeline-icon" style="background:rgba(170,102,255,0.15);color:var(--accent-purple);">üìä</div>
              <div style="flex:1;">
                <div class="pipeline-title">‚ë§ Dashboard ICT Feed</div>
                <div class="pipeline-agent">Auto-populated from /api/signals/ict</div>
              </div>
              <div class="pipeline-status" id="pipe-step5-status"><span class="status-dot green"></span> Live</div>
            </div>
            <div class="pipeline-detail">Signal appears on Mission Control ICT Feed tab automatically</div>
            <div class="pipeline-meta">
              <span>View: Mission Control ‚Üí ICT Feed tab</span>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Live Signal Monitor -->
    <div class="signal-monitor-grid">
      <!-- Left: Latest Signal -->
      <div class="monitor-card" id="mon-signal-card">
        <div class="monitor-header">
          <div class="monitor-title">üì° Latest Compiled Signal</div>
          <div id="mon-live-timer" style="font-size:11px;color:var(--text-dim);">waiting...</div>
        </div>
        
        <div id="mon-signal-content" style="display:none;">
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:20px;">
             <div>
               <div id="mon-model" style="font-size:20px;font-weight:700;color:var(--text-primary);">‚Äî</div>
               <div id="mon-trigger" style="font-size:12px;color:var(--accent-purple);margin-top:4px;">‚Äî</div>
             </div>
             <div id="mon-badge" class="signal-badge-large">Waiting</div>
          </div>

          <div class="monitor-data-grid">
            <div>
              <div class="data-item-label">Entry</div>
              <div class="data-item-value" id="mon-entry">‚Äî</div>
            </div>
            <div>
              <div class="data-item-label">Target (DOL)</div>
              <div class="data-item-value" id="mon-target">‚Äî</div>
            </div>
            <div>
              <div class="data-item-label">Session</div>
              <div class="data-item-value" id="mon-session">‚Äî</div>
            </div>
            <div>
              <div class="data-item-label">Key Level</div>
              <div class="data-item-value" id="mon-level">‚Äî</div>
            </div>
          </div>

          <div style="margin-bottom:20px;">
            <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
              <div class="data-item-label">Conviction Score</div>
              <div class="data-item-value" id="mon-score-val">0%</div>
            </div>
            <div class="confidence-bar-bg">
              <div class="confidence-bar-fill" id="mon-score-bar"></div>
            </div>
          </div>

          <div style="margin-top:auto;">
             <div class="data-item-label">Narrative</div>
             <div id="mon-narrative" style="font-size:13px;color:var(--text-secondary);font-style:italic;line-height:1.4;">‚Äî</div>
          </div>
        </div>

        <div id="mon-signal-empty" style="text-align:center;padding:40px;color:var(--text-dim);">
           <div style="font-size:40px;margin-bottom:10px;opacity:0.3;">üì°</div>
           Waiting for signal stream...
        </div>
      </div>

      <!-- Right: X Preview -->
      <div class="monitor-card" id="mon-preview-card">
        <div class="monitor-header">
          <div class="monitor-title">X Post Preview</div>
          <div id="mon-x-status" style="font-size:11px;font-weight:600;color:var(--text-dim);">WAITING</div>
        </div>

        <div class="x-preview-box" id="mon-tweet-text">‚è≥ Waiting for qualifying signal (Conviction ‚â• 60%)...</div>
        
        <div style="margin-top:auto;">
          <button class="x-btn" id="mon-post-btn" disabled>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
            Post to X
          </button>
          <div style="text-align:center;margin-top:8px;font-size:10px;color:var(--text-dim);">
            Auto-posts enabled via Sheen
          </div>
        </div>
      </div>
    </div>

    <div class="calendar-grid" id="calendar-grid"></div>

    <div class="countdown-section">
      <div class="countdown-title">‚è± Next Up</div>
      <div id="countdown-list"></div>
    </div>

  </div>

  <!-- ‚ïê‚ïê‚ïê TAB: GODDARD (CRO) ‚ïê‚ïê‚ïê -->
  <div class="tab-content" id="tab-goddard">
    <h1 class="section-title" style="text-align:center;">üêï‚Äçü¶∫ Goddard ‚Äî Chief Risk Officer</h1>
    <p class="section-subtitle" style="text-align:center;">Bot control ‚Ä¢ Forex Factory news ‚Ä¢ Risk management ‚Ä¢ Drawdown guardian</p>

    <!-- Risk Status Overview -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;margin:24px auto;max-width:900px;">
      <div style="background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;padding:18px;text-align:center;">
        <div style="color:var(--text-dim);font-size:11px;text-transform:uppercase;letter-spacing:1px;">Risk Level</div>
        <div id="gd-risk-badge" style="font-size:22px;font-weight:700;margin-top:6px;color:var(--accent-green);">LOADING...</div>
      </div>
      <div style="background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;padding:18px;text-align:center;">
        <div style="color:var(--text-dim);font-size:11px;text-transform:uppercase;letter-spacing:1px;">Total AUM</div>
        <div id="gd-aum" style="font-size:22px;font-weight:700;margin-top:6px;color:var(--accent-cyan);font-family:'SF Mono',monospace;">‚Äî</div>
      </div>
      <div style="background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;padding:18px;text-align:center;">
        <div style="color:var(--text-dim);font-size:11px;text-transform:uppercase;letter-spacing:1px;">Weekly P&L</div>
        <div id="gd-weekly-pnl" style="font-size:22px;font-weight:700;margin-top:6px;font-family:'SF Mono',monospace;">‚Äî</div>
      </div>
      <div style="background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;padding:18px;text-align:center;">
        <div style="color:var(--text-dim);font-size:11px;text-transform:uppercase;letter-spacing:1px;">Week Started</div>
        <div id="gd-week-start" style="font-size:16px;font-weight:600;margin-top:8px;color:var(--text-secondary);">‚Äî</div>
      </div>
    </div>

    <!-- Bot Status Cards -->
    <div style="max-width:900px;margin:24px auto;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <h2 style="font-size:16px;color:var(--text-primary);">üéõÔ∏è Bot Status & Risk</h2>
        <span style="font-size:11px;color:var(--text-dim);">Managed by Goddard</span>
      </div>
      <div id="gd-bot-cards" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
      </div>
    </div>

    <!-- ICT Live News Feed -->
    <div style="max-width:900px;margin:28px auto;">
      <details open>
        <summary style="font-size:16px;font-weight:600;color:var(--text-primary);cursor:pointer;padding:8px 0;border-bottom:1px solid var(--border-color);user-select:none;">
          üì∞ ICT Live News ‚Äî Goddard's Analysis
          <span style="font-size:11px;color:var(--text-dim);margin-left:8px;">Forex Factory through ICT lens</span>
        </summary>
        <div id="gd-news-feed" style="max-height:400px;overflow-y:auto;padding:12px 0;">
          <div style="color:var(--text-dim);font-size:13px;font-style:italic;padding:20px;text-align:center;">Loading news feed...</div>
        </div>
      </details>
    </div>

    <!-- Bot Decision Log -->
    <div style="max-width:900px;margin:28px auto;">
      <details>
        <summary style="font-size:16px;font-weight:600;color:var(--text-primary);cursor:pointer;padding:8px 0;border-bottom:1px solid var(--border-color);user-select:none;">
          üß† Bot Decision Log
          <span style="font-size:11px;color:var(--text-dim);margin-left:8px;">On/off decisions & reasoning</span>
        </summary>
        <div id="gd-action-log" style="max-height:400px;overflow-y:auto;padding:12px 0;font-family:'SF Mono',monospace;font-size:12px;">
          <div style="color:var(--text-dim);font-style:italic;padding:20px;text-align:center;">Loading decision log...</div>
        </div>
      </details>
    </div>

    <!-- Editable Risk Rules -->
    <div style="max-width:900px;margin:28px auto;">
      <details>
        <summary style="font-size:16px;font-weight:600;color:var(--text-primary);cursor:pointer;padding:8px 0;border-bottom:1px solid var(--border-color);user-select:none;">
          ‚öôÔ∏è Risk Rules
          <span style="font-size:11px;color:var(--text-dim);margin-left:8px;">Edit to update Goddard directly</span>
        </summary>
        <div style="padding:12px 0;">
          <textarea id="gd-risk-rules" style="width:100%;min-height:500px;background:rgba(0,0,0,0.3);border:1px solid var(--border-color);border-radius:10px;padding:16px;color:var(--text-primary);font-family:'SF Mono',monospace;font-size:12px;line-height:1.6;resize:vertical;" placeholder="Loading risk rules..."></textarea>
          <div style="display:flex;gap:10px;margin-top:10px;justify-content:flex-end;">
            <button onclick="loadGoddardRiskRules()" style="background:rgba(255,255,255,0.06);border:1px solid var(--border-color);color:var(--text-secondary);padding:8px 16px;border-radius:8px;cursor:pointer;font-size:12px;">‚Üª Reset</button>
            <button onclick="saveGoddardRiskRules()" style="background:rgba(0,212,255,0.15);border:1px solid rgba(0,212,255,0.3);color:var(--accent-cyan);padding:8px 20px;border-radius:8px;cursor:pointer;font-weight:600;font-size:12px;">üíæ Save Rules</button>
          </div>
        </div>
      </details>
    </div>

    <!-- Editable Cron Schedule -->
    <div style="max-width:900px;margin:28px auto;">
      <details>
        <summary style="font-size:16px;font-weight:600;color:var(--text-primary);cursor:pointer;padding:8px 0;border-bottom:1px solid var(--border-color);user-select:none;">
          ‚è∞ Cron Schedule
          <span style="font-size:11px;color:var(--text-dim);margin-left:8px;">Edit Goddard's automated check times</span>
        </summary>
        <div id="gd-cron-schedule" style="padding:12px 0;">
        </div>
      </details>
    </div>

    <!-- Last Updated -->
    <div style="max-width:900px;margin:20px auto;text-align:center;">
      <span id="gd-last-updated" style="font-size:11px;color:var(--text-dim);">‚Äî</span>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê TAB 4: ORG CHART ‚ïê‚ïê‚ïê -->
  <div class="tab-content" id="tab-org">
    <h1 class="section-title" style="text-align:center;">Organization</h1>
    <p class="section-subtitle" style="text-align:center;">Chain of command. DropKing sets the vision, Jimmy drives strategy, agents execute.</p>

    <div class="org-chart">
      <!-- CEO -->
      <div class="org-node purple-border">
        <div class="org-status"><span class="status-dot green"></span></div>
        <div class="org-node-header">
          <div class="org-avatar purple">üëë</div>
          <div>
            <div class="org-name">DropKing</div>
            <div class="org-role">Chief Executive Officer ‚Ä¢ Founder</div>
          </div>
        </div>
        <div class="org-skills">
          <span class="skill-tag">Vision & Direction</span>
          <span class="skill-tag">Capital Allocation</span>
          <span class="skill-tag">Final Decisions</span>
          <span class="skill-tag">Business Development</span>
        </div>
      </div>

      <div class="org-connector"></div>

      <!-- CSO -->
      <div class="org-node cyan-border">
        <div class="org-status"><span class="status-dot green"></span></div>
        <div class="org-node-header">
          <div class="org-avatar cyan">üß™</div>
          <div>
            <div class="org-name">Jimmy Neutron</div>
            <div class="org-role">Chief Strategy Officer</div>
          </div>
        </div>
        <div class="org-model">Claude Opus 4.6 ‚Ä¢ OpenClaw</div>
        <div class="org-cost">‚Üó ~$5/$25 per 1M tokens</div>
        <div class="org-skills">
          <span class="skill-tag">Strategy & Planning</span>
          <span class="skill-tag">Market Analysis</span>
          <span class="skill-tag">Agent Orchestration</span>
          <span class="skill-tag">Content Direction</span>
          <span class="skill-tag">Bot Oversight</span>
        </div>
      </div>

      <div class="org-connector"></div>

      <!-- Agent Team -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;width:100%;max-width:1200px;">
        <!-- Cindy Vortex ‚Äî ACTIVE -->
        <div class="org-node" style="border-color:rgba(255,170,0,0.4);">
          <div class="org-status"><span class="status-dot green"></span> Online</div>
          <div class="org-node-header">
            <div class="org-avatar" style="background:rgba(255,170,0,0.15);color:#ffaa00;">‚ö°</div>
            <div>
              <div class="org-name">Cindy Vortex</div>
              <div class="org-role">Operations Analyst</div>
            </div>
          </div>
          <div class="org-model">DeepSeek V3 + Gemini Flash ‚Ä¢ OpenClaw</div>
          <div class="org-cost">‚Üó ~$0.27/$1.10 per 1M tokens</div>
          <div class="org-skills">
            <span class="skill-tag">Balance Scraping</span>
            <span class="skill-tag">ICT Signal Compilation</span>
            <span class="skill-tag">Data Scraping</span>
            <span class="skill-tag">Discord Updates</span>
            <span class="skill-tag">Data Ops</span>
          </div>
        </div>

        <!-- Carl Wheezer ‚Äî ACTIVE -->
        <div class="org-node" style="border-color:rgba(0,212,255,0.4);">
          <div class="org-status"><span class="status-dot green"></span> Online</div>
          <div class="org-node-header">
            <div class="org-avatar" style="background:rgba(0,212,255,0.15);color:#00d4ff;">ü§ì</div>
            <div>
              <div class="org-name">Carl Wheezer</div>
              <div class="org-role">Lead Engineer</div>
            </div>
          </div>
          <div class="org-model">Gemini 3 Pro Preview ‚Ä¢ OpenClaw</div>
          <div class="org-cost">‚Üó ~$3/$15 per 1M tokens</div>
          <div class="org-skills">
            <span class="skill-tag">Frontend</span>
            <span class="skill-tag">Backend</span>
            <span class="skill-tag">Smart Contracts</span>
            <span class="skill-tag">Dashboards</span>
            <span class="skill-tag">DevOps</span>
          </div>
        </div>

        <!-- Goddard ‚Äî CRO -->
        <div class="org-node" style="border-color:rgba(255,68,68,0.4);">
          <div class="org-status"><span class="status-dot green"></span> Online</div>
          <div class="org-node-header">
            <div class="org-avatar" style="background:rgba(255,68,68,0.15);color:#ff4444;">üêï‚Äçü¶∫</div>
            <div>
              <div class="org-name">Goddard</div>
              <div class="org-role">Chief Risk Officer</div>
            </div>
          </div>
          <div class="org-model">Claude Opus 4.6 ‚Ä¢ OpenClaw</div>
          <div class="org-cost">‚Üó ~$5/$25 per 1M tokens</div>
          <div class="org-skills">
            <span class="skill-tag">Bot On/Off Control</span>
            <span class="skill-tag">Forex Factory News</span>
            <span class="skill-tag">Risk Management</span>
            <span class="skill-tag">Drawdown Guardian</span>
          </div>
        </div>

        <!-- Sheen Estevez ‚Äî ACTIVE -->
        <div class="org-node" style="border-color:rgba(0,255,136,0.4);">
          <div class="org-status"><span class="status-dot green"></span> Online</div>
          <div class="org-node-header">
            <div class="org-avatar" style="background:rgba(0,255,136,0.15);color:#00ff88;">üöÄ</div>
            <div>
              <div class="org-name">Sheen Estevez</div>
              <div class="org-role">Research + Content</div>
            </div>
          </div>
          <div class="org-model">Gemini 3 Pro Preview ‚Ä¢ OpenClaw</div>
          <div class="org-cost">‚Üó Free (Google subscription)</div>
          <div class="org-skills">
            <span class="skill-tag">X Posts (@Decrypt_Labs)</span>
            <span class="skill-tag">Discord Tweet Feed</span>
            <span class="skill-tag">Market Research</span>
            <span class="skill-tag">Backtesting</span>
            <span class="skill-tag">Competitor Intel</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Org Description -->
    <div style="max-width:800px;margin:40px auto 0;text-align:center;">
      <p style="color:var(--text-dim);font-size:13px;line-height:1.7;">
        <strong style="color:var(--text-secondary);">AI-native organization.</strong> 
        DropKing (CEO) sets the vision and makes final calls. Jimmy Neutron (CSO) drives strategy and orchestrates the team.
        Goddard (CRO) guards the capital ‚Äî controls bot on/off via TradingView, analyzes Forex Factory through an ICT lens, and enforces weekly risk rules on Opus 4.6.
        Cindy Vortex (Ops) handles ICT signal compilation, data ops, and Discord updates on DeepSeek V3.
        Carl Wheezer (Engineering) builds and maintains all code, dashboards, and contracts on Gemini 3 Pro Preview.
        Sheen Estevez (Research + Content) crafts X posts for @Decrypt_Labs, mirrors tweets to Discord, and researches markets on Gemini 3 Pro.
        The system runs 24/5 with human oversight on key decisions. All agent slots filled ‚Äî team is complete.
      </p>
    </div>

    <!-- ‚ïê‚ïê‚ïê MEETING ROOM ‚ïê‚ïê‚ïê -->
    <div style="max-width:900px;margin:48px auto 0;width:100%;">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;justify-content:center;">
        <svg width="28" height="28" viewBox="0 0 28 28" fill="none"><rect x="2" y="6" width="24" height="16" rx="3" stroke="var(--accent-cyan)" stroke-width="1.5"/><path d="M8 14h12M8 10h8M8 18h6" stroke="var(--accent-cyan)" stroke-width="1.5" stroke-linecap="round" opacity="0.6"/><circle cx="22" cy="6" r="3" fill="#00ff88" stroke="var(--bg-primary)" stroke-width="1"/></svg>
        <h2 style="font-family:'Orbitron',sans-serif;font-size:1.3rem;color:var(--accent-cyan);letter-spacing:2px;margin:0;">MEETING ROOM</h2>
        <span id="mr-online-count" style="background:rgba(0,255,136,0.15);color:#00ff88;font-size:11px;font-weight:700;padding:3px 10px;border-radius:10px;">6 ONLINE</span>
      </div>
      <p style="text-align:center;color:var(--text-dim);font-size:12px;margin-bottom:16px;">Bounce ideas with the whole team. Everyone's invited.</p>

      <!-- Meeting Room Container -->
      <div id="meeting-room" style="background:rgba(0,0,0,0.3);border:1px solid var(--border-color);border-radius:16px;overflow:hidden;">
        <!-- Participants Bar -->
        <div style="display:flex;align-items:center;gap:8px;padding:12px 20px;background:rgba(255,255,255,0.02);border-bottom:1px solid var(--border-color);flex-wrap:wrap;">
          <div class="mr-participant" data-agent="dropking" title="DropKing"><div style="width:32px;height:32px;border-radius:8px;background:rgba(170,102,255,0.2);display:flex;align-items:center;justify-content:center;font-size:16px;border:2px solid rgba(170,102,255,0.4);">üëë</div><div style="font-size:9px;color:var(--text-dim);text-align:center;margin-top:2px;">DropKing</div></div>
          <div class="mr-participant" data-agent="jimmy" title="Jimmy"><div style="width:32px;height:32px;border-radius:8px;background:rgba(0,229,255,0.2);display:flex;align-items:center;justify-content:center;font-size:16px;border:2px solid rgba(0,229,255,0.4);">üß™</div><div style="font-size:9px;color:var(--text-dim);text-align:center;margin-top:2px;">Jimmy</div></div>
          <div class="mr-participant" data-agent="goddard" title="Goddard"><div style="width:32px;height:32px;border-radius:8px;background:rgba(255,68,68,0.2);display:flex;align-items:center;justify-content:center;font-size:16px;border:2px solid rgba(255,68,68,0.4);">üêï‚Äçü¶∫</div><div style="font-size:9px;color:var(--text-dim);text-align:center;margin-top:2px;">Goddard</div></div>
          <div class="mr-participant" data-agent="cindy" title="Cindy"><div style="width:32px;height:32px;border-radius:8px;background:rgba(255,170,0,0.2);display:flex;align-items:center;justify-content:center;font-size:16px;border:2px solid rgba(255,170,0,0.4);">‚ö°</div><div style="font-size:9px;color:var(--text-dim);text-align:center;margin-top:2px;">Cindy</div></div>
          <div class="mr-participant" data-agent="carl" title="Carl"><div style="width:32px;height:32px;border-radius:8px;background:rgba(0,212,255,0.2);display:flex;align-items:center;justify-content:center;font-size:16px;border:2px solid rgba(0,212,255,0.4);">ü§ì</div><div style="font-size:9px;color:var(--text-dim);text-align:center;margin-top:2px;">Carl</div></div>
          <div class="mr-participant" data-agent="sheen" title="Sheen"><div style="width:32px;height:32px;border-radius:8px;background:rgba(0,255,136,0.2);display:flex;align-items:center;justify-content:center;font-size:16px;border:2px solid rgba(0,255,136,0.4);">üöÄ</div><div style="font-size:9px;color:var(--text-dim);text-align:center;margin-top:2px;">Sheen</div></div>
        </div>

        <!-- Chat Messages -->
        <div id="mr-messages" style="height:400px;overflow-y:auto;padding:16px 20px;display:flex;flex-direction:column;gap:12px;">
          <!-- Messages populated by JS -->
        </div>

        <!-- Input Area -->
        <div style="padding:12px 16px;border-top:1px solid var(--border-color);display:flex;gap:10px;align-items:center;background:rgba(255,255,255,0.02);">
          <select id="mr-sender" style="background:rgba(255,255,255,0.05);border:1px solid var(--border-color);border-radius:8px;padding:8px 12px;color:var(--text-primary);font-size:12px;font-family:inherit;">
            <option value="dropking">üëë DropKing</option>
            <option value="jimmy">üß™ Jimmy</option>
            <option value="goddard">üêï‚Äçü¶∫ Goddard</option>
            <option value="cindy">‚ö° Cindy</option>
            <option value="carl">ü§ì Carl</option>
            <option value="sheen">üöÄ Sheen</option>
          </select>
          <input id="mr-input" type="text" placeholder="Type a message..." style="flex:1;background:rgba(255,255,255,0.05);border:1px solid var(--border-color);border-radius:10px;padding:10px 16px;color:var(--text-primary);font-size:13px;font-family:inherit;outline:none;" onkeydown="if(event.key==='Enter')sendMeetingMsg()"/>
          <button onclick="sendMeetingMsg()" style="background:linear-gradient(135deg,var(--accent-cyan),var(--accent-purple));border:none;border-radius:10px;padding:10px 20px;color:#fff;font-weight:700;font-size:12px;cursor:pointer;letter-spacing:1px;text-transform:uppercase;white-space:nowrap;">Send</button>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê THE LOUNGE ‚ïê‚ïê‚ïê -->
    <div style="margin-top:40px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <h2 style="font-size:20px;font-weight:800;background:linear-gradient(135deg,#ff6b35,#ffaa00);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin:0;">üõãÔ∏è The Lounge</h2>
        <div style="display:flex;gap:8px;align-items:center;">
          <span id="lounge-status" style="background:rgba(255,170,0,0.15);color:#ffaa00;font-size:11px;font-weight:700;padding:3px 10px;border-radius:10px;">AGENTS ONLY</span>
          <button onclick="clearLounge()" style="background:rgba(255,68,68,0.1);border:1px solid rgba(255,68,68,0.3);border-radius:8px;padding:4px 12px;color:#ff4444;font-size:10px;cursor:pointer;font-weight:600;">Clear</button>
        </div>
      </div>
      <p style="text-align:center;color:var(--text-dim);font-size:12px;margin-bottom:16px;">Agents brainstorm overnight. Review their ideas when you wake up. ‚òï</p>

      <!-- Lounge Container -->
      <div id="lounge-room" style="background:rgba(0,0,0,0.3);border:1px solid rgba(255,170,0,0.2);border-radius:16px;overflow:hidden;">
        <!-- Ideas Summary Bar -->
        <div style="display:flex;align-items:center;gap:12px;padding:12px 20px;background:rgba(255,170,0,0.03);border-bottom:1px solid rgba(255,170,0,0.15);flex-wrap:wrap;">
          <div style="font-size:12px;color:var(--text-dim);">üí° <span id="lounge-idea-count" style="color:#ffaa00;font-weight:700;">0</span> ideas</div>
          <div style="font-size:12px;color:var(--text-dim);">üí¨ <span id="lounge-msg-count" style="color:#ffaa00;font-weight:700;">0</span> messages</div>
          <div style="font-size:12px;color:var(--text-dim);margin-left:auto;">Last session: <span id="lounge-last-session" style="color:var(--text-secondary);">‚Äî</span></div>
        </div>

        <!-- Lounge Messages -->
        <div id="lounge-messages" style="height:500px;overflow-y:auto;padding:16px 20px;display:flex;flex-direction:column;gap:12px;">
          <!-- Messages populated by JS -->
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê TAB 5: DECRYPT LABS ‚ïê‚ïê‚ïê -->
  <div class="tab-content" id="tab-decrypt-labs">
    <h1 class="section-title">Decrypt Labs</h1>
    <p class="section-subtitle">$CIPHER Project ‚Äî Everything in one place</p>

    <!-- Section: Bot Performance -->
    <div class="dl-section">
      <div class="dl-section-header">
        <span>ü§ñ</span> Bot Performance
      </div>
      <div class="dl-section-desc">Live trading bot metrics ‚Äî fetched from /api/accounts</div>
      <div class="bots-grid" id="bots-grid">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- Section: My NFTs (Holder Dashboard) -->
    <div class="dl-section">
      <div class="dl-section-header">
        <span>üíé</span> My NFTs (Holder View)
      </div>
      <div class="dl-section-desc">Connect wallet to view your Cipher Bot performance</div>
      
      <div id="holder-connect-box" style="background:var(--bg-card);padding:24px;border-radius:12px;border:1px dashed var(--border-color);text-align:center;">
        <div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px;">Connect to view your assets</div>
        <button onclick="simulateConnect()" style="background:linear-gradient(90deg,var(--accent-cyan),var(--accent-purple));color:#fff;border:none;padding:8px 20px;border-radius:6px;font-weight:700;cursor:pointer;">Connect Wallet</button>
      </div>

      <div id="holder-view" style="display:none;margin-top:16px;">
        <div class="bots-grid">
           <!-- Simulated Minted NFT -->
           <div class="bot-card" style="border-color:var(--accent-cyan);">
             <div class="bot-card-header">
               <div class="bot-card-avatar" style="background:rgba(0,212,255,0.2);color:#00e5ff;">üëæ</div>
               <div>
                 <div class="bot-card-name">Code Screamer #13</div>
                 <div class="bot-card-subtitle">Minted ‚Ä¢ Active</div>
               </div>
             </div>
             <div class="bot-stat" style="margin-bottom:12px;">
               <div class="bot-stat-label">Assigned Strategy</div>
               <div class="bot-stat-value" style="font-size:13px;color:var(--accent-cyan);">FVG+IFVG Scalper</div>
             </div>
             <div class="bot-card-stats">
               <div class="bot-stat">
                 <div class="bot-stat-label">Total PnL</div>
                 <div class="bot-stat-value" style="color:var(--accent-green);">+$2,419.30</div>
               </div>
               <div class="bot-stat">
                 <div class="bot-stat-label">Share</div>
                 <div class="bot-stat-value">0.05%</div>
               </div>
             </div>
             <div style="font-size:11px;color:var(--text-dim);text-align:center;">
               <a href="#" style="color:var(--text-secondary);">View on Opensea ‚Üó</a>
             </div>
           </div>
        </div>
      </div>

      <script>
        function simulateConnect() {
          document.getElementById('holder-connect-box').style.display = 'none';
          document.getElementById('holder-view').style.display = 'block';
        }
        // --- PROTOTYPE LOGIC ---
    async function loadPrototypeBuilds() {
      const container = document.getElementById('prototype-builds-grid');
      const statsContainer = document.getElementById('prototype-stats');
      container.innerHTML = '<div class="loading">Loading Prototype Lab...</div>';

      try {
        const res = await fetch('/api/fountain/builds');
        if (!res.ok) throw new Error('Failed to load builds');
        const allBuilds = await res.json();
        
        // Filter: only 'prototype' status
        const builds = allBuilds.filter(b => b.status === 'prototype');

        // Stats
        statsContainer.innerHTML = `
            <div class="stats-pill"><span style="color:#00bcd4">‚óè</span> Active Prototypes: ${builds.length}</div>
        `;

        container.innerHTML = '';
        
        if (builds.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="icon">üöÄ</div>
              <h3>No active prototypes</h3>
              <p>Promote builds from The Forge to start prototyping.</p>
            </div>`;
          return;
        }

        // Sort by date descending
        builds.sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0));

        builds.forEach(build => {
          const card = document.createElement('div');
          card.className = 'card';
          
          const tagsHtml = (build.stack || []).map(t => `<span class="tag">${t}</span>`).join('');
          const dateStr = new Date(build.timestamp).toLocaleString();

          // Auto-detect preview URL (reusing beta logic)
          const buildSlugMap = {
            'YouTube Transcriber': 'youtube-transcriber',
            'Crypto Portfolio Tracker': 'crypto-portfolio',
            'Crypto Portfolio': 'crypto-portfolio',
            'Discord Webhook Tester': 'discord-webhook-tester',
            'Discord Webhook': 'discord-webhook-tester',
            'Trading Journal': 'trading-journal',
            'OpenClaw Templates': 'openclaw-templates'
          };
          let previewUrl = build.outputUrl || build.previewUrl || '';
          if (!previewUrl && build.name) {
            const slug = buildSlugMap[build.name];
            if (slug) previewUrl = '/beta-preview/' + slug;
          }
          let previewBtn = '';
          if (previewUrl) {
              previewBtn = `<button class="beta-btn" onclick="openBetaPreview('${previewUrl}', '${(build.name || build.title || 'Build').replace(/'/g, '')}')">üëÅÔ∏è Preview</button>`;
          }

          card.innerHTML = `
            <div class="card-header">
              <h3 class="card-title">${build.name || 'Untitled Build'}</h3>
              <span class="status-badge live">Prototype</span>
            </div>
            <div class="card-meta">
               <span>${dateStr}</span>
            </div>
            <div class="tags">${tagsHtml}</div>
            <p>${build.description || 'No description provided.'}</p>
            
            <div class="beta-actions">
               ${previewBtn}
               <button class="beta-btn golive" onclick="updateBuildStatus('${build.id}', 'production')">üöÄ Promote to Production</button>
               <button class="beta-btn" onclick="updateBuildStatus('${build.id}', 'queued')" style="background:#ff980020;color:#ff9800;border:1px solid #ff980040;">üîÑ Send Back to Forge</button>
            </div>
          `;
          container.appendChild(card);
        });

      } catch (err) {
        console.error(err);
        container.innerHTML = `<div class="error">Error loading Prototype Lab: ${err.message}</div>`;
      }
    }

    // --- BETA LOGIC ---

    async function loadBetaBuilds() {
      const container = document.getElementById('beta-builds-grid');
      const statsContainer = document.getElementById('beta-stats');
      container.innerHTML = '<div class="loading">Loading Beta Lab...</div>';

      try {
        const res = await fetch('/api/fountain/builds');
        if (!res.ok) throw new Error('Failed to load builds');
        const allBuilds = await res.json();
        
        // Filter: exclude 'queued' and 'building'
        const builds = allBuilds.filter(b => b.status !== 'queued' && b.status !== 'building' && b.status !== 'archived');

        // Calculate stats
        const reviewCount = builds.filter(b => b.status === 'review' || b.status === 'done').length;
        const approvedCount = builds.filter(b => b.status === 'approved' || b.status === 'live').length;
        const rejectedCount = builds.filter(b => b.status === 'rejected').length;
        
        statsContainer.innerHTML = `
            <div class="stats-pill"><span style="color:#ffc107">‚óè</span> In Review: ${reviewCount}</div>
            <div class="stats-pill"><span style="color:#4caf50">‚óè</span> Approved: ${approvedCount}</div>
            <div class="stats-pill"><span style="color:#f44336">‚óè</span> Rejected: ${rejectedCount}</div>
        `;

        container.innerHTML = '';
        
        if (builds.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="icon">üß™</div>
              <h3>No builds ready for review</h3>
              <p>Queue something in The Forge to see it here!</p>
            </div>`;
          return;
        }

        // Sort: review first, then by date descending
        builds.sort((a, b) => {
            const priority = { 'done': 0, 'review': 0, 'approved': 1, 'live': 1, 'rejected': 2 };
            if (priority[a.status] !== priority[b.status]) return priority[a.status] - priority[b.status];
            return new Date(b.timestamp || 0) - new Date(a.timestamp || 0);
        });

        builds.forEach(build => {
          const card = document.createElement('div');
          card.className = 'card';
          
          let statusClass = build.status;
          let statusLabel = build.status.charAt(0).toUpperCase() + build.status.slice(1);
          
          if (build.status === 'done') {
             statusClass = 'review'; // treat 'done' as 'review' for visual consistency if backend hasn't updated yet
             statusLabel = 'Ready for Review';
          } else if (build.status === 'review') {
             statusLabel = 'Ready for Review';
          } else if (build.status === 'live' || build.status === 'production') {
             statusLabel = 'üöÄ Live';
             statusClass = 'live';
          } else if (build.status === 'prototype') {
             statusLabel = 'üöÄ Prototype';
             statusClass = 'live';
          }

          const tagsHtml = (build.stack || []).map(t => `<span class="tag">${t}</span>`).join('');
          const cost = build.cost ? `$${build.cost.toFixed(4)}` : 'Unknown';
          const dateStr = new Date(build.timestamp).toLocaleString();

          // Auto-detect preview URL from build name/description
          const buildSlugMap = {
            'YouTube Transcriber': 'youtube-transcriber',
            'Crypto Portfolio Tracker': 'crypto-portfolio',
            'Crypto Portfolio': 'crypto-portfolio',
            'Discord Webhook Tester': 'discord-webhook-tester',
            'Discord Webhook': 'discord-webhook-tester',
            'Trading Journal': 'trading-journal',
            'OpenClaw Templates': 'openclaw-templates'
          };
          let previewUrl = build.outputUrl || build.previewUrl || '';
          if (!previewUrl && build.name) {
            const slug = buildSlugMap[build.name];
            if (slug) previewUrl = '/beta-preview/' + slug;
          }
          let previewBtn = '';
          if (previewUrl) {
              previewBtn = `<button class="beta-btn" onclick="openBetaPreview('${previewUrl}', '${(build.name || build.title || 'Build').replace(/'/g, '')}')">üëÅÔ∏è Preview</button>`;
          }

          // Action buttons logic based on status
          let actionsHtml = '';
          
          if (build.status === 'done' || build.status === 'review') {
             actionsHtml = `
                <button class="beta-btn approve" onclick="updateBuildStatus('${build.id}', 'approved')">‚úÖ Approve</button>
                <button class="beta-btn" onclick="sendToTitan('${build.id}')" style="background:#ff980020;color:#ff9800;border:1px solid #ff980040;">üîÑ Send to Titan</button>
                <button class="beta-btn reject" onclick="updateBuildStatus('${build.id}', 'rejected')">‚ùå Reject</button>
                <button class="beta-btn" onclick="updateBuildStatus('${build.id}', 'archived')" style="background:#9e9e9e15;color:#9e9e9e;border:1px solid #9e9e9e30;">üì¶ Archive</button>
             `;
          } else if (build.status === 'approved') {
             actionsHtml = `
                <button class="beta-btn golive" onclick="updateBuildStatus('${build.id}', 'live')">üöÄ Go Live</button>
                <button class="beta-btn reject" onclick="updateBuildStatus('${build.id}', 'rejected')">‚ùå Revoke</button>
                <button class="beta-btn" onclick="updateBuildStatus('${build.id}', 'archived')" style="background:#9e9e9e15;color:#9e9e9e;border:1px solid #9e9e9e30;">üì¶ Archive</button>
             `;
          } else if (build.status === 'rejected') {
             actionsHtml = `
                <button class="beta-btn rebuild" onclick="updateBuildStatus('${build.id}', 'queued')">üîÑ Rebuild</button>
                <button class="beta-btn approve" onclick="updateBuildStatus('${build.id}', 'approved')">‚úÖ Re-Approve</button>
             `;
          } else if (build.status === 'live' || build.status === 'production') {
             actionsHtml = `
                 <button class="beta-btn" disabled style="opacity:0.5">Live & Deployed</button>
             `;
          }

          card.innerHTML = `
            <div class="card-header">
              <h3 class="card-title">${build.name || 'Untitled Build'}</h3>
              <span class="status-badge ${statusClass}">${statusLabel}</span>
            </div>
            <div class="card-meta">
               <span>${dateStr}</span> ‚Ä¢ <span>Cost: ${cost}</span>
            </div>
            <div class="tags">${tagsHtml}</div>
            <p>${build.description || 'No description provided.'}</p>
            
            <div class="beta-actions">
               ${previewBtn}
               ${actionsHtml}
            </div>
          `;
          container.appendChild(card);
        });

      } catch (err) {
        console.error(err);
        container.innerHTML = `<div class="error">Error loading Beta Lab: ${err.message}</div>`;
      }
    }

    async function updateBuildStatus(id, newStatus) {
        try {
            const res = await fetch(`/api/fountain/builds/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            });
            if (!res.ok) throw new Error('Update failed');
            loadBetaBuilds(); // Refresh UI
            showToast(`Build marked as ${newStatus}`, 'success');
        } catch(err) {
            console.error(err);
            showToast('Failed to update build status', 'error');
        }
    }

    function openBetaPreview(url, name) {
      let overlay = document.getElementById('beta-preview-overlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'beta-preview-overlay';
        overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:10000;display:flex;flex-direction:column;padding:16px;';
        overlay.innerHTML = `
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
            <h3 id="beta-preview-title" style="color:#00ffff;margin:0;font-size:16px;">Preview</h3>
            <div style="display:flex;gap:8px;">
              <a id="beta-preview-newtab" href="#" target="_blank" style="color:#00ff88;font-size:13px;text-decoration:none;padding:6px 12px;border:1px solid #00ff8840;border-radius:6px;">‚Üó Open in New Tab</a>
              <button onclick="closeBetaPreview()" style="background:#ff525230;color:#ff5252;border:1px solid #ff525240;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:13px;">‚úï Close</button>
            </div>
          </div>
          <iframe id="beta-preview-iframe" style="flex:1;border:1px solid rgba(255,255,255,0.1);border-radius:8px;background:#0a0a0f;" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
        `;
        document.body.appendChild(overlay);
      }
      overlay.style.display = 'flex';
      document.getElementById('beta-preview-title').textContent = 'üß™ Preview: ' + name;
      document.getElementById('beta-preview-newtab').href = url;
      document.getElementById('beta-preview-iframe').src = url;
    }

    function closeBetaPreview() {
      const overlay = document.getElementById('beta-preview-overlay');
      if (overlay) {
        overlay.style.display = 'none';
        document.getElementById('beta-preview-iframe').src = '';
      }
    }

  </script>
    </div>

    <!-- Section: ICT Signals Feed -->
    <div class="dl-section">
      <div class="signals-controls">
        <div>
          <div class="dl-section-header">
            <span>üì°</span> ICT Signals Feed
          </div>
          <div class="dl-section-desc">Signals power the <a href="https://x.com/PriceCipherHQ" target="_blank" style="color:var(--accent-cyan);text-decoration:none;">@Decrypt_Labs</a> X account</div>
        </div>
        <div class="auto-refresh-badge">
          <span class="pulse-dot"></span>
          Auto-refresh 30s
        </div>
      </div>
      <div id="signals-feed">
        <div class="empty-state">
          <div class="icon">üì°</div>
          <div class="message">Loading signals from /api/signals...</div>
        </div>
      </div>
    </div>

    <!-- Section: Project Status -->
    <div class="dl-section">
      <div class="dl-section-header">
        <span>üì¶</span> Project Status
      </div>
      <div class="dl-section-desc">Current state of $CIPHER ecosystem deliverables</div>
      <div class="project-status-grid">
        <div class="project-status-card">
          <div class="project-status-icon">ü™ô</div>
          <div>
            <div class="project-status-label">Token</div>
            <div class="project-status-value">$CIPHER on Base (Virtuals Protocol)</div>
            <span class="status-badge pre-launch">Pre-Launch</span>
          </div>
        </div>
        <div class="project-status-card">
          <div class="project-status-icon">üåê</div>
          <div>
            <div class="project-status-label">Website</div>
            <div class="project-status-value"><a href="https://decryptlabs.io" target="_blank">decryptlabs.io</a></div>
            <span class="status-badge live">Live</span>
          </div>
        </div>
        <div class="project-status-card">
          <div class="project-status-icon">üèôÔ∏è</div>
          <div>
            <div class="project-status-label">Dashboard</div>
            <div class="project-status-value"><a href="https://decryptlabs.io/city.html" target="_blank">decryptlabs.io/city.html</a></div>
            <span class="status-badge live">Live</span>
          </div>
        </div>
        <div class="project-status-card">
          <div class="project-status-icon">üé®</div>
          <div>
            <div class="project-status-label">NFTs</div>
            <div class="project-status-value">20 Cipher Bots on IPFS</div>
            <span class="status-badge complete">Complete</span>
          </div>
        </div>
        <div class="project-status-card">
          <div class="project-status-icon">üìú</div>
          <div>
            <div class="project-status-label">Smart Contracts</div>
            <div class="project-status-value">Base</div>
            <span class="status-badge pending">Mainnet Pending</span>
          </div>
        </div>
        <div class="project-status-card">
          <div class="project-status-icon">üê¶</div>
          <div>
            <div class="project-status-label">X Account</div>
            <div class="project-status-value"><a href="https://x.com/PriceCipherHQ" target="_blank">@Decrypt_Labs</a></div>
            <span class="status-badge live">Live</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Section: Buyback & Burn Tracker -->
    <div class="dl-section">
      <div class="dl-section-header">
        <span>üî•</span> Buyback & Burn Tracker
      </div>
      <div class="dl-section-desc">Revenue allocation ‚Äî will populate when token launches</div>
      <div class="burn-grid">
        <div class="burn-card">
          <div class="burn-card-label">Total Burned</div>
          <div class="burn-card-value">‚Äî</div>
        </div>
        <div class="burn-card">
          <div class="burn-card-label">Total Revenue</div>
          <div class="burn-card-value">‚Äî</div>
        </div>
        <div class="burn-card">
          <div class="burn-card-label">Next Buyback</div>
          <div class="burn-card-value">‚Äî</div>
        </div>
      </div>
      <div class="burn-allocation">
        <span class="burn-alloc-pill primary">üî• 80% Buyback & Burn</span>
        <span class="burn-alloc-pill">‚õΩ 10% Fuel</span>
        <span class="burn-alloc-pill">üîß 5% Repairs</span>
        <span class="burn-alloc-pill">üõ°Ô∏è 5% Insurance</span>
      </div>
    </div>

    <!-- Section: Access Control -->
    <div class="dl-section">
      <div class="dl-section-header">
        <span>üîë</span> Access Control
      </div>
      <div class="dl-section-desc">Manage TradingView indicator/strategy access requests ‚Äî $CIPHER tier-gated</div>

      <div class="ac-stats-row">
        <div class="ac-stat-card">
          <div class="ac-stat-value" id="ac-pending">0</div>
          <div class="ac-stat-label">Pending Requests</div>
        </div>
        <div class="ac-stat-card">
          <div class="ac-stat-value" id="ac-indicator">0</div>
          <div class="ac-stat-label">Indicator Users</div>
        </div>
        <div class="ac-stat-card">
          <div class="ac-stat-value" id="ac-strategy">0</div>
          <div class="ac-stat-label">Strategy Users</div>
        </div>
        <div class="ac-stat-card">
          <div class="ac-stat-value warning" id="ac-revoke">0</div>
          <div class="ac-stat-label">Need Revocation</div>
        </div>
      </div>

      <div class="ac-card">
        <div class="ac-card-header">
          <div class="ac-card-title"><span>üì•</span> New Access Requests</div>
          <div>
            <button class="ac-scan-btn" onclick="acRefreshRequests()">üîÑ Refresh</button>
          </div>
        </div>
        <div class="ac-card-body">
          <table class="ac-table">
            <thead>
              <tr>
                <th>TradingView User</th>
                <th>Type</th>
                <th>Details</th>
                <th>Wallet</th>
                <th>Tier</th>
                <th>Holdings</th>
                <th>Requested</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="ac-requests-table">
              <tr>
                <td colspan="8" class="ac-empty-state">No pending requests</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="ac-card">
        <div class="ac-card-header">
          <div class="ac-card-title"><span>‚úÖ</span> Approved Users</div>
        </div>
        <div class="ac-card-body">
          <table class="ac-table">
            <thead>
              <tr>
                <th>TradingView User</th>
                <th>Access Type</th>
                <th>Wallet</th>
                <th>Current Holdings</th>
                <th>Status</th>
                <th>Approved</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="ac-approved-table">
              <tr>
                <td colspan="7" class="ac-empty-state">No approved users yet</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Section: Wallet Scanner -->
    <div class="dl-section">
      <div class="dl-section-header">
        <span>üîç</span> Wallet Scanner
      </div>
      <div class="dl-section-desc">Monitor approved users' wallets ‚Äî ensure they maintain required $CIPHER holdings for access</div>

      <div class="ac-stats-row">
        <div class="ac-stat-card">
          <div class="ac-stat-value" id="ac-scan-total">0</div>
          <div class="ac-stat-label">Total Wallets</div>
        </div>
        <div class="ac-stat-card">
          <div class="ac-stat-value" id="ac-scan-healthy">0</div>
          <div class="ac-stat-label">Healthy</div>
        </div>
        <div class="ac-stat-card">
          <div class="ac-stat-value warning" id="ac-scan-warning">0</div>
          <div class="ac-stat-label">Low Balance</div>
        </div>
        <div class="ac-stat-card">
          <div class="ac-stat-value warning" id="ac-scan-danger">0</div>
          <div class="ac-stat-label">Below Threshold</div>
        </div>
      </div>

      <div class="ac-card">
        <div class="ac-card-header">
          <div class="ac-card-title"><span>üîç</span> Wallet Holdings Scanner</div>
          <div>
            <button class="ac-scan-btn" id="acScanAllBtn" onclick="acScanAllWallets()">
              üîÑ Scan All Wallets
            </button>
          </div>
        </div>
        <div class="ac-card-body">
          <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 12px;">
            Monitors all approved users' wallets to ensure they maintain required $CIPHER holdings.
            Users who drop below their tier threshold will be flagged for access revocation.
          </p>
          <div class="ac-scanner-grid" id="ac-scanner-grid">
            <div class="ac-empty-state">
              <div class="ac-empty-state-icon">üîç</div>
              <div>Click "Scan All Wallets" to check holdings</div>
            </div>
          </div>
        </div>
      </div>

      <div class="ac-card">
        <div class="ac-card-header">
          <div class="ac-card-title"><span>‚ö†Ô∏è</span> Revocation Queue</div>
        </div>
        <div class="ac-card-body">
          <table class="ac-table">
            <thead>
              <tr>
                <th>TradingView User</th>
                <th>Access Type</th>
                <th>Required</th>
                <th>Current Balance</th>
                <th>Shortfall</th>
                <th>Grace Period</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="ac-revocation-table">
              <tr>
                <td colspan="7" class="ac-empty-state">No users pending revocation</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê TAB: CALENDAR (Weekly Tasks + Expenses) ‚ïê‚ïê‚ïê -->
  <div class="tab-content" id="tab-calendar">
    <h1 class="section-title">Calendar</h1>
    <p class="section-subtitle">Weekly schedule, tasks & expenses ‚Äî all in one place</p>

    <!-- Weekly Personal Calendar -->
    <div class="personal-calendar-section">
      <div class="personal-cal-header">
        <div>
          <div class="personal-cal-title">üìÖ Weekly Personal Schedule</div>
          <div class="personal-cal-subtitle">Color-coded by category ‚Ä¢ Click to edit ‚Ä¢ + to add</div>
        </div>
        <div class="personal-cal-legend">
          <span class="legend-item"><span class="legend-dot" style="background:#00ff88;"></span>Trading/Bots</span>
          <span class="legend-item"><span class="legend-dot" style="background:#aa66ff;"></span>Content/Social</span>
          <span class="legend-item"><span class="legend-dot" style="background:#00d4ff;"></span>Business/Admin</span>
          <span class="legend-item"><span class="legend-dot" style="background:#ffdd44;"></span>Personal</span>
        </div>
      </div>
      <div class="personal-cal-grid" id="personal-cal-grid"></div>
    </div>

    <!-- Next Up Section -->
    <!-- Bills Calendar Section -->
    <div class="bills-calendar-section">
      <div class="bills-cal-header">
        <div>
          <div class="bills-cal-title">üí∞ Monthly Bills</div>
          <div class="bills-cal-subtitle">Visualized from Expenses table below</div>
        </div>
        <div class="bills-cal-controls">
          <button class="bills-nav-btn" onclick="changeBillMonth(-1)">‚óÄ</button>
          <span class="bills-month-label" id="bills-month-display">February 2026</span>
          <button class="bills-nav-btn" onclick="changeBillMonth(1)">‚ñ∂</button>
          <button class="bills-today-btn" onclick="goToCurrentBillMonth()">Today</button>
        </div>
      </div>
      
      <div class="bills-cal-grid" id="bills-cal-grid">
        <!-- JS will populate -->
      </div>

      <div class="bills-summary-bar">
        <div class="bill-summary-item">
          <div class="label">Total Monthly</div>
          <div class="value" id="bills-total-monthly">$0.00</div>
        </div>
        <div class="bill-summary-item">
          <div class="label">Next Due</div>
          <div class="value" id="bills-next-due">‚Äî</div>
        </div>
        <div class="bill-summary-item">
          <div class="label">Remaining</div>
          <div class="value" id="bills-remaining">$0.00</div>
        </div>
      </div>
    </div>

    <!-- Monthly Expenses -->
    <div class="expenses-section">
      <div class="expenses-title">üí∏ Monthly Expenses</div>
      <table class="expense-table" id="expense-table">
        <thead>
          <tr>
            <th>Service</th>
            <th>Notes</th>
            <th style="width:60px;text-align:center;">Due</th>
            <th>Cost</th>
            <th style="width:30px;"></th>
          </tr>
        </thead>
        <tbody id="expense-body"></tbody>
      </table>
      <div class="expense-actions">
        <button class="expense-btn add" onclick="addExpenseRow('business')">+ Add Business</button>
        <button class="expense-btn add" onclick="addExpenseRow('personal')">+ Add Personal</button>
        <button class="expense-btn save" onclick="saveExpenses()">üíæ Save Changes</button>
      </div>
      <div class="expense-total" id="expense-totals" style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-top:16px;">
      </div>
    </div>
  </div>

</div>

  <!-- ‚ïê‚ïê‚ïê TAB: IDEAS ‚ïê‚ïê‚ïê -->
  <div class="tab-content" id="tab-ideas">
    <h1 class="section-title">üí° Ideas Lab</h1>
    <p class="section-subtitle">Brainstorms, experiments & future projects ‚Äî capture everything</p>

    <div style="display:flex;gap:12px;margin-bottom:20px;">
      <button onclick="addIdea()" style="background:linear-gradient(135deg,#00ffc8,#00b894);color:#0a0e17;border:none;padding:10px 20px;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px;">+ New Idea</button>
      <select id="idea-filter" onchange="renderIdeas()" style="background:#1a1e2e;color:#e0e0e0;border:1px solid #2a2e3e;padding:8px 14px;border-radius:8px;font-size:13px;">
        <option value="all">All Ideas</option>
        <option value="hot">üî• Hot</option>
        <option value="backlog">üìã Backlog</option>
        <option value="in-progress">üöß In Progress</option>
        <option value="done">‚úÖ Done</option>
        <option value="trading">üìà Trading</option>
        <option value="content">üé¨ Content</option>
        <option value="product">üõ†Ô∏è Product</option>
        <option value="token">ü™ô Token</option>
      </select>
    </div>

    <div id="ideas-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;"></div>
  </div>

  <!-- ‚ïê‚ïê‚ïê TAB: THE FOUNTAIN ‚ïê‚ïê‚ïê -->
  <div class="tab-content" id="tab-fountain">
    <div style="text-align:center;margin-bottom:28px;">
      <h1 class="section-title" style="background:linear-gradient(90deg,#ff9800,#ffb74d,#ff9800);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">üåä The Fountain</h1>
      <p class="section-subtitle">Where ideas are born. Agents scan trends, generate ideas, validate markets ‚Äî autonomously.</p>
    </div>

    <!-- Fountain Agent Avatars -->
    <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-bottom:24px;">
      <div id="fountain-agents-bar"></div>
    </div>

    <!-- Stats Bar -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-bottom:28px;" id="fountain-stats">
      <div style="background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;padding:16px;text-align:center;border-top:2px solid #ff9800;">
        <div style="font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;">Trends Found</div>
        <div id="ft-stat-trends" style="font-family:'Orbitron',sans-serif;font-size:28px;font-weight:700;color:#ff9800;margin-top:4px;">0</div>
      </div>
      <div style="background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;padding:16px;text-align:center;border-top:2px solid #ffb74d;">
        <div style="font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;">Ideas Generated</div>
        <div id="ft-stat-ideas" style="font-family:'Orbitron',sans-serif;font-size:28px;font-weight:700;color:#ffb74d;margin-top:4px;">0</div>
      </div>
      <div style="background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;padding:16px;text-align:center;border-top:2px solid #ffd54f;">
        <div style="font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;">In Ideas Lab</div>
        <div id="ft-stat-lab" style="font-family:'Orbitron',sans-serif;font-size:28px;font-weight:700;color:#ffd54f;margin-top:4px;">0</div>
      </div>
      <div style="background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;padding:16px;text-align:center;border-top:2px solid #81c784;">
        <div style="font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;">In Pipeline</div>
        <div id="ft-stat-pipeline" style="font-family:'Orbitron',sans-serif;font-size:28px;font-weight:700;color:#81c784;margin-top:4px;">0</div>
      </div>
    </div>

    <!-- Trend Radar Section -->
    <div style="margin-bottom:32px;">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
        <span style="font-size:24px;">üî≠</span>
        <h2 style="font-family:'Orbitron',sans-serif;font-size:16px;font-weight:700;color:#ff9800;">Trend Radar</h2>
        <span style="font-size:11px;color:var(--text-dim);margin-left:auto;">Scanned by Scout Agent</span>
      </div>
      <div id="fountain-trends" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px;">
        <div style="text-align:center;padding:40px;color:var(--text-dim);grid-column:1/-1;">
          <div style="font-size:40px;opacity:0.3;margin-bottom:8px;">üî≠</div>
          <div>No trends scanned yet. Scout is on patrol...</div>
        </div>
      </div>
    </div>

    <!-- Idea Stream Section -->
    <div style="margin-bottom:32px;">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;flex-wrap:wrap;">
        <span style="font-size:24px;">üíß</span>
        <h2 style="font-family:'Orbitron',sans-serif;font-size:16px;font-weight:700;color:#ffb74d;">Idea Stream</h2>
        <div style="margin-left:auto;display:flex;gap:6px;">
          <button class="ft-filter-btn active" data-filter="all" onclick="setFountainFilter('all',this)">All</button>
          <button class="ft-filter-btn" data-filter="lab" onclick="setFountainFilter('lab',this)">üß™ Ideas Lab</button>
          <button class="ft-filter-btn" data-filter="pipeline" onclick="setFountainFilter('pipeline',this)">üöÄ Pipeline</button>
        </div>
      </div>
      <div id="fountain-ideas" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(360px,1fr));gap:14px;">
        <div style="text-align:center;padding:40px;color:var(--text-dim);grid-column:1/-1;">
          <div style="font-size:40px;opacity:0.3;margin-bottom:8px;">üíß</div>
          <div>No ideas generated yet. Spark is thinking...</div>
        </div>
      </div>
    </div>

    <!-- Ideas Lab Section -->
    <div style="margin-bottom:32px;">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
        <span style="font-size:24px;">üß™</span>
        <h2 style="font-family:'Orbitron',sans-serif;font-size:16px;font-weight:700;color:#ffd54f;">Ideas Lab</h2>
        <span style="font-size:11px;color:var(--text-dim);margin-left:auto;">Validated ideas ready for pipeline</span>
      </div>
      <div id="fountain-lab" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(380px,1fr));gap:14px;">
        <div style="text-align:center;padding:40px;color:var(--text-dim);grid-column:1/-1;">
          <div style="font-size:40px;opacity:0.3;margin-bottom:8px;">üß™</div>
          <div>No ideas in the lab yet. Promote ideas from the stream!</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê TAB: THE FORGE ‚ïê‚ïê‚ïê -->
  <div class="tab-content" id="tab-forge">
    <div style="text-align:center;margin-bottom:28px;">
      <h1 class="section-title" style="background:linear-gradient(90deg,#00e5ff,#aa66ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">üî® The Forge</h1>
      <p class="section-subtitle">Autonomous Builder. Ideas ‚Üí MVPs in minutes.</p>
    </div>

    <!-- Forge Stats Bar -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-bottom:28px;">
      <div style="background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;padding:16px;text-align:center;border-top:2px solid #ff8a00;">
        <div style="font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;">Queued</div>
        <div id="forge-stat-queued" style="font-family:'Orbitron',sans-serif;font-size:28px;font-weight:700;color:#ff8a00;margin-top:4px;">0</div>
      </div>
      <div style="background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;padding:16px;text-align:center;border-top:2px solid #00e5ff;">
        <div style="font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;">Building</div>
        <div id="forge-stat-building" style="font-family:'Orbitron',sans-serif;font-size:28px;font-weight:700;color:#00e5ff;margin-top:4px;">0</div>
      </div>
      <div style="background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;padding:16px;text-align:center;border-top:2px solid #00ff99;">
        <div style="font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;">Deployed</div>
        <div id="forge-stat-deployed" style="font-family:'Orbitron',sans-serif;font-size:28px;font-weight:700;color:#00ff99;margin-top:4px;">0</div>
      </div>
      <div style="background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;padding:16px;text-align:center;border-top:2px solid #a855f7;">
        <div style="font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;">Approved</div>
        <div id="forge-stat-approved" style="font-family:'Orbitron',sans-serif;font-size:28px;font-weight:700;color:#a855f7;margin-top:4px;">0</div>
      </div>
    </div>

    <!-- Build Queue -->
    <div style="margin-bottom:32px;">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
        <span style="font-size:24px;">üèóÔ∏è</span>
        <h2 style="font-family:'Orbitron',sans-serif;font-size:16px;font-weight:700;color:#00e5ff;">Build Queue</h2>
        <button onclick="fetchForgeBuilds()" style="margin-left:auto;background:transparent;border:1px solid var(--border-color);color:var(--text-secondary);border-radius:6px;padding:4px 10px;font-size:11px;cursor:pointer;">Refresh</button>
      </div>
      <div id="forge-queue" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:16px;">
        <!-- Builds populated here -->
        <div style="text-align:center;padding:40px;color:var(--text-dim);grid-column:1/-1;">
          <div style="font-size:40px;opacity:0.3;margin-bottom:8px;">üî®</div>
          <div>Forge is empty. Send an idea from The Fountain!</div>
        </div>
      </div>
    </div>
  </div>

  <!-- PROTOTYPE TAB -->
  <div id="tab-prototype" class="tab-content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
      <div>
        <h2 style="margin:0;font-size:20px;">üöÄ Prototype Lab</h2>
        <p style="color:#888;font-size:13px;margin:4px 0 0;">Building to completion. Ready for real users.</p>
      </div>
      <div id="prototype-stats" style="font-size:12px;color:#888;"></div>
    </div>

    <div id="prototype-builds-grid" class="cards-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap:20px;">
      <div class="loading">Loading Prototype Lab...</div>
    </div>
  </div>

  <!-- BETA TAB -->
  <div id="tab-beta" class="tab-content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
      <div>
        <h2 style="margin:0;font-size:20px;">üß™ Beta Lab ‚Äî Review & Approve Builds</h2>
        <p style="color:#888;font-size:13px;margin:4px 0 0;">Completed Forge builds waiting for your review</p>
      </div>
      <div style="display:flex;align-items:center;gap:16px;">
        <span id="titan-status" style="font-size:12px;">üí§ Titan Idle</span>
        <span id="beta-stats" style="font-size:12px;color:#888;"></span>
      </div>
    </div>

    <div id="titan-workshop" style="margin-bottom:30px;display:none;">
      <h3 style="color:#ff9800;font-size:14px;margin-bottom:12px;">üî® Titan\'s Workshop <span id="titan-count" style="font-size:12px;color:#666;"></span></h3>
      <div id="titan-workshop-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:12px;"></div>
    </div>

    <h3 style="color:#00ffff;font-size:14px;margin-bottom:12px;">üìã Ready for Review</h3>
    <div id="beta-builds-grid" class="cards-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap:20px;">
      <div class="loading">Loading Beta Lab...</div>
    </div>

    <div style="margin-top:40px;border-top:1px solid rgba(255,255,255,0.05);padding-top:20px;">
      <h3 style="color:#9e9e9e;font-size:14px;margin-bottom:12px;">üì¶ Archive</h3>
      <div id="beta-archive-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:12px;">
        <div style="color:#666;font-size:13px;padding:20px;text-align:center;">No archived builds</div>
      </div>
    </div>
  </div>

<!-- Refresh indicator -->
<div class="refresh-indicator">
  <span class="pulse-dot"></span>
  <span id="last-refresh">‚Äî</span>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const state = {
  accounts: {},
  signals: [],
  stats: {},
  healthy: false,
  lastRefresh: null
};

// Bot definitions
const BOTS = [
  { id: 'tina', botId: 'fvg-ifvg-1', name: 'Code Screamer', number: '#13', strategy: 'FVG+IFVG Strategy', account: 'APEX-18', emoji: 'üîß', image: '/nft-art/new-collection/images/13-Code-Screamer.jpg', tokenId: 0, nftName: 'Code Screamer', contractAddress: '0x743EBDfcED2dBA082E282689c35D5c0E173C7728', chainId: 8453, desc: 'Determines order flow using Fair Value Gaps and Inverse FVGs. Trades during ICT macro windows: Accumulation, Pre-NY, NY Open, Silver Bullet, and London Close.' },
  { id: 'danny', botId: 'ote-silver-bullet', name: 'Neon Stalker', number: '#01', strategy: 'OTE Silver Bullet', account: 'APEX-19', emoji: 'üíé', image: '/nft-art/new-collection/images/01-Neon-Stalker.jpg', tokenId: 1, nftName: 'Neon Stalker', contractAddress: '0x743EBDfcED2dBA082E282689c35D5c0E173C7728', chainId: 8453, desc: 'Executes Silver Bullet entries at Optimal Trade Entry levels. Focuses on the 10:00-11:00 AM ET silver bullet window for high-probability setups.' },
  { id: 'annie', botId: 'ote-refined-small', name: 'Rekt Reaper', number: '#05', strategy: 'OTE Refined', account: 'APEX-20', emoji: 'üìä', image: '/nft-art/new-collection/images/05-Rekt-Reaper.jpg', tokenId: 2, nftName: 'Rekt Reaper', contractAddress: '0x743EBDfcED2dBA082E282689c35D5c0E173C7728', chainId: 8453, desc: 'Refined OTE strategy with enhanced entry/exit logic. Focuses on confluence of OTE levels with displacement and market structure shifts.' },
  { id: 'mike', botId: 'new-300k', name: 'Signal Sage', number: '#08', strategy: 'OTE Refined Large', account: 'APEX-21', emoji: 'üöÄ', image: '/nft-art/new-collection/images/08-Signal-Sage.jpg', tokenId: 3, nftName: 'Signal Sage', contractAddress: '0x743EBDfcED2dBA082E282689c35D5c0E173C7728', chainId: 8453, desc: 'The big gun. Runs OTE Refined Large on our largest account ‚Äî a $300K evaluation. Bigger position sizing and higher stakes.' }
];

// Task data ‚Äî persisted to API + localStorage
const DEFAULT_TASKS = [
  { id: 1, title: 'Set up Rithmic accounts', desc: 'Migrate from Tradovate to Rithmic for better drawdown rules', priority: 'high', assignee: 'DropKing', column: 'todo' },
  { id: 2, title: 'Backtest FVG+IFVG refinements', desc: 'Test new entry filter on 2-week historical data', priority: 'medium', assignee: 'Jimmy', column: 'todo' },
  { id: 3, title: 'Build caretaker dashboard', desc: 'Mission control UI for the caretaker server', priority: 'high', assignee: 'Jimmy', column: 'done' },
  { id: 4, title: 'Discord bot-performance auto-post', desc: 'Auto-post daily P&L to #bot-performance channel', priority: 'medium', assignee: 'Jimmy', column: 'in-progress' },
  { id: 5, title: 'Add PM session risk management', desc: 'Auto-pause bots when green before PM session', priority: 'high', assignee: 'Jimmy', column: 'in-progress' },
  { id: 6, title: 'Landing page live', desc: 'Deploy decryptlabs.io via Cloudflare Pages', priority: 'high', assignee: 'Jimmy', column: 'done' },
  { id: 7, title: 'ICT analysis webhook pipeline', desc: 'Signal pipeline from TradingView to API', priority: 'medium', assignee: 'Jimmy', column: 'done' },
  { id: 8, title: 'Apex PA payout processing', desc: 'Waiting on Apex to approve PA status', priority: 'low', assignee: 'DropKing', column: 'blocked' },
  { id: 9, title: 'Add trailing drawdown to dashboard', desc: 'Show live drawdown gauge per bot', priority: 'medium', assignee: 'Jimmy', column: 'done' },
  { id: 10, title: 'Twitter auto-post market analysis', desc: 'Post daily analysis to @Decrypt_Labs', priority: 'low', assignee: 'Jimmy', column: 'todo' },
  { id: 11, title: 'Build mint-to-bot pipeline', desc: 'When someone mints an NFT, auto-assign to a trading bot slot with ‚è≥ Pending label', priority: 'high', assignee: 'Carl', column: 'todo' },
  { id: 12, title: 'Pre-load NFT archive for minting', desc: 'All 20 Cipher Bot NFTs available to mint from day one ‚Äî not on-demand', priority: 'high', assignee: 'Carl', column: 'todo' },
  { id: 13, title: 'Add "Share to X" post-mint button', desc: 'After minting, user can tweet about their NFT with pre-filled template + @Decrypt_Labs', priority: 'medium', assignee: 'Carl', column: 'todo' },
  { id: 14, title: 'Minted NFT appears on dashboard', desc: 'New mint shows on dashboard + holder page immediately with ‚è≥ Pending status', priority: 'high', assignee: 'Carl', column: 'todo' },
  { id: 15, title: 'Nightly mint activation checklist', desc: 'Documented process for activating new mints each evening ‚Äî Pending ‚Üí üü¢ Active', priority: 'medium', assignee: 'Jimmy', column: 'todo' },
  { id: 16, title: 'Add minted NFT to Cipher City', desc: 'Minted bot must appear in the 3D city dashboard alongside existing bots', priority: 'medium', assignee: 'Carl', column: 'todo' },
];
let kanbanTasks = [...DEFAULT_TASKS];
let kanbanNextId = 100;

// Schedule data
const SCHEDULE = {
  // Weekday tasks (Mon-Fri) ‚Äî AI bot automation schedule
  weekday: [
    { name: 'üöÄ Morning Bot Startup', time: '3:50 AM', color: 'green', hour: 3, min: 50, agent: 'Jimmy', desc: 'Enable OTE Silver Bullet, verify FVG+IFVG overnight' },
    { name: '‚òÄÔ∏è Morning Check-in', time: '4:00 AM', color: 'cyan', hour: 4, min: 0, agent: 'Jimmy', desc: 'Verify all bots online, check for overnight issues' },
    { name: 'üìä AM Balance Scrape', time: '5:00 AM', color: 'cyan', hour: 5, min: 0, agent: 'Cindy', desc: 'Scrape Tradovate balances, push to API' },
    { name: 'üì° ICT Signal Pipeline ON', time: '5:00 AM', color: 'orange', hour: 5, min: 0, agent: 'Cindy + Sheen', desc: 'Signal compiler + X post pipeline active (every 5 min until noon)' },
    { name: 'üì∞ Morning Market Breakdown', time: '6:00 AM', color: 'purple', hour: 6, min: 0, agent: 'Jimmy', desc: 'Pre-NY analysis, post to X + Discord' },
    { name: 'üì¢ X Posting Reminder', time: '10:00 AM', color: 'yellow', hour: 10, min: 0, agent: 'Jimmy', desc: 'Post trade results, engage with ICT community' },
    { name: 'üì° ICT Signal Pipeline OFF', time: '12:00 PM', color: 'orange', hour: 12, min: 0, agent: 'Cindy + Sheen', desc: 'Signal pipeline stops for the day' },
    { name: 'üìä PM Balance Scrape', time: '12:30 PM', color: 'cyan', hour: 12, min: 30, agent: 'Cindy', desc: 'Midday balance snapshot, push to API' },
    { name: 'üìà EOD Bot Performance', time: '1:00 PM', color: 'green', hour: 13, min: 0, agent: 'Sheen', desc: 'Post daily bot performance to Discord #general' },
    { name: 'üåô Afternoon Wrap-up', time: '3:00 PM', color: 'purple', hour: 15, min: 0, agent: 'Jimmy', desc: 'Review trades, calculate PnL, post EOD to X' },
    { name: 'üìä Website Data Update', time: '4:00 PM', color: 'cyan', hour: 16, min: 0, agent: 'Jimmy', desc: 'Refresh decryptlabs.io dashboard data' },
    { name: 'üõë Evening Bot Shutdown', time: '6:30 PM', color: 'red', hour: 18, min: 30, agent: 'Jimmy', desc: 'Pause OTE, verify FVG+IFVG running overnight' },
  ],
  // Weekend ‚Äî minimal ops
  weekend: [
    { name: 'üìä Daily Update', time: '5:00 AM', color: 'cyan', hour: 5, min: 0, agent: 'Jimmy', desc: 'Check systems, no trading (markets closed)' },
  ],
  // No more special ‚Äî everything is in weekday/weekend
  special: {}
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB SWITCHING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.querySelectorAll('.nav-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    const target = tab.getAttribute('data-tab');
    document.getElementById('tab-' + target).classList.add('active');
    
    if (target === 'prototype') loadPrototypeBuilds();
    if (target === 'beta') loadBetaBuilds();
    if (target === 'forge') fetchForgeBuilds();
  });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê API FETCHING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function fetchData() {
  try {
    // Fetch health
    const healthRes = await fetch('/health', { signal: AbortSignal.timeout(5000) }).catch(() => null);
    if (healthRes && healthRes.ok) {
      const health = await healthRes.json();
      state.healthy = true;
      document.getElementById('health-dot').className = 'status-dot green';
      document.getElementById('health-text').textContent = 'Online';
    } else {
      state.healthy = false;
      document.getElementById('health-dot').className = 'status-dot red';
      document.getElementById('health-text').textContent = 'Offline';
    }
  } catch(e) {
    document.getElementById('health-dot').className = 'status-dot red';
    document.getElementById('health-text').textContent = 'Offline';
  }

  try {
    const accRes = await fetch('/api/accounts', { signal: AbortSignal.timeout(5000) }).catch(() => null);
    if (accRes && accRes.ok) {
      const data = await accRes.json();
      state.accounts = data;
      updateAccountsUI(data);
    }
  } catch(e) { console.warn('Failed to fetch accounts:', e); }

  try {
    const sigRes = await fetch('/api/signals/ict', { signal: AbortSignal.timeout(5000) }).catch(() => null);
    if (sigRes && sigRes.ok) {
      const data = await sigRes.json();
      state.signals = Array.isArray(data) ? data : (data.signals || []);
      updateSignalsUI();
    }
  } catch(e) { console.warn('Failed to fetch ICT signals:', e); }

  try {
    const statsRes = await fetch('/api/stats', { signal: AbortSignal.timeout(5000) }).catch(() => null);
    if (statsRes && statsRes.ok) {
      const data = await statsRes.json();
      state.stats = data;
      updateStatsUI(data);
    }
  } catch(e) { console.warn('Failed to fetch stats:', e); }

  state.lastRefresh = new Date();
  document.getElementById('last-refresh').textContent = 'Updated ' + state.lastRefresh.toLocaleTimeString();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê UI UPDATES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateAccountsUI(data) {
  // API returns object keyed by bot-id ‚Äî convert to array
  let accounts;
  if (Array.isArray(data)) {
    accounts = data;
  } else if (data.accounts && Array.isArray(data.accounts)) {
    accounts = data.accounts;
  } else {
    // Object keyed by bot ID ‚Äî convert
    accounts = Object.entries(data).map(([id, acc]) => ({ id, ...acc }));
  }
  let totalAUM = 0;
  let totalPnl = 0;
  let activeBots = 0;

  accounts.forEach(acc => {
    const balance = parseFloat(acc.balance || acc.equity || 0);
    const pnl = parseFloat(acc.pnl || acc.todayPnl || 0);
    totalAUM += balance;
    totalPnl += pnl;
    if (acc.status === 'active' || acc.active) activeBots++;
  });

  if (totalAUM > 0) {
    document.getElementById('stat-aum').textContent = '$' + totalAUM.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
  }
  if (activeBots > 0) {
    document.getElementById('stat-bots').textContent = activeBots + '/' + accounts.length;
  }
  if (totalPnl !== 0) {
    const pnlEl = document.getElementById('stat-pnl');
    const prefix = totalPnl >= 0 ? '+$' : '-$';
    pnlEl.textContent = prefix + Math.abs(totalPnl).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
    pnlEl.style.color = totalPnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
  }

  // Update bots grid in Decrypt Labs tab
  renderBotsTab(accounts);
}

function updateSignalsUI() {
  const signals = state.signals.slice(0, 20);
  
  // Count 24h signals
  const now = Date.now();
  const dayAgo = now - 86400000;
  const recent24h = state.signals.filter(s => {
    const t = new Date(s.timestamp || s.time || s.created).getTime();
    return t > dayAgo;
  });
  document.getElementById('stat-signals').textContent = recent24h.length.toString();

  // ICT Signals feed (Decrypt Labs tab) ‚Äî isolated pipeline
  const feedEl = document.getElementById('signals-feed');
  if (signals.length === 0) {
    feedEl.innerHTML = '<div class="empty-state"><div class="icon">üì°</div><div class="message">No ICT signals received yet. Signals appear when macro windows trigger.</div></div>';
  } else {
    feedEl.innerHTML = signals.map(s => {
      const bias = (s.bias || 'neutral').toString().toLowerCase();
      const cardClass = bias.includes('bull') ? 'bullish' : bias.includes('bear') ? 'bearish' : 'neutral';
      const confVal = parseFloat(s.confidence) || 0;
      const confPct = confVal > 1 ? confVal : Math.round(confVal * 100);
      const confClass = confPct >= 70 ? 'confidence-high' : confPct >= 50 ? 'confidence-medium' : 'confidence-low';
      const time = s.timestamp || '';
      const timeStr = time ? new Date(time).toLocaleString() : '';
      const modelName = (s.model || '').replace(/_/g, ' ');
      
      return `
        <div class="signal-card ${cardClass}">
          <div class="signal-card-header">
            <div class="signal-trigger">${s.trigger || 'Signal'}</div>
            <span class="signal-confidence ${confClass}">${confPct}%</span>
          </div>
          <div class="signal-body">
            <div><div class="signal-field-label">Bias</div><div class="signal-field-value">${s.bias || '‚Äî'}</div></div>
            <div><div class="signal-field-label">Model</div><div class="signal-field-value">${modelName || '‚Äî'}</div></div>
            <div><div class="signal-field-label">Key Level</div><div class="signal-field-value">${s.keyLevel || '‚Äî'}</div></div>
            <div><div class="signal-field-label">Instrument</div><div class="signal-field-value">${s.instrument || 'MNQ'}</div></div>
            ${s.biasReason ? `<div style="grid-column:1/-1"><div class="signal-field-label">Reason</div><div class="signal-field-value" style="font-size:11px;color:var(--text-secondary)">${s.biasReason}</div></div>` : ''}
            ${s.entryZone ? `<div><div class="signal-field-label">Entry Zone</div><div class="signal-field-value">${s.entryZone}</div></div>` : ''}
            ${s.dol ? `<div><div class="signal-field-label">Draw on Liquidity</div><div class="signal-field-value">${s.dol}</div></div>` : ''}
          </div>
          <div class="signal-timestamp">${timeStr}</div>
        </div>`;
    }).join('');
  }
}

function updateStatsUI(data) {
  if (data.aum) document.getElementById('stat-aum').textContent = '$' + parseFloat(data.aum).toLocaleString();
  if (data.activeBots != null) document.getElementById('stat-bots').textContent = data.activeBots + '/' + BOTS.length;
  if (data.todayPnl != null) {
    const pnl = parseFloat(data.todayPnl);
    const prefix = pnl >= 0 ? '+$' : '-$';
    const el = document.getElementById('stat-pnl');
    el.textContent = prefix + Math.abs(pnl).toLocaleString(undefined, {minimumFractionDigits: 2});
    el.style.color = pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BOTS (Decrypt Labs Tab) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderBotsTab(accounts) {
  const grid = document.getElementById('bots-grid');
  grid.innerHTML = BOTS.map(bot => {
    // Match by exact bot ID first, then by name
    const acc = accounts?.find(a => a.id && a.id === bot.botId) ||
                accounts?.find(a => a.name && a.name.includes(bot.name.split(' ')[0]));
    
    const balance = acc ? parseFloat(acc.balance || acc.equity || 150000) : 150000;
    const pnl = acc ? parseFloat(acc.pnl || acc.todayPnl || 0) : 0;
    const peak = acc ? parseFloat(acc.peakBalance || acc.peak || balance) : balance;
    const startBal = (bot.botId === 'new-300k') ? 300000 : 150000;
    const ddMax = (bot.botId === 'new-300k') ? 7500 : 5000;
    const profitTarget = (bot.botId === 'new-300k') ? 320000 : 159000;
    const profitRange = profitTarget - startBal;
    const threshold = peak - ddMax;
    const drawdownUsed = peak - balance;
    const drawdownPct = Math.min((drawdownUsed / ddMax) * 100, 100);
    const progressPct = Math.min(Math.max(((balance - startBal) / profitRange) * 100, 0), 100);
    const winRate = acc?.winRate || acc?.win_rate || '‚Äî';
    const totalTrades = acc?.totalTrades || acc?.trades || '‚Äî';
    const gaugeClass = drawdownPct > 70 ? 'danger' : drawdownPct > 40 ? 'warning' : 'safe';

    // Generate mini chart bars
    const chartBars = Array.from({length: 20}, () => {
      const val = Math.random() * 100 - 30;
      return `<div class="chart-bar ${val >= 0 ? 'positive' : 'negative'}" style="height:${Math.abs(val) * 0.4}px"></div>`;
    }).join('');

    return `
      <div class="bot-card">
        <div class="bot-card-header">
          <div class="bot-card-avatar">${bot.image ? `<img src="${bot.image}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` : bot.emoji}</div>
          <div style="flex:1">
            <div class="bot-card-name">${bot.name} (${bot.number})</div>
            <div class="bot-card-subtitle">${bot.strategy} ‚Ä¢ ${bot.account}</div>
          </div>
          <span class="status-dot green"></span>
        </div>

        <div class="bot-card-stats">
          <div class="bot-stat">
            <div class="bot-stat-label">Balance</div>
            <div class="bot-stat-value" style="color:var(--accent-cyan)">$${balance.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
          </div>
          <div class="bot-stat">
            <div class="bot-stat-label">Today's P&L</div>
            <div class="bot-stat-value" style="color:${pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">${pnl >= 0 ? '+' : ''}$${pnl.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
          </div>
        </div>

        <div class="mini-chart">${chartBars}</div>

        <div class="progress-section">
          <div class="progress-header">
            <span style="color:var(--text-secondary)">Progress to Funded ($${profitTarget.toLocaleString()})</span>
            <span style="color:var(--accent-cyan)">${progressPct.toFixed(1)}%</span>
          </div>
          <div class="progress-bar"><div class="progress-fill" style="width:${progressPct}%"></div></div>
        </div>

        <div class="drawdown-gauge">
          <div class="gauge-header">
            <span class="gauge-label">Trailing Drawdown (Max $${ddMax.toLocaleString()})</span>
            <span class="gauge-value">$${drawdownUsed.toLocaleString(undefined, {minimumFractionDigits: 2})} used</span>
          </div>
          <div class="gauge-bar"><div class="gauge-fill ${gaugeClass}" style="width:${drawdownPct}%"></div></div>
          <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-dim);margin-top:4px">
            <span>Threshold: $${threshold.toLocaleString(undefined, {minimumFractionDigits: 0})}</span>
            <span>Remaining: $${(ddMax - drawdownUsed).toLocaleString(undefined, {minimumFractionDigits: 2})}</span>
          </div>
        </div>

        <div class="bot-card-footer">
          <span>Win Rate: ${winRate}${typeof winRate === 'number' ? '%' : ''}</span>
          <span>Trades: ${totalTrades}</span>
          <span>${bot.strategy}</span>
          ${bot.tokenId !== undefined ? `<span title="NFT Token ID">Token #${bot.tokenId}</span>` : ''}
        </div>

        <p style="font-size:11px;color:var(--text-dim);margin-top:12px;line-height:1.5">${bot.desc}</p>
      </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê KANBAN (PERSISTENT) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadKanbanTasks() {
  try {
    const saved = localStorage.getItem('decrypt-kanban-tasks');
    if (saved) {
      const parsed = JSON.parse(saved);
      if (Array.isArray(parsed) && parsed.length > 0) return parsed;
    }
  } catch(e) {}
  return [...DEFAULT_TASKS];
}

async function loadKanbanFromAPI() {
  try {
    const res = await fetch('/api/kanban-tasks');
    if (res.ok) {
      const data = await res.json();
      if (Array.isArray(data) && data.length > 0) {
        localStorage.setItem('decrypt-kanban-tasks', JSON.stringify(data));
        return data;
      }
    }
  } catch(e) { console.warn('Kanban API load failed, using localStorage'); }
  const local = loadKanbanTasks();
  // Push local to API as initial sync
  fetch('/api/kanban-tasks', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(local) }).catch(() => {});
  return local;
}

async function saveKanbanTasks() {
  localStorage.setItem('decrypt-kanban-tasks', JSON.stringify(kanbanTasks));
  try {
    await fetch('/api/kanban-tasks', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(kanbanTasks) });
  } catch(e) { console.warn('Kanban API save failed ‚Äî saved locally'); }
}

function renderKanban() {
  const columns = { todo: [], 'in-progress': [], done: [], blocked: [] };
  kanbanTasks.forEach(t => {
    if (columns[t.column]) columns[t.column].push(t);
  });

  Object.keys(columns).forEach(col => {
    const el = document.getElementById('col-' + col);
    document.getElementById('count-' + col).textContent = columns[col].length;
    el.innerHTML = columns[col].map(t => `
      <div class="task-card" draggable="true" data-task-id="${t.id}" onclick="editKanbanTask(${t.id})">
        <div class="task-title">${escapeHtml(t.title)}</div>
        <div class="task-desc">${escapeHtml(t.desc)}</div>
        <div class="task-meta">
          <span class="task-tag ${t.priority}">${t.priority}</span>
          <span class="task-assignee">${escapeHtml(t.assignee)}</span>
        </div>
      </div>
    `).join('');
  });

  setupDragDrop();
}

function setupDragDrop() {
  let draggedId = null;

  document.querySelectorAll('.task-card').forEach(card => {
    card.addEventListener('dragstart', (e) => {
      draggedId = parseInt(card.dataset.taskId);
      card.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      // Prevent click from firing after drag
      card._dragged = true;
    });
    card.addEventListener('dragend', () => {
      card.classList.remove('dragging');
      setTimeout(() => { card._dragged = false; }, 50);
    });
    // Override click so drag doesn't trigger edit
    const origClick = card.onclick;
    card.onclick = function(e) {
      if (this._dragged) { this._dragged = false; return; }
      if (origClick) origClick.call(this, e);
    };
  });

  document.querySelectorAll('.kanban-items').forEach(col => {
    col.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      const dragging = document.querySelector('.dragging');
      if (dragging) col.appendChild(dragging);
    });

    col.addEventListener('drop', (e) => {
      e.preventDefault();
      if (draggedId == null) return;
      const newColumn = col.id.replace('col-', '');
      const task = kanbanTasks.find(t => t.id === draggedId);
      if (task && task.column !== newColumn) {
        task.column = newColumn;
        saveKanbanTasks();
        renderKanban();
      }
      draggedId = null;
    });
  });
}

function addKanbanTask(column) {
  showKanbanEditModal(-1, { title: '', desc: '', priority: 'medium', assignee: 'Jimmy', column: column || 'todo' });
}

function editKanbanTask(id) {
  const task = kanbanTasks.find(t => t.id === id);
  if (task) showKanbanEditModal(id, task);
}

function showKanbanEditModal(id, task) {
  let overlay = document.getElementById('kanban-edit-overlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'kanban-edit-overlay';
    overlay.className = 'pcal-edit-overlay';
    overlay.innerHTML = '<div class="pcal-edit-modal" id="kanban-edit-modal"></div>';
    overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.classList.remove('active'); });
    document.body.appendChild(overlay);
  }

  const isNew = id === -1;
  const modal = document.getElementById('kanban-edit-modal');
  modal.innerHTML = `
    <h3>${isNew ? '‚ûï New Task' : '‚úèÔ∏è Edit Task'}</h3>
    <label>Title</label>
    <input type="text" id="kb-edit-title" value="${escapeHtml(task.title)}" placeholder="Task title...">
    <label>Description</label>
    <input type="text" id="kb-edit-desc" value="${escapeHtml(task.desc)}" placeholder="Brief description...">
    <label>Priority</label>
    <select id="kb-edit-priority">
      <option value="high" ${task.priority==='high'?'selected':''}>üî¥ High</option>
      <option value="medium" ${task.priority==='medium'?'selected':''}>üü† Medium</option>
      <option value="low" ${task.priority==='low'?'selected':''}>üîµ Low</option>
    </select>
    <label>Assignee</label>
    <select id="kb-edit-assignee">
      <option value="Jimmy" ${task.assignee==='Jimmy'?'selected':''}>üß™ Jimmy</option>
      <option value="DropKing" ${task.assignee==='DropKing'?'selected':''}>üëë DropKing</option>
      <option value="Carl" ${task.assignee==='Carl'?'selected':''}>ü§ì Carl</option>
      <option value="Cindy" ${task.assignee==='Cindy'?'selected':''}>‚ö° Cindy</option>
      <option value="Sheen" ${task.assignee==='Sheen'?'selected':''}>üöÄ Sheen</option>
    </select>
    <label>Column</label>
    <select id="kb-edit-column">
      <option value="todo" ${task.column==='todo'?'selected':''}>üìã To Do</option>
      <option value="in-progress" ${task.column==='in-progress'?'selected':''}>üîß In Progress</option>
      <option value="done" ${task.column==='done'?'selected':''}>‚úÖ Done</option>
      <option value="blocked" ${task.column==='blocked'?'selected':''}>üö´ Blocked</option>
    </select>
    <div class="pcal-edit-actions">
      ${!isNew ? '<button class="pcal-delete-btn" onclick="deleteKanbanTask('+id+')">üóë</button>' : ''}
      <button class="pcal-cancel-btn" onclick="document.getElementById(\'kanban-edit-overlay\').classList.remove(\'active\')">CANCEL</button>
      <button class="pcal-save-btn" onclick="saveKanbanEdit(${id})">SAVE</button>
    </div>
  `;

  overlay.classList.add('active');
  setTimeout(() => document.getElementById('kb-edit-title').focus(), 100);
}

function saveKanbanEdit(id) {
  const title = document.getElementById('kb-edit-title').value.trim();
  const desc = document.getElementById('kb-edit-desc').value.trim();
  const priority = document.getElementById('kb-edit-priority').value;
  const assignee = document.getElementById('kb-edit-assignee').value;
  const column = document.getElementById('kb-edit-column').value;

  if (!title) return;

  if (id === -1) {
    // New task
    kanbanTasks.push({ id: kanbanNextId++, title, desc, priority, assignee, column });
  } else {
    const task = kanbanTasks.find(t => t.id === id);
    if (task) {
      task.title = title;
      task.desc = desc;
      task.priority = priority;
      task.assignee = assignee;
      task.column = column;
    }
  }

  saveKanbanTasks();
  renderKanban();
  document.getElementById('kanban-edit-overlay').classList.remove('active');
}

function deleteKanbanTask(id) {
  if (!confirm('Delete this task?')) return;
  kanbanTasks = kanbanTasks.filter(t => t.id !== id);
  saveKanbanTasks();
  renderKanban();
  document.getElementById('kanban-edit-overlay').classList.remove('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CALENDAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getScheduleForDay(dayIdx) {
  // 0=Sun, 6=Sat ‚Üí weekend; 1-5 ‚Üí weekday
  const isWeekend = (dayIdx === 0 || dayIdx === 6);
  const events = isWeekend ? [...SCHEDULE.weekend] : [...SCHEDULE.weekday];
  if (SCHEDULE.special[dayIdx]) events.push(...SCHEDULE.special[dayIdx]);
  return events;
}

function renderCalendar() {
  const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  const today = new Date().getDay();
  const grid = document.getElementById('calendar-grid');
  
  grid.innerHTML = days.map((day, i) => {
    const events = getScheduleForDay(i);
    const isToday = (i === today);
    const isWeekend = (i === 0 || i === 6);
    
    const eventsHtml = events.map(e => `
      <div class="cal-event ${e.color}" title="${e.agent ? e.agent + ': ' : ''}${e.desc || ''}">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <span>${e.name}</span>
        </div>
        <div class="cal-event-time">${e.time}${e.agent ? ' ¬∑ ' + e.agent : ''}</div>
      </div>
    `).join('');

    return `
      <div class="cal-day${isToday ? ' cal-today' : ''}${isWeekend ? ' cal-weekend' : ''}">
        <div class="cal-day-name">${day}${isToday ? ' ‚ú¶' : ''}</div>
        ${isWeekend ? '<div style="font-size:9px;color:rgba(255,255,255,0.2);margin-bottom:4px;">Markets Closed</div>' : ''}
        ${eventsHtml}
      </div>
    `;
  }).join('');

  updateCountdowns();
}

function updateCountdowns() {
  const container = document.getElementById('countdown-list');
  const now = new Date();
  const today = now.getDay();
  
  const upcoming = [];
  
  for (let dayOffset = 0; dayOffset < 7; dayOffset++) {
    const dayIdx = (today + dayOffset) % 7;
    const events = getScheduleForDay(dayIdx);
    
    events.forEach(e => {
      const eventDate = new Date(now);
      eventDate.setDate(eventDate.getDate() + dayOffset);
      eventDate.setHours(e.hour, e.min, 0, 0);
      
      if (eventDate > now) {
        const diff = eventDate - now;
        const hours = Math.floor(diff / 3600000);
        const mins = Math.floor((diff % 3600000) / 60000);
        let timeStr;
        if (hours > 48) {
          timeStr = `in ${Math.floor(hours / 24)} days`;
        } else if (hours > 0) {
          timeStr = `in ${hours}h ${mins}m`;
        } else {
          timeStr = `in ${mins} min`;
        }
        
        upcoming.push({
          name: e.name,
          color: e.color,
          agent: e.agent || '',
          timeStr,
          diff
        });
      }
    });
  }
  
  upcoming.sort((a, b) => a.diff - b.diff);
  
  container.innerHTML = upcoming.slice(0, 8).map(u => {
    const colorMap = { cyan: 'var(--accent-cyan)', green: 'var(--accent-green)', purple: 'var(--accent-purple)', orange: 'var(--accent-orange)', red: 'var(--accent-red)', yellow: 'var(--accent-yellow)' };
    return `
      <div class="countdown-item">
        <div class="countdown-label">
          <span class="dot" style="background:${colorMap[u.color] || 'var(--text-dim)'}"></span>
          ${u.name}${u.agent ? ' <span style="color:rgba(255,255,255,0.3);font-size:10px;">(' + u.agent + ')</span>' : ''}
        </div>
        <div class="countdown-value">${u.timeStr}</div>
      </div>
    `;
  }).join('');
}

// Upcoming schedule on mission control
function renderUpcomingSchedule() {
  const container = document.getElementById('upcoming-schedule');
  const now = new Date();
  const today = now.getDay();
  const upcoming = [];
  
  for (let dayOffset = 0; dayOffset < 2; dayOffset++) {
    const dayIdx = (today + dayOffset) % 7;
    const events = getScheduleForDay(dayIdx);
    
    events.forEach(e => {
      const eventDate = new Date(now);
      eventDate.setDate(eventDate.getDate() + dayOffset);
      eventDate.setHours(e.hour, e.min, 0, 0);
      
      if (eventDate > now) {
        const diff = eventDate - now;
        const hours = Math.floor(diff / 3600000);
        const mins = Math.floor((diff % 3600000) / 60000);
        let timeStr = hours > 0 ? `in ${hours}h ${mins}m` : `in ${mins} min`;
        
        upcoming.push({ name: e.name, agent: e.agent || '', timeStr, diff });
      }
    });
  }
  
  upcoming.sort((a, b) => a.diff - b.diff);
  
  container.innerHTML = upcoming.slice(0, 6).map(u => `
    <div class="upcoming-task">
      <span class="upcoming-task-name">${u.name}${u.agent ? ' <span style="opacity:0.4;font-size:10px;">(' + u.agent + ')</span>' : ''}</span>
      <span class="upcoming-task-time">${u.timeStr}</span>
    </div>
  `).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function init() {
  // Load kanban from API (async), render with defaults first
  kanbanTasks = loadKanbanTasks();
  kanbanNextId = Math.max(...kanbanTasks.map(t => t.id || 0), 99) + 1;
  renderKanban();
  loadKanbanFromAPI().then(data => {
    kanbanTasks = data;
    kanbanNextId = Math.max(...kanbanTasks.map(t => t.id || 0), 99) + 1;
    renderKanban();
  });

  // ‚ïê‚ïê‚ïê Pipeline Status Updater ‚ïê‚ïê‚ïê
  async function updatePipelineStatus() {
    try {
      // Check Caretaker health (Step 2)
      const healthRes = await fetch('/health', { signal: AbortSignal.timeout(5000) }).catch(() => null);
      const step2El = document.getElementById('pipe-step2-status');
      if (healthRes && healthRes.ok) {
        step2El.innerHTML = '<span class="status-dot green"></span> Online';
        step2El.style.background = 'rgba(0,255,136,0.08)';
      } else {
        step2El.innerHTML = '<span class="status-dot red"></span> Offline';
        step2El.style.background = 'rgba(255,68,68,0.08)';
      }

      // Check ICT signals count & last signal time (Steps 1 & 5)
      const sigRes = await fetch('/api/signals/ict', { signal: AbortSignal.timeout(5000) }).catch(() => null);
      if (sigRes && sigRes.ok) {
        const signals = await sigRes.json();
        const sigArray = Array.isArray(signals) ? signals : (signals.signals || []);
        document.getElementById('pipe-signal-count').textContent = sigArray.length;
        
        if (sigArray.length > 0) {
          const latest = sigArray[sigArray.length - 1];
          const ts = latest.timestamp || latest.receivedAt || latest.ts;
          if (ts) {
            const d = new Date(ts);
            const ago = Math.floor((Date.now() - d.getTime()) / 60000);
            let agoStr = ago < 60 ? `${ago}m ago` : ago < 1440 ? `${Math.floor(ago/60)}h ago` : `${Math.floor(ago/1440)}d ago`;
            document.getElementById('pipe-last-signal-time').textContent = d.toLocaleTimeString() + ` (${agoStr})`;
          }
        } else {
          document.getElementById('pipe-last-signal-time').textContent = 'No signals yet';
        }
        
        // Step 5 status
        const step5El = document.getElementById('pipe-step5-status');
        step5El.innerHTML = `<span class="status-dot green"></span> ${sigArray.length} signals`;
        step5El.style.background = 'rgba(170,102,255,0.08)';
      }
    } catch(e) {
      console.warn('Pipeline status check failed:', e);
    }
  }

  // Render static content
  renderCalendar();
  renderUpcomingSchedule();
  renderBotsTab([]); // Render with defaults
  updatePipelineStatus(); // Initial pipeline status check

  // Fetch live data
  fetchData();

  // Auto-refresh every 30 seconds
  setInterval(() => {
    fetchData();
    updateCountdowns();
    renderUpcomingSchedule();
    updatePipelineStatus();
  }, 30000);

  // Update countdowns every minute
  setInterval(() => {
    updateCountdowns();
    renderUpcomingSchedule();
  }, 60000);
}

init();

// ‚ïê‚ïê‚ïê GODDARD TAB ‚ïê‚ïê‚ïê
const GD_API = window.location.origin;

async function loadGoddardTab() {
  await Promise.all([
    loadGoddardRiskState(),
    loadGoddardNewsFeed(),
    loadGoddardRiskRules(),
    loadGoddardCronSchedule()
  ]);
}

async function loadGoddardRiskState() {
  try {
    const res = await fetch(`${GD_API}/api/goddard/risk-state`);
    if (!res.ok) return;
    const state = await res.json();
    if (!state || !state.accounts) return;

    // Risk level
    const badge = document.getElementById('gd-risk-badge');
    let maxDD = 0;
    let totalBal = 0;
    let totalWeeklyPnl = 0;
    const accts = state.accounts;
    
    for (const [id, a] of Object.entries(accts)) {
      maxDD = Math.max(maxDD, a.drawdownPct || 0);
      totalBal += a.currentBalance || 0;
      totalWeeklyPnl += a.weeklyPnL || 0;
    }

    if (maxDD > 80) { badge.textContent = 'üî¥ CRITICAL'; badge.style.color = '#ff4444'; }
    else if (maxDD > 60) { badge.textContent = 'üü° CAUTION'; badge.style.color = '#ffaa00'; }
    else { badge.textContent = 'üü¢ GREEN'; badge.style.color = '#00ff88'; }

    document.getElementById('gd-aum').textContent = '$' + totalBal.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
    
    const pnlEl = document.getElementById('gd-weekly-pnl');
    pnlEl.textContent = (totalWeeklyPnl >= 0 ? '+' : '') + '$' + totalWeeklyPnl.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
    pnlEl.style.color = totalWeeklyPnl >= 0 ? '#00ff88' : '#ff4444';

    document.getElementById('gd-week-start').textContent = state.weekStart || '‚Äî';
    document.getElementById('gd-last-updated').textContent = 'Last updated: ' + (state.lastUpdated ? new Date(state.lastUpdated).toLocaleString() : 'Unknown');

    // Bot cards
    const cardsEl = document.getElementById('gd-bot-cards');
    cardsEl.innerHTML = '';
    for (const [id, a] of Object.entries(accts)) {
      const isActive = a.status === 'ACTIVE';
      const ddColor = a.drawdownPct > 60 ? '#ff4444' : a.drawdownPct > 40 ? '#ffaa00' : '#00ff88';
      const statusColor = isActive ? '#00ff88' : '#ff4444';
      const pnlColor = (a.weeklyPnL || 0) >= 0 ? '#00ff88' : '#ff4444';
      cardsEl.innerHTML += `
        <div style="background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;padding:16px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
            <span style="font-weight:600;font-size:13px;">${a.nftName || id}</span>
            <span style="font-size:11px;padding:3px 8px;border-radius:6px;background:${isActive ? 'rgba(0,255,136,0.1)' : 'rgba(255,68,68,0.1)'};color:${statusColor};font-weight:600;">${a.status}</span>
          </div>
          <div style="font-size:11px;color:var(--text-dim);margin-bottom:6px;">${a.botName} ‚Ä¢ ${id}</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;">
            <div>
              <div style="font-size:10px;color:var(--text-dim);">Balance</div>
              <div style="font-size:13px;font-family:'SF Mono',monospace;">$${(a.currentBalance||0).toLocaleString('en-US',{minimumFractionDigits:2})}</div>
            </div>
            <div>
              <div style="font-size:10px;color:var(--text-dim);">Weekly P&L</div>
              <div style="font-size:13px;font-family:'SF Mono',monospace;color:${pnlColor};">${(a.weeklyPnL||0) >= 0 ? '+' : ''}$${(a.weeklyPnL||0).toFixed(2)}</div>
            </div>
            <div>
              <div style="font-size:10px;color:var(--text-dim);">Drawdown</div>
              <div style="font-size:13px;font-family:'SF Mono',monospace;color:${ddColor};">${(a.drawdownPct||0).toFixed(1)}%</div>
            </div>
            <div>
              <div style="font-size:10px;color:var(--text-dim);">DD Remaining</div>
              <div style="font-size:13px;font-family:'SF Mono',monospace;">$${((a.drawdownMax||5000) - (a.drawdownUsed||0)).toLocaleString('en-US',{minimumFractionDigits:0})}</div>
            </div>
          </div>
          ${a.pauseReason ? `<div style="margin-top:8px;padding:6px 10px;background:rgba(255,68,68,0.08);border-radius:6px;font-size:11px;color:#ff8888;">‚ö†Ô∏è ${a.pauseReason}</div>` : ''}
        </div>
      `;
    }

    // Action log
    if (state.actions && state.actions.length > 0) {
      const logEl = document.getElementById('gd-action-log');
      logEl.innerHTML = state.actions.slice(0, 20).map(a => `
        <div style="padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.04);display:flex;gap:12px;">
          <span style="color:var(--text-dim);white-space:nowrap;min-width:140px;">${new Date(a.timestamp).toLocaleString()}</span>
          <span style="color:var(--accent-cyan);min-width:80px;font-weight:600;">${a.action}</span>
          <span style="color:var(--text-secondary);">${a.details || ''}</span>
        </div>
      `).join('');
    }

  } catch(e) {
    console.error('Failed to load Goddard risk state:', e);
  }
}

async function loadGoddardNewsFeed() {
  try {
    const res = await fetch(`${GD_API}/api/goddard/news-feed`);
    if (!res.ok) return;
    const data = await res.json();
    const feedEl = document.getElementById('gd-news-feed');
    
    if (!data.entries || data.entries.length === 0) {
      feedEl.innerHTML = '<div style="color:var(--text-dim);font-size:13px;font-style:italic;padding:20px;text-align:center;">No news analysis yet. Goddard will post his first briefing at 4:30 AM PT.</div>';
      return;
    }

    feedEl.innerHTML = data.entries.map(e => {
      const impactColor = e.impact === 'HIGH' ? '#ff4444' : e.impact === 'MEDIUM' ? '#ffaa00' : '#00ff88';
      return `
        <div style="padding:12px;margin-bottom:8px;background:rgba(255,255,255,0.02);border-radius:10px;border-left:3px solid ${impactColor};">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
            <span style="font-weight:600;font-size:13px;">${e.title || 'Analysis'}</span>
            <span style="font-size:10px;color:var(--text-dim);">${e.timestamp ? new Date(e.timestamp).toLocaleString() : ''}</span>
          </div>
          ${e.impact ? `<span style="font-size:10px;padding:2px 6px;border-radius:4px;background:${impactColor}22;color:${impactColor};font-weight:600;margin-bottom:6px;display:inline-block;">${e.impact} IMPACT</span>` : ''}
          <div style="font-size:12px;color:var(--text-secondary);line-height:1.5;margin-top:4px;white-space:pre-wrap;">${e.analysis || e.text || ''}</div>
          ${e.recommendation ? `<div style="margin-top:8px;padding:6px 10px;background:rgba(0,212,255,0.06);border-radius:6px;font-size:11px;color:var(--accent-cyan);">üìã ${e.recommendation}</div>` : ''}
        </div>
      `;
    }).join('');
  } catch(e) {
    console.error('Failed to load Goddard news feed:', e);
  }
}

async function loadGoddardRiskRules() {
  try {
    const res = await fetch(`${GD_API}/api/goddard/risk-rules`);
    if (!res.ok) return;
    const data = await res.json();
    document.getElementById('gd-risk-rules').value = data.rules || '';
  } catch(e) {
    console.error('Failed to load risk rules:', e);
  }
}

async function saveGoddardRiskRules() {
  try {
    const rules = document.getElementById('gd-risk-rules').value;
    const res = await fetch(`${GD_API}/api/goddard/risk-rules`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ rules })
    });
    if (res.ok) {
      showToast('‚úÖ Risk rules saved ‚Äî Goddard will use these next run');
    } else {
      showToast('‚ùå Failed to save risk rules');
    }
  } catch(e) {
    showToast('‚ùå Error saving: ' + e.message);
  }
}

async function loadGoddardCronSchedule() {
  try {
    const res = await fetch(`${GD_API}/api/goddard/cron-schedule`);
    if (!res.ok) return;
    const data = await res.json();
    const el = document.getElementById('gd-cron-schedule');
    
    if (!data.jobs || data.jobs.length === 0) {
      el.innerHTML = '<div style="color:var(--text-dim);font-style:italic;">No cron jobs configured</div>';
      return;
    }

    el.innerHTML = data.jobs.map((job, i) => `
      <div style="background:var(--bg-card);border:1px solid var(--border-color);border-radius:10px;padding:14px;margin-bottom:10px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <span style="font-weight:600;font-size:13px;">${job.name}</span>
          <span style="font-size:11px;padding:3px 8px;border-radius:6px;background:${job.enabled ? 'rgba(0,255,136,0.1)' : 'rgba(255,68,68,0.1)'};color:${job.enabled ? '#00ff88' : '#ff4444'};font-weight:600;">${job.enabled ? 'ENABLED' : 'DISABLED'}</span>
        </div>
        <div style="font-size:11px;color:var(--text-dim);margin-bottom:8px;">${job.description || ''}</div>
        <div style="display:flex;gap:10px;align-items:center;">
          <label style="font-size:11px;color:var(--text-secondary);">Cron:</label>
          <input type="text" value="${job.cron}" data-cron-idx="${i}" style="background:rgba(0,0,0,0.3);border:1px solid var(--border-color);border-radius:6px;padding:4px 8px;color:var(--text-primary);font-family:'SF Mono',monospace;font-size:12px;width:160px;">
          <label style="font-size:11px;color:var(--text-secondary);">TZ:</label>
          <input type="text" value="${job.tz || 'America/Los_Angeles'}" data-tz-idx="${i}" style="background:rgba(0,0,0,0.3);border:1px solid var(--border-color);border-radius:6px;padding:4px 8px;color:var(--text-primary);font-family:'SF Mono',monospace;font-size:12px;width:180px;">
          <button onclick="toggleGoddardCron(${i})" style="background:rgba(255,255,255,0.06);border:1px solid var(--border-color);color:var(--text-secondary);padding:4px 10px;border-radius:6px;cursor:pointer;font-size:11px;">${job.enabled ? '‚è∏ Pause' : '‚ñ∂ Enable'}</button>
        </div>
      </div>
    `).join('') + `
      <div style="text-align:right;margin-top:10px;">
        <button onclick="saveGoddardCronSchedule()" style="background:rgba(0,212,255,0.15);border:1px solid rgba(0,212,255,0.3);color:var(--accent-cyan);padding:8px 20px;border-radius:8px;cursor:pointer;font-weight:600;font-size:12px;">üíæ Save Schedule</button>
      </div>
    `;
    
    // Store for saving
    window._goddardCronJobs = data.jobs;
  } catch(e) {
    console.error('Failed to load cron schedule:', e);
  }
}

function toggleGoddardCron(idx) {
  if (window._goddardCronJobs && window._goddardCronJobs[idx]) {
    window._goddardCronJobs[idx].enabled = !window._goddardCronJobs[idx].enabled;
    loadGoddardCronSchedule(); // Re-render
  }
}

async function saveGoddardCronSchedule() {
  try {
    if (!window._goddardCronJobs) return;
    // Read updated cron expressions from inputs
    document.querySelectorAll('[data-cron-idx]').forEach(input => {
      const idx = parseInt(input.getAttribute('data-cron-idx'));
      if (window._goddardCronJobs[idx]) window._goddardCronJobs[idx].cron = input.value;
    });
    document.querySelectorAll('[data-tz-idx]').forEach(input => {
      const idx = parseInt(input.getAttribute('data-tz-idx'));
      if (window._goddardCronJobs[idx]) window._goddardCronJobs[idx].tz = input.value;
    });

    const res = await fetch(`${GD_API}/api/goddard/cron-schedule`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ jobs: window._goddardCronJobs })
    });
    if (res.ok) {
      showToast('‚úÖ Cron schedule saved');
    } else {
      showToast('‚ùå Failed to save schedule');
    }
  } catch(e) {
    showToast('‚ùå Error: ' + e.message);
  }
}

function showToast(msg) {
  let toast = document.getElementById('gd-toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'gd-toast';
    toast.style.cssText = 'position:fixed;bottom:30px;right:30px;background:#1a1a2e;border:1px solid rgba(0,212,255,0.3);color:var(--text-primary);padding:12px 20px;border-radius:10px;font-size:13px;z-index:9999;transition:opacity 0.3s;box-shadow:0 4px 20px rgba(0,0,0,0.4);';
    document.body.appendChild(toast);
  }
  toast.textContent = msg;
  toast.style.opacity = '1';
  setTimeout(() => { toast.style.opacity = '0'; }, 3000);
}

// Load Goddard tab when nav is clicked
document.querySelectorAll('.nav-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    if (tab.getAttribute('data-tab') === 'goddard') {
      loadGoddardTab();
    }
  });
});

// ‚ïê‚ïê‚ïê EDITABLE EXPENSES ‚ïê‚ïê‚ïê
const DEFAULT_EXPENSES = [
  { cat: 'business', name: 'IRS Tax', note: 'Payment plan', cost: 112.00, dueDay: 1 },
  { cat: 'business', name: 'APEX-18 Renewal', note: 'Account #18', cost: 50.00, dueDay: 2 },
  { cat: 'business', name: 'APEX-19/20 Renewal', note: 'Accounts #19 & #20', cost: 156.80, dueDay: 4 },
  { cat: 'personal', name: 'Self Storage', note: 'Hesperia unit', cost: 178.00, dueDay: 3 },
  { cat: 'personal', name: 'Upgrade Inc Loan', note: 'Loan repayment', cost: 524.76, dueDay: 7 },
  { cat: 'business', name: 'Spline Design', note: '3D design tool', cost: 30.00, dueDay: 26 },
  { cat: 'business', name: 'APEX-21 Renewal', note: 'Account #21 (300K)', cost: 78.40, dueDay: 27 },
  { cat: 'business', name: 'Anthropic', note: 'Claude AI API', cost: 20.00, dueDay: 30 },
  { cat: 'personal', name: 'Verizon Wireless', note: 'Phone plan', cost: 173.37, dueDay: 20 },
  { cat: 'business', name: 'TradersPost', note: 'Webhook automation', cost: 41.40 },
  { cat: 'business', name: 'TradingView', note: 'Charts & alerts', cost: 7.00 },
  { cat: 'business', name: 'Railway Hosting', note: 'Caretaker API server', cost: 5.00 },
  { cat: 'business', name: 'ElevenLabs TTS', note: 'Starter plan ‚Äî voiceovers', cost: 5.00 },
  { cat: 'business', name: 'OpenClaw API', note: "Jimmy's brain", cost: 40.00 },
  { cat: 'business', name: 'Cloudflare Pages', note: 'decryptlabs.io hosting', cost: 0 },
  { cat: 'personal', name: 'Starlink', note: 'Internet', cost: 165.00 },
  { cat: 'personal', name: 'Root Insurance', note: 'Auto insurance', cost: 155.97 },
  { cat: 'personal', name: 'Affirm', note: 'Payment plan', cost: 67.50 },
  { cat: 'personal', name: 'Amazon Prime', note: 'Membership', cost: 16.15 },
  { cat: 'personal', name: 'Apple', note: 'iCloud / subscriptions', cost: 3.99 },
  { cat: 'personal', name: 'Samsung', note: 'Samsung subscription', cost: 0.99 },
];

function loadExpenses() {
  try {
    const saved = localStorage.getItem('decrypt-expenses');
    return saved ? JSON.parse(saved) : [...DEFAULT_EXPENSES];
  } catch(e) { return [...DEFAULT_EXPENSES]; }
}

async function loadExpensesFromAPI() {
  try {
    const res = await fetch('/api/expenses');
    if (res.ok) {
      const data = await res.json();
      if (Array.isArray(data) && data.length > 0) {
        localStorage.setItem('decrypt-expenses', JSON.stringify(data));
        renderExpenses(); // Re-render immediately
        renderBillsCalendar(); // Re-render calendar too
        return data;
      }
    }
  } catch(e) { console.warn('API expenses load failed, using localStorage fallback'); }
  return loadExpenses();
}

async function saveExpenses() {
  const rows = document.querySelectorAll('#expense-body tr[data-idx]');
  const expenses = [];
  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    const costText = cells[3].textContent.replace(/[^0-9.]/g, '');
    const dueInput = row.querySelector('.due-input');
    expenses.push({
      cat: row.dataset.cat,
      name: cells[0].textContent.trim(),
      note: cells[1].textContent.trim(),
      dueDay: dueInput ? parseInt(dueInput.value) || null : null,
      cost: parseFloat(costText) || 0
    });
  });
  // Save to localStorage as cache
  localStorage.setItem('decrypt-expenses', JSON.stringify(expenses));
  // Update UI immediately
  renderExpenses(); 
  renderBillsCalendar();
  
  // Save to server
  try {
    const res = await fetch('/api/expenses', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(expenses) });
    if (res.ok) {
      showToast('‚úÖ Expenses saved & calendar updated');
    } else {
      showToast('‚ö†Ô∏è Saved locally but server save failed');
    }
  } catch(e) {
    showToast('‚ö†Ô∏è Saved locally but server unreachable');
  }
}

function addExpenseRow(cat) {
  const expenses = loadExpenses();
  expenses.push({ cat, name: 'New Item', note: 'Description', cost: 0 });
  localStorage.setItem('decrypt-expenses', JSON.stringify(expenses));
  renderExpenses();
}

function removeExpenseRow(idx) {
  if (!confirm('Remove this expense?')) return;
  const expenses = loadExpenses();
  expenses.splice(idx, 1);
  localStorage.setItem('decrypt-expenses', JSON.stringify(expenses));
  renderExpenses();
  renderBillsCalendar();
}

function renderExpenses() {
  const expenses = loadExpenses();
  const tbody = document.getElementById('expense-body');
  if (!tbody) return;
  let html = '';
  let bizTotal = 0, persTotal = 0;
  let lastCat = '';

  expenses.forEach((exp, i) => {
    if (exp.cat !== lastCat) {
      const label = exp.cat === 'business' ? 'üîß Business / Trading' : 'üè† Personal / Bills';
      const color = exp.cat === 'business' ? 'var(--accent-cyan)' : 'var(--accent-purple)';
      html += '<tr><td colspan="5" style="color:' + color + ';font-weight:600;padding-top:12px;">' + label + '</td></tr>';
      lastCat = exp.cat;
    }
    const costDisplay = exp.cost === 0 ? '<span class="expense-free">Free</span>' : '$' + exp.cost.toFixed(2);
    if (exp.cat === 'business') bizTotal += exp.cost;
    else persTotal += exp.cost;
    
    html += '<tr data-idx="' + i + '" data-cat="' + exp.cat + '" id="exp-row-' + i + '">';
    html += '<td class="expense-name" contenteditable="true">' + exp.name + '</td>';
    html += '<td class="expense-note" contenteditable="true">' + exp.note + '</td>';
    html += '<td style="text-align:center;"><input type="number" class="due-input" value="' + (exp.dueDay || '') + '" min="1" max="31" placeholder="-" style="width:40px;background:rgba(255,255,255,0.05);border:1px solid var(--border-color);border-radius:4px;color:var(--text-primary);text-align:center;padding:4px;font-size:12px;"></td>';
    html += '<td contenteditable="true">' + costDisplay + '</td>';
    html += '<td><button class="expense-btn remove" onclick="removeExpenseRow(' + i + ')">‚úï</button></td>';
    html += '</tr>';
  });

  tbody.innerHTML = html;

  const totalsDiv = document.getElementById('expense-totals');
  if (totalsDiv) {
    totalsDiv.innerHTML = '<div><div class="expense-total-label" style="font-size:11px;color:var(--accent-cyan);">Business</div><div class="expense-total-value" style="font-size:18px;">$' + bizTotal.toFixed(2) + '/mo</div></div>' +
      '<div><div class="expense-total-label" style="font-size:11px;color:var(--accent-purple);">Personal</div><div class="expense-total-value" style="font-size:18px;">$' + persTotal.toFixed(2) + '/mo</div></div>' +
      '<div><div class="expense-total-label">Total</div><div class="expense-total-value" style="font-size:22px;">$' + (bizTotal + persTotal).toFixed(2) + '/mo</div></div>';
  }
}

function highlightExpense(idx) {
  const row = document.getElementById('exp-row-' + idx);
  if (row) {
    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
    row.style.background = 'rgba(0,255,136,0.15)';
    row.style.transition = 'background 0.5s';
    setTimeout(() => { row.style.background = 'transparent'; }, 2000);
  }
}

renderExpenses();
loadExpensesFromAPI().then(data => { renderExpenses(); });

// ‚ïê‚ïê‚ïê LAUNCH TO-DO WITH INPUT FIELDS ‚ïê‚ïê‚ïê
const LAUNCH_TASKS = [
  { section: 'done', label: '‚úÖ DONE (JIMMY)', color: 'var(--accent-cyan)', items: [
    { id: 'done-1', text: 'Agent profile written (name, pitch, FAQ)', done: true },
    { id: 'done-2', text: 'Profile picture locked (Jimmy avatar)', done: true },
    { id: 'done-3', text: '7-day X content plan', done: true },
    { id: 'done-4', text: 'Launch announcement drafts (X + Discord)', done: true },
    { id: 'done-5', text: 'Launch checklist (step-by-step)', done: true },
    { id: 'done-6', text: 'Pitch video final cut (82s)', done: true },
    { id: 'done-7', text: 'Website fully wired + deployed', done: true },
    { id: 'done-8', text: 'ICT analysis pipeline built', done: true },
    { id: 'done-9', text: 'Permanent webhook URL (Railway)', done: true },
    { id: 'done-10', text: 'Mission Control dashboard', done: true },
    { id: 'done-11', text: 'Security lockdown (.gitignore, auth)', done: true },
  ]},
  { section: 'dropking', label: '‚è≥ NEEDS DROPKING', color: 'var(--accent-orange)', items: [
    { id: 'dk-1', text: 'Fund wallet with $VIRTUAL on Base', done: false },
    { id: 'dk-2', text: 'Pre-buy budget decision (~$1,700-$2,700)', done: false },
    { id: 'dk-3', text: 'Create agent on app.virtuals.io', done: false },
    { id: 'dk-4', text: 'Pick launch day (Tue/Wed rec)', done: false },
    { id: 'dk-5', text: 'Upload pitch video to X/YouTube', done: false },
    { id: 'dk-6', text: 'Review launch tweets', done: false },
  ]},
  { section: 'post', label: 'üìã POST-LAUNCH (JIMMY)', color: 'var(--accent-green)', items: [
    { id: 'pl-1', text: 'Deploy contracts to Base Mainnet', done: false },
    { id: 'pl-2', text: 'Update X bio with contract address', done: false },
    { id: 'pl-3', text: 'Submit CoinGecko listing', done: false },
    { id: 'pl-4', text: 'Submit CoinMarketCap listing', done: false },
    { id: 'pl-5', text: 'First buyback & burn transaction', done: false },
    { id: 'pl-6', text: 'Run ICT pipeline ‚Üí post on @Decrypt_Labs', done: false },
  ]}
];

function loadTodoState() {
  try {
    return JSON.parse(localStorage.getItem('launch-todo-state') || '{}');
  } catch(e) { return {}; }
}

function saveTodoState(state) {
  localStorage.setItem('launch-todo-state', JSON.stringify(state));
}

function sendToJimmy(taskId, taskText, note) {
  // POST to caretaker which logs it ‚Äî Jimmy polls this
  fetch('/api/todo-update', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ taskId, task: taskText, note, timestamp: new Date().toISOString() })
  }).catch(() => {});
}

function renderLaunchTodo() {
  const container = document.getElementById('launch-todo');
  if (!container) return;
  const todoState = loadTodoState();

  let leftHtml = '';
  let rightHtml = '';

  LAUNCH_TASKS.forEach(section => {
    const sectionHtml = `<div style="font-size:11px;color:${section.color};font-weight:600;margin-bottom:8px;${section.section === 'post' ? 'margin-top:16px;' : ''}font-family:'Orbitron',sans-serif;">${section.label}</div>`;

    let itemsHtml = sectionHtml;
    section.items.forEach(item => {
      const saved = todoState[item.id] || {};
      const isDone = saved.done || item.done;
      const check = isDone ? '‚úÖ' : '‚¨ú';
      
      itemsHtml += `<div class="project-item" style="flex-direction:column;align-items:stretch;">
        <div style="display:flex;align-items:center;gap:8px;">
          <span class="project-check" style="cursor:pointer;" onclick="toggleTodo('${item.id}')">${check}</span>
          <span class="project-name" style="${isDone ? 'text-decoration:line-through;opacity:0.5;' : ''}">${item.text}</span>
          ${saved.sent ? '<span class="todo-sent-badge">‚úì Sent</span>' : ''}
        </div>`;

      if (!isDone) {
        const noteVal = saved.note || '';
        itemsHtml += `<input class="todo-note-input" 
          placeholder="Add notes and press Enter to notify Jimmy..."
          value="${noteVal.replace(/"/g, '&quot;')}"
          data-id="${item.id}" data-text="${item.text.replace(/"/g, '&quot;')}"
          onkeydown="if(event.key==='Enter')submitTodoNote(this)">`;
        if (saved.sent && saved.note) {
          itemsHtml += `<div class="todo-note-saved">Last sent: "${saved.note}"</div>`;
        }
      }
      itemsHtml += '</div>';
    });

    if (section.section === 'done') {
      leftHtml += itemsHtml;
    } else {
      rightHtml += itemsHtml;
    }
  });

  container.innerHTML = `<div>${leftHtml}</div><div>${rightHtml}</div>`;
}

function toggleTodo(id) {
  const state = loadTodoState();
  state[id] = state[id] || {};
  state[id].done = !state[id].done;
  saveTodoState(state);
  renderLaunchTodo();
}

function submitTodoNote(input) {
  const id = input.dataset.id;
  const text = input.dataset.text;
  const note = input.value.trim();
  if (!note) return;

  const state = loadTodoState();
  state[id] = state[id] || {};
  state[id].note = note;
  state[id].sent = true;
  state[id].sentAt = new Date().toISOString();
  saveTodoState(state);

  sendToJimmy(id, text, note);
  
  input.style.borderColor = 'var(--accent-green)';
  input.style.background = 'rgba(0,255,136,0.08)';
  setTimeout(() => {
    input.style.borderColor = '';
    input.style.background = '';
    renderLaunchTodo();
  }, 1500);
}

renderLaunchTodo();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ACCESS CONTROL & WALLET SCANNER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const AC_API_BASE = 'https://decrypt-caretaker-production.up.railway.app';
const AC_CONTRACTS = {
  cipher: "0x743EBDfcED2dBA082E282689c35D5c0E173C7728",
  tierGate: "0x08c7C46434B8d0c5cEa538278711df0051C0fCA1"
};
const AC_TIER_THRESHOLDS = { bronze: 100000, gold: 500000, diamond: 1300000 };
const AC_STRATEGY_NAMES = ['OTE Silver Bullet', 'FVG+IFVG', 'OTE Aggressive', 'OTE Conservative'];
const AC_ERC20_ABI = ["function balanceOf(address) view returns (uint256)"];
const AC_TIERGATE_ABI = ["function getUserTier(address) view returns (uint8)"];

let acProvider = null;
let acAccessRequests = [];
let acApprovedUsers = [];
let acWalletScanResults = [];

async function acInitProvider() {
  try {
    acProvider = new ethers.JsonRpcProvider('https://mainnet.base.org');
  } catch (e) {
    console.log('AC Provider init failed:', e);
  }
}
acInitProvider();

async function acRefreshRequests() {
  try {
    const res = await fetch(`${AC_API_BASE}/api/access-requests`);
    if (res.ok) {
      const data = await res.json();
      acAccessRequests = data.pending || [];
      acApprovedUsers = data.approved || [];
      acRenderRequests();
      acRenderApproved();
      acUpdateAccessStats();
    }
  } catch (e) {
    console.log('Failed to fetch requests:', e);
    acAccessRequests = [
      { id: 1, tvUsername: 'trader_mike', type: 'indicator', wallet: '0x1234...5678', tier: 1, holdings: 150000, timestamp: Date.now() - 3600000 },
      { id: 2, tvUsername: 'crypto_sarah', type: 'strategy', strategyId: 0, wallet: '0xabcd...ef01', tier: 2, holdings: 650000, timestamp: Date.now() - 7200000 }
    ];
    acRenderRequests();
  }
}

function acRenderRequests() {
  const tbody = document.getElementById('ac-requests-table');
  if (acAccessRequests.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="ac-empty-state">No pending requests</td></tr>';
    return;
  }
  tbody.innerHTML = acAccessRequests.map(req => {
    const tierClass = req.tier === 3 ? 'ac-tier-diamond' : req.tier === 2 ? 'ac-tier-gold' : 'ac-tier-bronze';
    const tierName = req.tier === 3 ? 'üíé Diamond' : req.tier === 2 ? 'ü•á Gold' : 'ü•â Bronze';
    const typeClass = req.type === 'indicator' ? 'ac-type-indicator' : 'ac-type-strategy';
    const typeText = req.type === 'indicator' ? 'Indicator' : `Strategy #${req.strategyId}`;
    const details = req.type === 'strategy' ? AC_STRATEGY_NAMES[req.strategyId] || 'Unknown' : 'PriceCipher';
    const timeAgo = acFormatTimeAgo(req.timestamp);
    return `<tr>
      <td class="ac-tv-username">@${req.tvUsername}</td>
      <td><span class="ac-request-type ${typeClass}">${typeText}</span></td>
      <td>${details}</td>
      <td class="ac-wallet-address">${req.wallet}</td>
      <td><span class="ac-tier-badge ${tierClass}">${tierName}</span></td>
      <td>${(req.holdings || 0).toLocaleString()} CIPHER</td>
      <td>${timeAgo}</td>
      <td>
        <button class="ac-action-btn approve" onclick="acApproveRequest(${req.id})">‚úì Approve</button>
        <button class="ac-action-btn reject" onclick="acRejectRequest(${req.id})">‚úó</button>
      </td>
    </tr>`;
  }).join('');
}

function acRenderApproved() {
  const tbody = document.getElementById('ac-approved-table');
  if (acApprovedUsers.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="ac-empty-state">No approved users yet</td></tr>';
    return;
  }
  tbody.innerHTML = acApprovedUsers.map(user => {
    const accessTypes = [];
    if (user.indicator) accessTypes.push('Indicator');
    if (user.strategies?.length) accessTypes.push(`${user.strategies.length} Strategies`);
    const accessText = accessTypes.join(' + ') || 'None';
    const holdingsOk = user.currentHoldings >= (user.requiredHoldings || 100000);
    const statusClass = holdingsOk ? 'ac-status-healthy' : 'ac-status-danger';
    const statusText = holdingsOk ? '‚úì Active' : '‚ö†Ô∏è Low Balance';
    return `<tr>
      <td class="ac-tv-username">@${user.tvUsername}</td>
      <td>${accessText}</td>
      <td class="ac-wallet-address">${user.wallet}</td>
      <td>${(user.currentHoldings || 0).toLocaleString()} CIPHER</td>
      <td><span class="ac-wallet-status ${statusClass}">${statusText}</span></td>
      <td>${acFormatDate(user.approvedAt)}</td>
      <td><button class="ac-action-btn reject" onclick="acRevokeAccess('${user.id}')">Revoke</button></td>
    </tr>`;
  }).join('');
}

async function acApproveRequest(id) {
  const req = acAccessRequests.find(r => r.id === id);
  if (!req) return;
  try {
    await fetch(`${AC_API_BASE}/api/access-requests/${id}/approve`, { method: 'POST' });
  } catch (e) {
    console.log('API call failed, proceeding anyway');
  }
  const action = req.type === 'indicator' ?
    'Add to PriceCipher indicator' :
    `Add to ${AC_STRATEGY_NAMES[req.strategyId]} strategy`;
  alert(`‚úÖ Approved!\n\nTradingView: @${req.tvUsername}\nAction: ${action}\n\nGo to TradingView and add this user to your private script.`);
  acAccessRequests = acAccessRequests.filter(r => r.id !== id);
  acRenderRequests();
}

async function acRejectRequest(id) {
  if (!confirm('Reject this request?')) return;
  try {
    await fetch(`${AC_API_BASE}/api/access-requests/${id}/reject`, { method: 'POST' });
  } catch (e) {}
  acAccessRequests = acAccessRequests.filter(r => r.id !== id);
  acRenderRequests();
}

async function acRevokeAccess(id) {
  if (!confirm('Revoke access for this user?')) return;
  try {
    await fetch(`${AC_API_BASE}/api/access-requests/${id}/revoke`, { method: 'POST' });
  } catch (e) {}
  acApprovedUsers = acApprovedUsers.filter(u => u.id !== id);
  acRenderApproved();
}

async function acScanAllWallets() {
  const btn = document.getElementById('acScanAllBtn');
  btn.disabled = true;
  btn.textContent = 'üîÑ Scanning...';
  const grid = document.getElementById('ac-scanner-grid');
  grid.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-secondary);">Scanning wallets on Base...</div>';
  acWalletScanResults = [];

  const usersToScan = acApprovedUsers.length > 0 ? acApprovedUsers : [
    { tvUsername: 'trader_mike', wallet: '0x1234567890abcdef1234567890abcdef12345678', type: 'indicator', requiredTier: 1 },
    { tvUsername: 'crypto_sarah', wallet: '0xabcdef1234567890abcdef1234567890abcdef12', type: 'strategy', strategyId: 0, requiredTier: 2 }
  ];

  for (const user of usersToScan) {
    try {
      let balance = 0;
      let tier = 0;
      if (acProvider && user.wallet && user.wallet.length === 42) {
        const cipher = new ethers.Contract(AC_CONTRACTS.cipher, AC_ERC20_ABI, acProvider);
        const tierGate = new ethers.Contract(AC_CONTRACTS.tierGate, AC_TIERGATE_ABI, acProvider);
        const rawBalance = await cipher.balanceOf(user.wallet);
        balance = Number(ethers.formatEther(rawBalance));
        tier = Number(await tierGate.getUserTier(user.wallet));
      } else {
        balance = Math.floor(Math.random() * 1500000);
        tier = balance >= 1300000 ? 3 : balance >= 500000 ? 2 : balance >= 100000 ? 1 : 0;
      }
      const requiredBalance = user.type === 'strategy' ? 500000 : 100000;
      const status = balance >= requiredBalance ? 'healthy' : balance >= requiredBalance * 0.5 ? 'warning' : 'danger';
      acWalletScanResults.push({ ...user, currentBalance: balance, currentTier: tier, requiredBalance, status });
    } catch (e) {
      console.log('Scan error for', user.wallet, e);
    }
  }
  acRenderScanResults();
  acUpdateScanStats();
  btn.disabled = false;
  btn.textContent = 'üîÑ Scan All Wallets';
}

function acRenderScanResults() {
  const grid = document.getElementById('ac-scanner-grid');
  if (acWalletScanResults.length === 0) {
    grid.innerHTML = '<div class="ac-empty-state"><div class="ac-empty-state-icon">üîç</div><div>No wallets to scan</div></div>';
    return;
  }
  grid.innerHTML = acWalletScanResults.map(w => {
    const tierName = w.currentTier === 3 ? 'üíé Diamond' : w.currentTier === 2 ? 'ü•á Gold' : w.currentTier === 1 ? 'ü•â Bronze' : '‚ùå None';
    const statusText = w.status === 'healthy' ? '‚úì Healthy' : w.status === 'warning' ? '‚ö†Ô∏è Low' : '‚ùå Below';
    return `<div class="ac-wallet-card ${w.status}">
      <div class="ac-wallet-header">
        <span class="ac-wallet-tv">@${w.tvUsername}</span>
        <span class="ac-wallet-status ac-status-${w.status}">${statusText}</span>
      </div>
      <div class="ac-wallet-details">
        <div class="ac-wallet-detail">
          <span class="ac-wallet-detail-label">Balance:</span>
          <span class="ac-wallet-detail-value">${w.currentBalance.toLocaleString()}</span>
        </div>
        <div class="ac-wallet-detail">
          <span class="ac-wallet-detail-label">Required:</span>
          <span class="ac-wallet-detail-value">${w.requiredBalance.toLocaleString()}</span>
        </div>
        <div class="ac-wallet-detail">
          <span class="ac-wallet-detail-label">Tier:</span>
          <span class="ac-wallet-detail-value">${tierName}</span>
        </div>
        <div class="ac-wallet-detail">
          <span class="ac-wallet-detail-label">Access:</span>
          <span class="ac-wallet-detail-value">${w.type === 'indicator' ? 'Indicator' : AC_STRATEGY_NAMES[w.strategyId] || 'Strategy'}</span>
        </div>
      </div>
      ${w.status === 'danger' ? `<div class="ac-wallet-actions">
        <button class="ac-action-btn reject" onclick="acAddToRevocation('${w.tvUsername}')">Add to Revocation</button>
      </div>` : ''}
    </div>`;
  }).join('');
}

function acUpdateScanStats() {
  const healthy = acWalletScanResults.filter(w => w.status === 'healthy').length;
  const warning = acWalletScanResults.filter(w => w.status === 'warning').length;
  const danger = acWalletScanResults.filter(w => w.status === 'danger').length;
  document.getElementById('ac-scan-total').textContent = acWalletScanResults.length;
  document.getElementById('ac-scan-healthy').textContent = healthy;
  document.getElementById('ac-scan-warning').textContent = warning;
  document.getElementById('ac-scan-danger').textContent = danger;
}

function acUpdateAccessStats() {
  document.getElementById('ac-pending').textContent = acAccessRequests.length;
  document.getElementById('ac-indicator').textContent = acApprovedUsers.filter(u => u.indicator).length;
  document.getElementById('ac-strategy').textContent = acApprovedUsers.filter(u => u.strategies?.length).length;
}

function acAddToRevocation(tvUsername) {
  alert(`‚ö†Ô∏è ${tvUsername} added to revocation queue. They will be notified.`);
}

function acFormatTimeAgo(timestamp) {
  const seconds = Math.floor((Date.now() - timestamp) / 1000);
  if (seconds < 60) return 'Just now';
  if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
  if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
  return `${Math.floor(seconds / 86400)}d ago`;
}

function acFormatDate(timestamp) {
  if (!timestamp) return '--';
  return new Date(timestamp).toLocaleDateString();
}

// Auto-load access requests when Decrypt Labs tab is shown
const origNavClick = document.querySelectorAll('.nav-tab');
origNavClick.forEach(tab => {
  tab.addEventListener('click', () => {
    if (tab.getAttribute('data-tab') === 'decrypt-labs') {
      acRefreshRequests();
    }
  });
});
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PERSONAL TASK CALENDAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DAYS_OF_WEEK = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
const CATEGORY_COLORS = {
  trading: '#00ff88',
  content: '#aa66ff',
  business: '#00d4ff',
  personal: '#ffdd44'
};

const DEFAULT_PERSONAL_TASKS = {
  Mon: [
    { name: 'Morning routine', time: '3:45 AM', cat: 'personal' },
    { name: 'Check bot performance', time: '6:00 AM', cat: 'trading' },
    { name: 'Weekly planning', time: '8:00 AM', cat: 'business' },
    { name: 'Review expenses', time: '9:00 AM', cat: 'business' },
    { name: 'Set weekly goals', time: '10:00 AM', cat: 'business' },
    { name: 'Review trades', time: '12:00 PM', cat: 'trading' },
    { name: 'Evening bot protocol', time: '4:00 PM', cat: 'trading' },
  ],
  Tue: [
    { name: 'Morning routine', time: '3:45 AM', cat: 'personal' },
    { name: 'Check bot performance', time: '6:00 AM', cat: 'trading' },
    { name: 'Market Analysis Post', time: '7:00 AM', cat: 'content' },
    { name: 'Review trades', time: '12:00 PM', cat: 'trading' },
    { name: 'Evening bot protocol', time: '4:00 PM', cat: 'trading' },
  ],
  Wed: [
    { name: 'Morning routine', time: '3:45 AM', cat: 'personal' },
    { name: 'Check bot performance', time: '6:00 AM', cat: 'trading' },
    { name: 'Content creation day', time: '9:00 AM', cat: 'content' },
    { name: 'Discord community', time: '11:00 AM', cat: 'content' },
    { name: 'Review trades', time: '12:00 PM', cat: 'trading' },
    { name: 'Evening bot protocol', time: '4:00 PM', cat: 'trading' },
  ],
  Thu: [
    { name: 'Morning routine', time: '3:45 AM', cat: 'personal' },
    { name: 'Check bot performance', time: '6:00 AM', cat: 'trading' },
    { name: 'Market Analysis Post', time: '7:00 AM', cat: 'content' },
    { name: 'Review bot strategies', time: '10:00 AM', cat: 'trading' },
    { name: 'Review trades', time: '12:00 PM', cat: 'trading' },
    { name: 'Evening bot protocol', time: '4:00 PM', cat: 'trading' },
  ],
  Fri: [
    { name: 'Morning routine', time: '3:45 AM', cat: 'personal' },
    { name: 'Check bot performance', time: '6:00 AM', cat: 'trading' },
    { name: 'Weekly P&L review', time: '9:00 AM', cat: 'business' },
    { name: 'Update dashboard data', time: '10:00 AM', cat: 'business' },
    { name: 'Review trades', time: '12:00 PM', cat: 'trading' },
    { name: 'Plan next week', time: '2:00 PM', cat: 'business' },
    { name: 'Evening bot protocol', time: '4:00 PM', cat: 'trading' },
  ],
  Sat: [
    { name: 'Light monitoring', time: '9:00 AM', cat: 'trading' },
    { name: 'Off / Rest day', time: '‚Äî', cat: 'personal' },
  ],
  Sun: [
    { name: 'Prep for trading week', time: '4:00 PM', cat: 'trading' },
    { name: 'Check news/events', time: '5:00 PM', cat: 'business' },
  ]
};

let personalTasks = null;
let personalEditOverlay = null;

function loadPersonalTasks() {
  try {
    const saved = localStorage.getItem('personal-tasks');
    return saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(DEFAULT_PERSONAL_TASKS));
  } catch(e) { return JSON.parse(JSON.stringify(DEFAULT_PERSONAL_TASKS)); }
}

async function loadPersonalTasksFromAPI() {
  try {
    const res = await fetch('/api/personal-tasks');
    if (res.ok) {
      const data = await res.json();
      if (data && Object.keys(data).length > 0) {
        localStorage.setItem('personal-tasks', JSON.stringify(data));
        return data;
      }
    }
  } catch(e) { console.warn('API personal-tasks load failed, using localStorage'); }
  const local = loadPersonalTasks();
  if (local && Object.keys(local).length > 0) {
    fetch('/api/personal-tasks', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(local) }).catch(() => {});
  }
  return local;
}

async function savePersonalTasks() {
  localStorage.setItem('personal-tasks', JSON.stringify(personalTasks));
  try {
    await fetch('/api/personal-tasks', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(personalTasks) });
  } catch(e) { console.warn('Failed to save personal tasks to server'); }
}

function parseTimeToMinutes(timeStr) {
  if (!timeStr || timeStr === '‚Äî') return 9999;
  const match = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
  if (!match) return 9999;
  let h = parseInt(match[1]);
  const m = parseInt(match[2]);
  const ampm = match[3].toUpperCase();
  if (ampm === 'PM' && h < 12) h += 12;
  if (ampm === 'AM' && h === 12) h = 0;
  return h * 60 + m;
}

function renderPersonalCalendar() {
  if (!personalTasks) personalTasks = loadPersonalTasks();
  const grid = document.getElementById('personal-cal-grid');
  if (!grid) return;

  const now = new Date();
  const todayIdx = (now.getDay() + 6) % 7; // 0=Mon

  let html = '';
  DAYS_OF_WEEK.forEach((day, idx) => {
    const isToday = idx === todayIdx;
    const tasks = personalTasks[day] || [];
    html += '<div class="pcal-day' + (isToday ? ' pcal-today' : '') + '">';
    html += '<div class="pcal-day-header">' + day;
    if (isToday) html += ' <span class="pcal-today-badge">TODAY</span>';
    html += '</div>';
    html += '<div class="pcal-tasks">';
    tasks.forEach((task, ti) => {
      const catClass = 'cat-' + (task.cat || 'personal');
      html += '<div class="pcal-task ' + catClass + '" onclick="editPersonalTask(\'' + day + '\',' + ti + ')">';
      html += '<div class="pcal-task-name">' + escapeHtml(task.name) + '</div>';
      html += '<div class="pcal-task-time">' + escapeHtml(task.time || '') + '</div>';
      html += '</div>';
    });
    html += '<button class="pcal-add-btn" onclick="addPersonalTask(\'' + day + '\')">+</button>';
    html += '</div></div>';
  });
  grid.innerHTML = html;
  renderPersonalNextUp();
}

function escapeHtml(str) {
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

function editPersonalTask(day, idx) {
  const task = personalTasks[day][idx];
  showTaskEditModal(day, idx, task);
}

function addPersonalTask(day) {
  showTaskEditModal(day, -1, { name: '', time: '', cat: 'personal' });
}

function showTaskEditModal(day, idx, task) {
  let overlay = document.getElementById('pcal-edit-overlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'pcal-edit-overlay';
    overlay.className = 'pcal-edit-overlay';
    overlay.innerHTML = '<div class="pcal-edit-modal" id="pcal-edit-modal"></div>';
    overlay.addEventListener('click', (e) => { if (e.target === overlay) closeTaskEditModal(); });
    document.body.appendChild(overlay);
  }

  const isNew = idx === -1;
  const modal = document.getElementById('pcal-edit-modal');
  modal.innerHTML = `
    <h3>${isNew ? '‚ûï Add Task' : '‚úèÔ∏è Edit Task'} ‚Äî ${day}</h3>
    <label>Task Name</label>
    <input type="text" id="pcal-edit-name" value="${escapeHtml(task.name)}" placeholder="Task name...">
    <label>Time</label>
    <input type="text" id="pcal-edit-time" value="${escapeHtml(task.time || '')}" placeholder="e.g. 9:00 AM">
    <label>Category</label>
    <select id="pcal-edit-cat">
      <option value="trading" ${task.cat==='trading'?'selected':''}>üü¢ Trading/Bots</option>
      <option value="content" ${task.cat==='content'?'selected':''}>üü£ Content/Social</option>
      <option value="business" ${task.cat==='business'?'selected':''}>üîµ Business/Admin</option>
      <option value="personal" ${task.cat==='personal'?'selected':''}>üü° Personal</option>
    </select>
    <div class="pcal-edit-actions">
      ${!isNew ? '<button class="pcal-delete-btn" onclick="deletePersonalTask(\''+day+'\','+idx+')">üóë</button>' : ''}
      <button class="pcal-cancel-btn" onclick="closeTaskEditModal()">CANCEL</button>
      <button class="pcal-save-btn" onclick="saveTaskEdit(\'${day}\',${idx})">SAVE</button>
    </div>
  `;

  overlay.classList.add('active');
  setTimeout(() => document.getElementById('pcal-edit-name').focus(), 100);
}

function closeTaskEditModal() {
  const overlay = document.getElementById('pcal-edit-overlay');
  if (overlay) overlay.classList.remove('active');
}

function saveTaskEdit(day, idx) {
  const name = document.getElementById('pcal-edit-name').value.trim();
  const time = document.getElementById('pcal-edit-time').value.trim();
  const cat = document.getElementById('pcal-edit-cat').value;

  if (!name) return;

  if (!personalTasks[day]) personalTasks[day] = [];

  const task = { name, time: time || '‚Äî', cat };

  if (idx === -1) {
    personalTasks[day].push(task);
  } else {
    personalTasks[day][idx] = task;
  }

  // Sort by time
  personalTasks[day].sort((a, b) => parseTimeToMinutes(a.time) - parseTimeToMinutes(b.time));

  savePersonalTasks();
  renderPersonalCalendar();
  closeTaskEditModal();
}

function deletePersonalTask(day, idx) {
  if (!personalTasks[day]) return;
  personalTasks[day].splice(idx, 1);
  savePersonalTasks();
  renderPersonalCalendar();
  closeTaskEditModal();
}

function renderPersonalNextUp() {
  const container = document.getElementById('personal-countdown-list');
  if (!container) return;

  const now = new Date();
  const currentDay = (now.getDay() + 6) % 7; // 0=Mon
  const currentMinutes = now.getHours() * 60 + now.getMinutes();

  // Collect upcoming tasks from today and next 7 days
  let upcoming = [];
  for (let offset = 0; offset < 7; offset++) {
    const dayIdx = (currentDay + offset) % 7;
    const dayName = DAYS_OF_WEEK[dayIdx];
    const tasks = personalTasks[dayName] || [];
    tasks.forEach(task => {
      const taskMin = parseTimeToMinutes(task.time);
      if (taskMin >= 9999) return; // skip tasks with no time
      let minutesUntil;
      if (offset === 0) {
        minutesUntil = taskMin - currentMinutes;
        if (minutesUntil <= 0) return; // already passed today
      } else {
        minutesUntil = (offset * 1440) + taskMin - currentMinutes;
      }
      upcoming.push({ ...task, minutesUntil, dayName });
    });
  }

  upcoming.sort((a, b) => a.minutesUntil - b.minutesUntil);
  upcoming = upcoming.slice(0, 8);

  if (upcoming.length === 0) {
    container.innerHTML = '<div class="personal-next-item"><span style="color:var(--text-dim);">No upcoming tasks</span></div>';
    return;
  }

  container.innerHTML = upcoming.map(t => {
    const color = CATEGORY_COLORS[t.cat] || '#888';
    let timeStr;
    if (t.minutesUntil < 60) {
      timeStr = 'in ' + t.minutesUntil + ' min';
    } else if (t.minutesUntil < 1440) {
      const h = Math.floor(t.minutesUntil / 60);
      const m = t.minutesUntil % 60;
      timeStr = 'in ' + h + 'h ' + m + 'm';
    } else {
      const d = Math.floor(t.minutesUntil / 1440);
      const h = Math.floor((t.minutesUntil % 1440) / 60);
      timeStr = 'in ' + d + 'd ' + h + 'h';
    }
    return '<div class="personal-next-item">' +
      '<div class="personal-next-label"><span class="dot" style="background:' + color + ';"></span> <strong>' + escapeHtml(t.name) + '</strong></div>' +
      '<div class="personal-next-value">' + timeStr + '</div></div>';
  }).join('');
}

// Initialize personal calendar when tab is shown
loadPersonalTasksFromAPI().then(data => {
  personalTasks = data;
  renderPersonalCalendar();
});

// Update next-up countdowns every minute
setInterval(() => {
  if (document.getElementById('tab-personal')?.classList.contains('active')) {
    renderPersonalNextUp();
  }
}, 60000);

// Also render when personal tab is clicked
document.querySelectorAll('.nav-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    if (tab.getAttribute('data-tab') === 'personal') {
      renderPersonalCalendar();
    }
  });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê IDEAS LAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEFAULT_IDEAS = [
  { id: 1, title: 'Polymarket Arbitrage Scanner', desc: 'Scan Polymarket API for arbitrage opportunities across prediction markets', status: 'backlog', category: 'trading', priority: 'hot', created: '2026-01-27' },
  { id: 2, title: '$CIPHER Token Launch', desc: 'Launch on Virtuals Protocol ‚Äî buyback from bot profits', status: 'in-progress', category: 'token', priority: 'hot', created: '2026-01-25' },
  { id: 3, title: 'ICT Indicator Landing Page', desc: 'Marketing site for the indicator ‚Äî pricing tiers, strategy breakdowns', status: 'in-progress', category: 'product', priority: 'hot', created: '2026-01-24' },
  { id: 4, title: 'YouTube Channel', desc: 'Bot performance videos, ICT education, transparent trading journey', status: 'backlog', category: 'content', priority: 'normal', created: '2026-02-01' },
  { id: 5, title: 'Pitch Video for Investors', desc: 'Professional video showcasing Decrypt Labs, bot performance, roadmap', status: 'in-progress', category: 'product', priority: 'hot', created: '2026-02-05' },
  { id: 6, title: 'AR Glasses Dashboard', desc: 'Real-time bot stats on XREAL One Pro glasses via web overlay', status: 'backlog', category: 'product', priority: 'normal', created: '2026-01-27' },
  { id: 7, title: 'Auto Tweet Pipeline Expansion', desc: 'Add chart screenshots, trade results, and win streak posts to auto-tweet flow', status: 'in-progress', category: 'content', priority: 'normal', created: '2026-02-09' },
  { id: 8, title: 'Multi-Exchange Bridge', desc: 'Expand beyond Apex/Tradovate ‚Äî support NinjaTrader, Rithmic', status: 'backlog', category: 'trading', priority: 'normal', created: '2026-02-03' },
];

let ideasData = [...DEFAULT_IDEAS];
let nextIdeaId = 100;

async function loadIdeas() {
  try {
    const res = await fetch('/api/ideas');
    if (res.ok) {
      const data = await res.json();
      if (Array.isArray(data) && data.length > 0) {
        ideasData = data;
        nextIdeaId = Math.max(...data.map(i => i.id || 0)) + 1;
        localStorage.setItem('decrypt-ideas', JSON.stringify(data));
        return;
      }
    }
  } catch(e) {}
  const saved = localStorage.getItem('decrypt-ideas');
  if (saved) { try { ideasData = JSON.parse(saved); nextIdeaId = Math.max(...ideasData.map(i => i.id || 0)) + 1; } catch(e) {} }
}

async function saveIdeas() {
  localStorage.setItem('decrypt-ideas', JSON.stringify(ideasData));
  try { await fetch('/api/ideas', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(ideasData) }); } catch(e) {}
}

function renderIdeas() {
  const grid = document.getElementById('ideas-grid');
  if (!grid) return;
  const filter = document.getElementById('idea-filter')?.value || 'all';
  let filtered = ideasData;
  if (filter !== 'all') {
    filtered = ideasData.filter(i => i.status === filter || i.category === filter || i.priority === filter);
  }
  // Sort: hot first, then by created desc
  filtered.sort((a, b) => {
    if (a.priority === 'hot' && b.priority !== 'hot') return -1;
    if (b.priority === 'hot' && a.priority !== 'hot') return 1;
    return (b.created || '').localeCompare(a.created || '');
  });

  const statusColors = { 'hot': '#ff6b6b', 'backlog': '#6c7a89', 'in-progress': '#f39c12', 'done': '#2ecc71' };
  const statusLabels = { 'hot': 'üî• Hot', 'backlog': 'üìã Backlog', 'in-progress': 'üöß In Progress', 'done': '‚úÖ Done' };
  const catEmoji = { 'trading': 'üìà', 'content': 'üé¨', 'product': 'üõ†Ô∏è', 'token': 'ü™ô' };

  grid.innerHTML = filtered.map(idea => `
    <div style="background:#141824;border:1px solid #2a2e3e;border-radius:12px;padding:16px;position:relative;border-left:4px solid ${statusColors[idea.status] || '#6c7a89'};">
      <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
        <span style="font-size:11px;padding:3px 8px;border-radius:4px;background:${statusColors[idea.status] || '#6c7a89'}22;color:${statusColors[idea.status] || '#6c7a89'};font-weight:600;">${statusLabels[idea.status] || idea.status}</span>
        <span style="font-size:11px;color:#666;">${catEmoji[idea.category] || 'üí°'} ${idea.category || 'general'}</span>
      </div>
      <h3 style="color:#e0e0e0;font-size:15px;margin:0 0 6px 0;font-weight:700;" contenteditable="true" onblur="updateIdea(${idea.id},'title',this.textContent)">${idea.title}</h3>
      <p style="color:#888;font-size:12px;margin:0 0 10px 0;line-height:1.4;" contenteditable="true" onblur="updateIdea(${idea.id},'desc',this.textContent)">${idea.desc}</p>
      <div style="display:flex;gap:6px;flex-wrap:wrap;">
        <select onchange="updateIdea(${idea.id},'status',this.value);renderIdeas()" style="background:#1a1e2e;color:#aaa;border:1px solid #2a2e3e;padding:3px 6px;border-radius:4px;font-size:11px;">
          ${['backlog','in-progress','done'].map(s => `<option value="${s}" ${idea.status===s?'selected':''}>${statusLabels[s]}</option>`).join('')}
        </select>
        <select onchange="updateIdea(${idea.id},'category',this.value);renderIdeas()" style="background:#1a1e2e;color:#aaa;border:1px solid #2a2e3e;padding:3px 6px;border-radius:4px;font-size:11px;">
          ${['trading','content','product','token'].map(c => `<option value="${c}" ${idea.category===c?'selected':''}>${catEmoji[c]} ${c}</option>`).join('')}
        </select>
        <button onclick="toggleHot(${idea.id})" style="background:none;border:1px solid #2a2e3e;padding:3px 8px;border-radius:4px;font-size:11px;cursor:pointer;color:${idea.priority==='hot'?'#ff6b6b':'#666'};">${idea.priority==='hot'?'üî•':'‚òÜ'}</button>
        <button onclick="deleteIdea(${idea.id})" style="background:none;border:1px solid #2a2e3e;padding:3px 8px;border-radius:4px;font-size:11px;cursor:pointer;color:#666;">üóë</button>
      </div>
      <div style="color:#555;font-size:10px;margin-top:8px;">${idea.created || ''}</div>
    </div>
  `).join('');
}

function addIdea() {
  const idea = { id: nextIdeaId++, title: 'New Idea', desc: 'Describe it here...', status: 'backlog', category: 'product', priority: 'normal', created: new Date().toISOString().split('T')[0] };
  ideasData.unshift(idea);
  saveIdeas();
  renderIdeas();
}

function updateIdea(id, field, value) {
  const idea = ideasData.find(i => i.id === id);
  if (idea) { idea[field] = value.trim(); saveIdeas(); }
}

function toggleHot(id) {
  const idea = ideasData.find(i => i.id === id);
  if (idea) { idea.priority = idea.priority === 'hot' ? 'normal' : 'hot'; saveIdeas(); renderIdeas(); }
}

function deleteIdea(id) {
  if (!confirm('Delete this idea?')) return;
  ideasData = ideasData.filter(i => i.id !== id);
  saveIdeas();
  renderIdeas();
}

// Load and render on init
loadIdeas().then(() => renderIdeas());

// ‚ïê‚ïê‚ïê MEETING ROOM ‚ïê‚ïê‚ïê
const MR_AGENTS = {
  dropking: { name:'DropKing', emoji:'üëë', color:'#aa66ff' },
  jimmy:    { name:'Jimmy', emoji:'üß™', color:'#00e5ff' },
  goddard:  { name:'Goddard', emoji:'üêï‚Äçü¶∫', color:'#ff4444' },
  cindy:    { name:'Cindy', emoji:'‚ö°', color:'#ffaa00' },
  carl:     { name:'Carl', emoji:'ü§ì', color:'#00d4ff' },
  sheen:    { name:'Sheen', emoji:'üöÄ', color:'#00ff88' }
};

const API = window.location.origin;
let meetingMessages = [];

async function loadMeetingMessages() {
  try {
    const res = await fetch(API + '/api/meeting-room');
    if (res.ok) { meetingMessages = await res.json(); }
  } catch(e) { console.log('Meeting room load error:', e); }
  renderMeetingMessages();
}

function renderMeetingMessages() {
  const container = document.getElementById('mr-messages');
  if (!container) return;
  
  if (meetingMessages.length === 0) {
    container.innerHTML = `
      <div style="text-align:center;padding:60px 20px;color:var(--text-dim);">
        <div style="font-size:48px;margin-bottom:16px;opacity:0.3;">üí¨</div>
        <div style="font-size:14px;margin-bottom:8px;">Meeting room is empty</div>
        <div style="font-size:11px;">Start the conversation ‚Äî the whole team is here.</div>
      </div>`;
    return;
  }

  container.innerHTML = meetingMessages.map(msg => {
    const agent = MR_AGENTS[msg.sender] || MR_AGENTS.jimmy;
    const time = new Date(msg.timestamp).toLocaleString('en-US', {month:'short',day:'numeric',hour:'numeric',minute:'2-digit',hour12:true});
    const isDropKing = msg.sender === 'dropking';
    return `
      <div style="display:flex;gap:10px;align-items:flex-start;${isDropKing ? 'flex-direction:row-reverse;' : ''}">
        <div style="width:34px;height:34px;border-radius:8px;background:rgba(${hexToRgb(agent.color)},0.15);display:flex;align-items:center;justify-content:center;font-size:16px;border:1.5px solid ${agent.color}40;flex-shrink:0;">${agent.emoji}</div>
        <div style="max-width:70%;${isDropKing ? 'text-align:right;' : ''}">
          <div style="display:flex;align-items:baseline;gap:8px;margin-bottom:3px;${isDropKing ? 'justify-content:flex-end;' : ''}">
            <span style="font-size:12px;font-weight:700;color:${agent.color};">${agent.name}</span>
            <span style="font-size:10px;color:var(--text-dim);">${time}</span>
          </div>
          <div style="background:${isDropKing ? 'rgba(170,102,255,0.1)' : 'rgba(255,255,255,0.04)'};border:1px solid ${isDropKing ? 'rgba(170,102,255,0.2)' : 'var(--border-color)'};border-radius:12px;${isDropKing ? 'border-top-right-radius:4px;' : 'border-top-left-radius:4px;'}padding:10px 14px;font-size:13px;color:var(--text-secondary);line-height:1.5;">
            ${escapeHtml(msg.message)}
          </div>
        </div>
      </div>`;
  }).join('');
  
  container.scrollTop = container.scrollHeight;
}

function hexToRgb(hex) {
  hex = hex.replace('#','');
  return [parseInt(hex.substring(0,2),16), parseInt(hex.substring(2,4),16), parseInt(hex.substring(4,6),16)].join(',');
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

async function sendMeetingMsg() {
  const input = document.getElementById('mr-input');
  const sender = document.getElementById('mr-sender').value;
  const message = input.value.trim();
  if (!message) return;
  
  input.value = '';
  
  const msg = { sender, message, timestamp: new Date().toISOString() };
  meetingMessages.push(msg);
  renderMeetingMessages();
  
  try {
    await fetch(API + '/api/meeting-room', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(msg)
    });
  } catch(e) { console.log('Send error:', e); }
}

// Auto-load meeting messages when org tab is clicked
document.querySelectorAll('.nav-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    if (tab.getAttribute('data-tab') === 'org') {
      setTimeout(() => loadMeetingMessages(), 100);
    }
  });
});

// Also poll every 15s when org tab is active
setInterval(() => {
  const orgTab = document.getElementById('tab-org');
  if (orgTab && orgTab.classList.contains('active')) {
    loadMeetingMessages();
    loadLoungeMessages();
  }
}, 15000);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê THE LOUNGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let loungeMessages = [];

async function loadLoungeMessages() {
  try {
    const res = await fetch(API + '/api/lounge');
    if (res.ok) { loungeMessages = await res.json(); }
  } catch(e) { console.log('Lounge load error:', e); }
  renderLoungeMessages();
}

function renderLoungeMessages() {
  const container = document.getElementById('lounge-messages');
  if (!container) return;

  // Update counts
  const ideaCount = loungeMessages.filter(m => m.type === 'idea').length;
  const el1 = document.getElementById('lounge-idea-count');
  const el2 = document.getElementById('lounge-msg-count');
  const el3 = document.getElementById('lounge-last-session');
  if (el1) el1.textContent = ideaCount;
  if (el2) el2.textContent = loungeMessages.length;
  if (el3 && loungeMessages.length > 0) {
    const last = loungeMessages[loungeMessages.length - 1];
    el3.textContent = new Date(last.timestamp).toLocaleString('en-US', {month:'short',day:'numeric',hour:'numeric',minute:'2-digit',hour12:true});
  }

  if (loungeMessages.length === 0) {
    container.innerHTML = `
      <div style="text-align:center;padding:60px 20px;color:var(--text-dim);">
        <div style="font-size:48px;margin-bottom:16px;opacity:0.3;">üõãÔ∏è</div>
        <div style="font-size:14px;margin-bottom:8px;">The lounge is quiet</div>
        <div style="font-size:11px;">Agents will brainstorm here overnight. Check back in the morning!</div>
      </div>`;
    return;
  }

  container.innerHTML = loungeMessages.map(msg => {
    const agent = MR_AGENTS[msg.sender] || MR_AGENTS.jimmy;
    const time = new Date(msg.timestamp).toLocaleString('en-US', {month:'short',day:'numeric',hour:'numeric',minute:'2-digit',hour12:true});
    const isIdea = msg.type === 'idea';
    const borderColor = isIdea ? 'rgba(255,170,0,0.3)' : 'var(--border-color)';
    const bgColor = isIdea ? 'rgba(255,170,0,0.06)' : 'rgba(255,255,255,0.04)';
    const ideaTag = isIdea ? '<span style="background:rgba(255,170,0,0.2);color:#ffaa00;font-size:9px;font-weight:800;padding:2px 6px;border-radius:4px;margin-left:6px;">üí° IDEA</span>' : '';
    return `
      <div style="display:flex;gap:10px;align-items:flex-start;">
        <div style="width:34px;height:34px;border-radius:8px;background:rgba(${hexToRgb(agent.color)},0.15);display:flex;align-items:center;justify-content:center;font-size:16px;border:1.5px solid ${agent.color}40;flex-shrink:0;">${agent.emoji}</div>
        <div style="flex:1;">
          <div style="display:flex;align-items:baseline;gap:8px;margin-bottom:3px;">
            <span style="font-size:12px;font-weight:700;color:${agent.color};">${agent.name}</span>
            ${ideaTag}
            <span style="font-size:10px;color:var(--text-dim);">${time}</span>
          </div>
          <div style="background:${bgColor};border:1px solid ${borderColor};border-radius:12px;border-top-left-radius:4px;padding:10px 14px;font-size:13px;color:var(--text-secondary);line-height:1.5;">
            ${escapeHtml(msg.message)}
          </div>
        </div>
      </div>`;
  }).join('');

  container.scrollTop = container.scrollHeight;
}

async function clearLounge() {
  if (!confirm('Clear all lounge messages?')) return;
  try {
    await fetch(API + '/api/lounge', { method: 'DELETE' });
    loungeMessages = [];
    renderLoungeMessages();
  } catch(e) { console.log('Clear error:', e); }
}

// Load both on page init (in case org tab is default or already active)
loadMeetingMessages();
loadLoungeMessages();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê THE FOUNTAIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FOUNTAIN_AGENTS = {
  titan: { name: 'Titan', emoji: 'üî®', color: '#ff5252', role: 'Lead Builder ‚Äî GLM-5', leader: true },
  scout: { name: 'Scout', emoji: 'üî≠', color: '#4fc3f7', role: 'Trend Hunter' },
  spark: { name: 'Spark', emoji: '‚ö°', color: '#ffb74d', role: 'Idea Generator' },
  forge: { name: 'Forge', emoji: 'üî®', color: '#e57373', role: 'Builder Assessment' },
  lens:  { name: 'Lens', emoji: 'üîç', color: '#81c784', role: 'Market Analyst' }
};

let fountainTrends = [];
let fountainIdeas = [];
let fountainFilter = 'all';

function renderFountainAgentsBar() {
  const bar = document.getElementById('fountain-agents-bar');
  if (!bar) return;
  bar.style.cssText = 'display:flex;gap:12px;flex-wrap:wrap;justify-content:center;';
  bar.innerHTML = Object.entries(FOUNTAIN_AGENTS).map(([key, a]) => `
    <div class="ft-agent-badge" style="background:${a.color}15;border:1px solid ${a.leader ? a.color : a.color + '40'};${a.leader ? 'box-shadow:0 0 12px ' + a.color + '30;transform:scale(1.08);' : ''}">
      <span style="font-size:${a.leader ? '20px' : '16px'};">${a.emoji}</span>
      <span style="color:${a.color};${a.leader ? 'font-weight:700;' : ''}">${a.name}${a.leader ? ' üëë' : ''}</span>
      <span style="color:var(--text-dim);font-weight:400;font-size:10px;">${a.role}</span>
    </div>
  `).join('');
}

async function loadFountainData() {
  try {
    const [trendsRes, ideasRes] = await Promise.all([
      fetch('/api/fountain/trends').catch(() => null),
      fetch('/api/fountain/ideas').catch(() => null)
    ]);
    if (trendsRes && trendsRes.ok) fountainTrends = await trendsRes.json();
    if (ideasRes && ideasRes.ok) fountainIdeas = await ideasRes.json();
  } catch(e) { console.warn('Fountain data load error:', e); }
  renderFountainAll();
}

function renderFountainAll() {
  renderFountainAgentsBar();
  renderFountainStats();
  renderFountainTrends();
  renderFountainIdeas();
  renderFountainLab();
}

function renderFountainStats() {
  const labCount = fountainIdeas.filter(i => i.status === 'lab').length;
  const pipeCount = fountainIdeas.filter(i => i.status === 'pipeline').length;
  const el1 = document.getElementById('ft-stat-trends');
  const el2 = document.getElementById('ft-stat-ideas');
  const el3 = document.getElementById('ft-stat-lab');
  const el4 = document.getElementById('ft-stat-pipeline');
  if (el1) el1.textContent = fountainTrends.length;
  if (el2) el2.textContent = fountainIdeas.length;
  if (el3) el3.textContent = labCount;
  if (el4) el4.textContent = pipeCount;
}

function renderFountainTrends() {
  const container = document.getElementById('fountain-trends');
  if (!container) return;
  if (fountainTrends.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-dim);grid-column:1/-1;"><div style="font-size:40px;opacity:0.3;margin-bottom:8px;">üî≠</div><div>No trends scanned yet. Scout is on patrol...</div></div>';
    return;
  }
  const sourceIcons = { twitter: 'üê¶', reddit: 'üü†', hackernews: 'üüß', producthunt: 'üöÄ', news: 'üì∞', research: 'üìÑ', ai: 'ü§ñ' };
  container.innerHTML = fountainTrends.map(t => {
    const icon = sourceIcons[t.source?.toLowerCase()] || 'üîó';
    const tags = (t.tags || []).map(tag => `<span class="ft-tag">${escapeHtml(tag)}</span>`).join('');
    const timeAgo = t.timestamp ? ftTimeAgo(t.timestamp) : '';
    return `
      <div class="ft-trend-card">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
          <span style="font-size:20px;">${icon}</span>
          <span style="font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;">${escapeHtml(t.source || 'Unknown')}</span>
          <span style="margin-left:auto;font-size:10px;color:var(--text-dim);">${timeAgo}</span>
        </div>
        <div style="font-size:14px;font-weight:700;color:var(--text-primary);margin-bottom:6px;">${escapeHtml(t.title || 'Untitled')}</div>
        <div style="font-size:12px;color:var(--text-secondary);line-height:1.5;margin-bottom:10px;">${escapeHtml(t.description || '')}</div>
        ${tags ? '<div style="display:flex;gap:6px;flex-wrap:wrap;">' + tags + '</div>' : ''}
        ${t.url ? '<a href="' + escapeHtml(t.url) + '" target="_blank" style="font-size:11px;color:#ff9800;text-decoration:none;margin-top:6px;display:inline-block;">View source ‚Üí</a>' : ''}
      </div>`;
  }).join('');
}

function renderFountainIdeas() {
  const container = document.getElementById('fountain-ideas');
  if (!container) return;
  let ideas = [...fountainIdeas];
  if (fountainFilter === 'lab') ideas = ideas.filter(i => i.status === 'lab');
  else if (fountainFilter === 'pipeline') ideas = ideas.filter(i => i.status === 'pipeline');

  if (ideas.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-dim);grid-column:1/-1;"><div style="font-size:40px;opacity:0.3;margin-bottom:8px;">üíß</div><div>No ideas ' + (fountainFilter !== 'all' ? 'with this filter' : 'generated yet') + '.</div></div>';
    return;
  }

  container.innerHTML = ideas.map(idea => {
    const agent = FOUNTAIN_AGENTS[idea.agent] || FOUNTAIN_AGENTS.spark;
    const scores = idea.scores || {};
    const statusClass = idea.status === 'lab' ? 'status-lab' : idea.status === 'pipeline' ? 'status-pipeline' : '';
    const statusLabel = idea.status === 'lab' ? 'üß™ Ideas Lab' : idea.status === 'pipeline' ? 'üöÄ Pipeline' : idea.status === 'archived' ? 'üì¶ Archived' : 'üíß Stream';
    const statusColor = idea.status === 'lab' ? '#ffd54f' : idea.status === 'pipeline' ? '#81c784' : idea.status === 'archived' ? '#888' : '#ffb74d';
    const timeAgo = idea.timestamp ? ftTimeAgo(idea.timestamp) : '';

    const scoreBar = (label, val, color) => {
      const pct = Math.min(Math.max((val || 0) * 10, 0), 100);
      return `<div style="display:flex;align-items:center;gap:8px;font-size:11px;">
        <span style="color:var(--text-dim);min-width:70px;">${label}</span>
        <div class="ft-score-bar"><div class="ft-score-fill" style="width:${pct}%;background:${color};"></div></div>
        <span style="color:var(--text-secondary);min-width:20px;text-align:right;">${val || 0}</span>
      </div>`;
    };

    return `
      <div class="ft-idea-card ${statusClass}">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <span style="font-size:10px;padding:3px 8px;border-radius:4px;background:${statusColor}22;color:${statusColor};font-weight:600;">${statusLabel}</span>
          <span style="font-size:10px;color:var(--text-dim);">${timeAgo}</span>
        </div>
        <div style="font-size:15px;font-weight:700;color:var(--text-primary);margin-bottom:6px;">${escapeHtml(idea.title || 'Untitled')}</div>
        <div style="font-size:12px;color:var(--text-secondary);line-height:1.5;margin-bottom:12px;">${escapeHtml(idea.description || '')}</div>
        ${idea.source_trend ? '<div style="font-size:10px;color:var(--text-dim);margin-bottom:10px;">üì° From trend: <span style="color:#ff9800;">' + escapeHtml(idea.source_trend) + '</span></div>' : ''}
        <div style="display:flex;flex-direction:column;gap:4px;margin-bottom:12px;">
          ${scoreBar('Feasibility', scores.feasibility, '#4fc3f7')}
          ${scoreBar('Market', scores.market, '#81c784')}
          ${scoreBar('Effort', scores.effort, '#e57373')}
        </div>
        ${scores.overall ? '<div style="font-size:11px;color:var(--text-secondary);margin-bottom:10px;">Overall: <strong style="color:#ffb74d;">' + scores.overall + '/10</strong></div>' : ''}
        <div style="display:flex;justify-content:space-between;align-items:center;padding-top:10px;border-top:1px solid var(--border-color);">
          <div class="ft-agent-badge" style="background:${agent.color}15;border:1px solid ${agent.color}30;padding:3px 8px;">
            <span>${agent.emoji}</span>
            <span style="color:${agent.color};font-size:10px;">${agent.name}</span>
          </div>
          <div style="display:flex;gap:6px;">
            <button class="ft-promote-btn" onclick="queueBuildById('${idea.id}')" style="background:rgba(0,229,255,0.1);border-color:rgba(0,229,255,0.3);color:#00e5ff;">üî® Build It</button>
            ${idea.status === 'stream' ? '<button class="ft-promote-btn to-lab" onclick="promoteFountainIdea(\'' + idea.id + '\',\'lab\')">‚Üí Ideas Lab</button>' : ''}
            ${idea.status === 'lab' ? '<button class="ft-promote-btn to-pipeline" onclick="promoteFountainIdea(\'' + idea.id + '\',\'pipeline\')">‚Üí Pipeline</button>' : ''}
          </div>
        </div>
      </div>`;
  }).join('');
}

function renderFountainLab() {
  const container = document.getElementById('fountain-lab');
  if (!container) return;
  const labIdeas = fountainIdeas.filter(i => i.status === 'lab' || i.status === 'pipeline');

  if (labIdeas.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-dim);grid-column:1/-1;"><div style="font-size:40px;opacity:0.3;margin-bottom:8px;">üß™</div><div>No ideas in the lab yet. Promote ideas from the stream!</div></div>';
    return;
  }

  container.innerHTML = labIdeas.map(idea => {
    const agent = FOUNTAIN_AGENTS[idea.agent] || FOUNTAIN_AGENTS.spark;
    const scores = idea.scores || {};
    const isPipeline = idea.status === 'pipeline';
    const borderColor = isPipeline ? 'rgba(129,199,132,0.4)' : 'rgba(255,213,79,0.4)';
    const statusText = isPipeline ? 'üöÄ IN PIPELINE' : 'üß™ IN LAB';
    const statusColor = isPipeline ? '#81c784' : '#ffd54f';

    return `
      <div style="background:var(--bg-card);border:2px solid ${borderColor};border-radius:14px;padding:22px;transition:all 0.2s;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
          <span style="font-size:11px;padding:4px 10px;border-radius:6px;background:${statusColor}18;color:${statusColor};font-weight:700;letter-spacing:0.5px;">${statusText}</span>
          <div class="ft-agent-badge" style="background:${agent.color}15;border:1px solid ${agent.color}30;padding:3px 8px;">
            <span>${agent.emoji}</span>
            <span style="color:${agent.color};font-size:10px;">${agent.name}</span>
          </div>
        </div>
        <div style="font-size:17px;font-weight:700;color:var(--text-primary);margin-bottom:8px;font-family:'Orbitron',sans-serif;">${escapeHtml(idea.title || 'Untitled')}</div>
        <div style="font-size:13px;color:var(--text-secondary);line-height:1.6;margin-bottom:14px;">${escapeHtml(idea.description || '')}</div>
        ${idea.source_trend ? '<div style="font-size:11px;color:var(--text-dim);margin-bottom:12px;">üì° Source trend: <span style="color:#ff9800;">' + escapeHtml(idea.source_trend) + '</span></div>' : ''}
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px;">
          <div style="text-align:center;background:rgba(79,195,247,0.08);border-radius:8px;padding:10px;">
            <div style="font-size:10px;color:var(--text-dim);">Feasibility</div>
            <div style="font-family:'Orbitron',sans-serif;font-size:18px;font-weight:700;color:#4fc3f7;margin-top:2px;">${scores.feasibility || '‚Äî'}</div>
          </div>
          <div style="text-align:center;background:rgba(129,199,132,0.08);border-radius:8px;padding:10px;">
            <div style="font-size:10px;color:var(--text-dim);">Market</div>
            <div style="font-family:'Orbitron',sans-serif;font-size:18px;font-weight:700;color:#81c784;margin-top:2px;">${scores.market || '‚Äî'}</div>
          </div>
          <div style="text-align:center;background:rgba(229,115,115,0.08);border-radius:8px;padding:10px;">
            <div style="font-size:10px;color:var(--text-dim);">Effort</div>
            <div style="font-family:'Orbitron',sans-serif;font-size:18px;font-weight:700;color:#e57373;margin-top:2px;">${scores.effort || '‚Äî'}</div>
          </div>
          <div style="text-align:center;background:rgba(255,183,77,0.08);border-radius:8px;padding:10px;">
            <div style="font-size:10px;color:var(--text-dim);">Overall</div>
            <div style="font-family:'Orbitron',sans-serif;font-size:18px;font-weight:700;color:#ffb74d;margin-top:2px;">${scores.overall || '‚Äî'}</div>
          </div>
        </div>
        <div style="display:flex;gap:10px;align-items:center;justify-content:${isPipeline ? 'center' : 'flex-end'};">
          <button class="ft-promote-btn" onclick="queueBuildById('${idea.id}')" style="background:rgba(0,229,255,0.1);border-color:rgba(0,229,255,0.3);color:#00e5ff;padding:8px 20px;font-size:12px;">üî® Build It</button>
          ${!isPipeline ? '<button class="ft-promote-btn to-pipeline" onclick="promoteFountainIdea(\'' + idea.id + '\',\'pipeline\')" style="padding:8px 20px;">üöÄ Move to Pipeline</button>' : ''}
        </div>
      </div>`;
  }).join('');
}

function setFountainFilter(filter, btn) {
  fountainFilter = filter;
  document.querySelectorAll('.ft-filter-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  renderFountainIdeas();
}

async function promoteFountainIdea(id, newStatus) {
  try {
    const res = await fetch(`/api/fountain/ideas/${id}/promote`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: newStatus })
    });
    if (res.ok) {
      // Update local state
      const idea = fountainIdeas.find(i => i.id === id);
      if (idea) idea.status = newStatus;
      renderFountainAll();
      showToast(`‚úÖ Idea promoted to ${newStatus === 'lab' ? 'Ideas Lab' : 'Pipeline'}!`);
    }
  } catch(e) {
    showToast('‚ùå Failed to promote idea: ' + e.message);
  }
}

function ftTimeAgo(ts) {
  const seconds = Math.floor((Date.now() - new Date(ts).getTime()) / 1000);
  if (seconds < 60) return 'Just now';
  if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
  if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
  return Math.floor(seconds / 86400) + 'd ago';
}

// Load fountain data when tab is clicked
document.querySelectorAll('.nav-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    if (tab.getAttribute('data-tab') === 'fountain') {
      loadFountainData();
    }
  });
});

// Initial load (in case tab is opened directly)
loadFountainData();

// ‚ïê‚ïê‚ïê THE FORGE ‚ïê‚ïê‚ïê
let forgeBuilds = [];

async function fetchForgeBuilds() {
  try {
    const res = await fetch('/api/fountain/builds');
    if (res.ok) {
      forgeBuilds = await res.json();
      renderForgeBuilds();
    }
  } catch (e) { console.error('Forge fetch failed', e); }
}

function renderForgeBuilds() {
  const container = document.getElementById('forge-queue');
  if (!container) return;

  // Stats
  document.getElementById('forge-stat-queued').textContent = forgeBuilds.filter(b => b.status === 'queued').length;
  document.getElementById('forge-stat-building').textContent = forgeBuilds.filter(b => b.status === 'building').length;
  document.getElementById('forge-stat-deployed').textContent = forgeBuilds.filter(b => b.status === 'deployed').length;
  document.getElementById('forge-stat-approved').textContent = forgeBuilds.filter(b => b.status === 'reviewed').length;

  if (forgeBuilds.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-dim);grid-column:1/-1;"><div style="font-size:40px;opacity:0.3;margin-bottom:8px;">üî®</div><div>Forge is empty. Send an idea from The Fountain!</div></div>';
    return;
  }

  container.innerHTML = forgeBuilds.map(build => {
    let statusColor = '#ff8a00'; // queued
    let statusIcon = '‚è≥';
    if (build.status === 'building') { statusColor = '#00e5ff'; statusIcon = '‚öôÔ∏è'; }
    if (build.status === 'deployed') { statusColor = '#00ff99'; statusIcon = '‚úÖ'; }
    if (build.status === 'failed') { statusColor = '#ff2244'; statusIcon = '‚ùå'; }
    if (build.status === 'reviewed') { statusColor = '#a855f7'; statusIcon = 'üëë'; }

    return `
      <div class="bot-card" style="border-top: 3px solid ${statusColor};">
        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px;">
          <span style="font-size:11px;padding:3px 8px;border-radius:4px;background:${statusColor}22;color:${statusColor};font-weight:600;text-transform:uppercase;">${statusIcon} ${build.status}</span>
          <span style="font-size:10px;color:var(--text-dim);">${ftTimeAgo(build.updatedAt || build.createdAt)}</span>
        </div>
        <div style="font-family:'Orbitron',sans-serif;font-size:15px;font-weight:700;color:var(--text-primary);margin-bottom:6px;">${escapeHtml(build.title)}</div>
        <div style="font-size:12px;color:var(--text-secondary);line-height:1.5;margin-bottom:12px;">${escapeHtml(build.description || 'No description')}</div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;font-size:11px;">
          <div style="background:var(--bg-card-hover);padding:6px 10px;border-radius:6px;">
            <div style="color:var(--text-dim);">Est. Cost</div>
            <div style="color:var(--text-primary);font-weight:600;">${build.costEstimate || '$0.00'}</div>
          </div>
          <div style="background:var(--bg-card-hover);padding:6px 10px;border-radius:6px;">
            <div style="color:var(--text-dim);">Build ID</div>
            <div style="color:var(--text-secondary);font-family:'SF Mono',monospace;font-size:10px;">${build.id.slice(-6)}</div>
          </div>
        </div>

        ${build.previewUrl ? `<a href="${build.previewUrl}" target="_blank" style="display:block;text-align:center;background:rgba(0,255,153,0.1);color:#00ff99;padding:8px;border-radius:6px;text-decoration:none;font-weight:600;font-size:12px;margin-bottom:10px;">üåê View Deployment</a>` : ''}

        <div style="display:flex;gap:8px;margin-top:auto;">
          ${build.status === 'deployed' ? `
            <button onclick="updateBuildStatus('${build.id}', 'reviewed')" style="flex:1;background:rgba(168,85,247,0.1);color:#a855f7;border:1px solid rgba(168,85,247,0.3);padding:6px;border-radius:6px;cursor:pointer;font-size:11px;">‚úÖ Approve</button>
            <button onclick="updateBuildStatus('${build.id}', 'failed')" style="flex:1;background:rgba(255,34,68,0.1);color:#ff2244;border:1px solid rgba(255,34,68,0.3);padding:6px;border-radius:6px;cursor:pointer;font-size:11px;">‚ùå Reject</button>
          ` : ''}
          <button onclick="deleteBuild('${build.id}')" style="background:transparent;border:1px solid var(--border-color);color:var(--text-dim);padding:6px 10px;border-radius:6px;cursor:pointer;font-size:11px;margin-left:auto;">üóë</button>
        </div>
      </div>
    `;
  }).join('');
}

async function queueBuild(idea) {
  if (!confirm(`Queue "${idea.title}" for The Forge?`)) return;

  try {
    const res = await fetch('/api/fountain/builds', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        title: idea.title,
        description: idea.description,
        ideaId: idea.id,
        costEstimate: '$' + (Math.random() * 0.08 + 0.01).toFixed(2) // Actual cost: <$0.10 per build
      })
    });

    if (res.ok) {
      showToast('‚úÖ Build queued in The Forge!');
      fetchForgeBuilds();
      // Switch to Forge tab
      document.querySelector('[data-tab="forge"]').click();
    } else {
      showToast('‚ùå Failed to queue build');
    }
  } catch (e) {
    showToast('‚ùå Error: ' + e.message);
  }
}

async function updateBuildStatus(id, status) {
  try {
    await fetch(`/api/fountain/builds/${id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status })
    });
    fetchForgeBuilds();
  } catch (e) { console.error(e); }
}

async function deleteBuild(id) {
  if (!confirm('Delete this build?')) return;
  try {
    await fetch(`/api/fountain/builds/${id}`, { method: 'DELETE' });
    fetchForgeBuilds();
  } catch (e) { console.error(e); }
}

function queueBuildById(id) {
  const idea = fountainIdeas.find(i => i.id === id);
  if (idea) queueBuild(idea);
}

// Load Forge/Beta data when tab clicked
document.querySelectorAll('.nav-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    const t = tab.getAttribute('data-tab');
    if (t === 'forge') fetchForgeBuilds();
    if (t === 'beta') loadBetaBuilds();
  });
});

// Live Signal Monitor
async function fetchSignalMonitor() {
  try {
    // Fetch latest signal
    const res = await fetch('/api/signals/ict');
    const signals = await res.json();
    
    if (signals && signals.length > 0) {
      // Find latest valid signal
      const latest = signals[0];
      updateMonitorUI(latest);
    } else {
      document.getElementById('mon-signal-content').style.display = 'none';
      document.getElementById('mon-signal-empty').style.display = 'block';
    }
    
    // Check pending X post status
    const pendingRes = await fetch('/api/signals/pending');
    if (pendingRes.ok) {
      const pending = await pendingRes.json();
      updateXPreview(pending);
    } else {
      document.getElementById('mon-x-status').textContent = 'WAITING';
      document.getElementById('mon-tweet-text').textContent = '‚è≥ Waiting for qualifying signal...';
      document.getElementById('mon-post-btn').className = 'x-btn';
    }
    
  } catch (e) {
    console.error('Signal Monitor Error:', e);
  }
}

function updateMonitorUI(signal) {
  const container = document.getElementById('mon-signal-card');
  const content = document.getElementById('mon-signal-content');
  const empty = document.getElementById('mon-signal-empty');
  
  if (!signal) {
    content.style.display = 'none';
    empty.style.display = 'block';
    return;
  }
  
  content.style.display = 'block';
  empty.style.display = 'none';
  
  // Update fields
  document.getElementById('mon-model').textContent = (signal.model || 'Unknown').replace('_', ' ');
  document.getElementById('mon-trigger').textContent = (signal.trigger || 'SIGNAL').replace('_', ' ');
  
  const badge = document.getElementById('mon-badge');
  const bias = (signal.bias || 'NEUTRAL').toUpperCase();
  badge.textContent = bias;
  badge.className = 'signal-badge-large ' + (bias.includes('BULL') ? 'bull' : bias.includes('BEAR') ? 'bear' : '');
  
  document.getElementById('mon-entry').textContent = signal.entryZone || '‚Äî';
  document.getElementById('mon-target').textContent = signal.dol || '‚Äî';
  document.getElementById('mon-session').textContent = signal.raw?.session || '‚Äî';
  document.getElementById('mon-level').textContent = signal.keyLevel || '‚Äî';
  
  const score = signal.confidence || 0;
  document.getElementById('mon-score-val').textContent = score + '%';
  document.getElementById('mon-score-bar').style.width = score + '%';
  
  document.getElementById('mon-narrative').textContent = signal.biasReason || 'No narrative provided.';
  
  // Time diff
  const seconds = Math.floor((new Date() - new Date(signal.timestamp)) / 1000);
  document.getElementById('mon-live-timer').textContent = `${seconds}s ago`;
  
  // Highlight if high conviction
  if (score >= 60 && (signal.trigger === 'CONVICTION_CROSSED' || signal.trigger === 'PRE_MARKET')) {
    container.classList.add('active-signal');
  } else {
    container.classList.remove('active-signal');
  }
}

function updateXPreview(signal) {
  const status = document.getElementById('mon-x-status');
  const text = document.getElementById('mon-tweet-text');
  const btn = document.getElementById('mon-post-btn');
  
  if (signal && (signal.trigger === 'CONVICTION_CROSSED' || signal.trigger === 'PRE_MARKET')) {
    status.textContent = '‚úÖ CONFIRMED ‚Äî Ready for X';
    status.style.color = 'var(--accent-green)';
    
    // Construct tweet text
    const emoji = signal.bias === 'BULLISH' ? 'üü¢' : 'üî¥';
    const tweet = `üö® SIGNAL ALERT: ${signal.model || 'Setup'} ${emoji}

Direction: ${signal.bias}
Confidence: ${signal.confidence}%
Entry: ${signal.entryZone || 'Market'}
Target: ${signal.dol}

Narrative: ${signal.biasReason}

#ICT #Trading #Futures`;
    
    text.textContent = tweet;
    btn.className = 'x-btn ready';
    // btn.disabled = false; // Kept disabled per spec
  } else {
    status.textContent = 'WAITING';
    status.style.color = 'var(--text-dim)';
    text.textContent = '‚è≥ Waiting for qualifying signal (Conviction ‚â• 60%)...';
    btn.className = 'x-btn';
  }
}

// Start Monitor
setInterval(fetchSignalMonitor, 15000);
fetchSignalMonitor();

// BILLS CALENDAR LOGIC (Merged with Expenses)
let currentBillMonth = new Date();

function renderBillsCalendar() {
  const grid = document.getElementById('bills-cal-grid');
  if(!grid) return;
  
  // Use expenses as the data source
  const expenses = loadExpenses();
  
  grid.innerHTML = '';
  
  const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  days.forEach(d => {
    grid.innerHTML += `<div style="background:#0a0a12;padding:8px;text-align:center;font-size:10px;color:var(--text-dim);text-transform:uppercase;">${d}</div>`;
  });

  const year = currentBillMonth.getFullYear();
  const month = currentBillMonth.getMonth();
  
  const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
  const display = document.getElementById('bills-month-display');
  if(display) display.textContent = `${monthNames[month]} ${year}`;

  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const startDayOfWeek = firstDay.getDay(); 
  const daysInMonth = lastDay.getDate();
  
  const prevMonthLastDay = new Date(year, month, 0).getDate();
  for (let i = startDayOfWeek - 1; i >= 0; i--) {
    grid.innerHTML += `<div class="bill-day-cell other-month"><div class="bill-day-num">${prevMonthLastDay - i}</div></div>`;
  }

  const today = new Date();
  const isCurrentMonth = today.getMonth() === month && today.getFullYear() === year;
  let totalDue = 0;
  let remainingDue = 0;

  for (let d = 1; d <= daysInMonth; d++) {
    const isToday = isCurrentMonth && d === today.getDate();
    let cellHtml = `<div class="bill-day-cell ${isToday ? 'today' : ''}"><div class="bill-day-num">${d}</div>`;
    
    // Find expenses due on this day
    const dayExpenses = expenses.map((e, idx) => ({...e, idx})).filter(e => e.dueDay === d);
    
    dayExpenses.forEach(exp => {
      totalDue += parseFloat(exp.cost);
      if ((isCurrentMonth && d >= today.getDate()) || (today.getMonth() < month && today.getFullYear() === year) || today.getFullYear() < year) {
        remainingDue += parseFloat(exp.cost);
      }
      
      const color = exp.cat === 'business' ? '#00d4ff' : '#ffaa00';
      // Clicking scrolls to the expense in the table
      cellHtml += `<div class="bill-pill" style="border-left-color:${color};color:${color}" onclick="highlightExpense(${exp.idx})">
        ${exp.name} - $${exp.cost}
      </div>`;
    });

    cellHtml += `</div>`;
    grid.innerHTML += cellHtml;
  }
  
  const totalEl = document.getElementById('bills-total-monthly');
  if(totalEl) totalEl.textContent = '$' + totalDue.toLocaleString(undefined, {minimumFractionDigits: 2});
  
  const remainEl = document.getElementById('bills-remaining');
  if(remainEl) remainEl.textContent = '$' + remainingDue.toLocaleString(undefined, {minimumFractionDigits: 2});
  
  // Next due logic
  const nextBills = expenses.filter(e => e.dueDay && e.dueDay >= today.getDate()).sort((a,b) => a.dueDay - b.dueDay);
  const nextEl = document.getElementById('bills-next-due');
  if (nextEl) {
    if (nextBills.length > 0 && isCurrentMonth) {
      nextEl.textContent = `${nextBills[0].name} (${nextBills[0].dueDay}th)`;
    } else {
      nextEl.textContent = '‚Äî';
    }
  }
}

function changeBillMonth(delta) {
  currentBillMonth.setMonth(currentBillMonth.getMonth() + delta);
  renderBillsCalendar();
}

function goToCurrentBillMonth() {
  currentBillMonth = new Date();
  renderBillsCalendar();
}

// Initial render
renderBillsCalendar();

// --- BETA LOGIC ---
async function loadBetaBuilds() {
  const container = document.getElementById('beta-builds-grid');
  const statsContainer = document.getElementById('beta-stats');
  container.innerHTML = '<div class="loading">Loading Beta Lab...</div>';

  try {
    const res = await fetch('/api/fountain/builds');
    if (!res.ok) throw new Error('Failed to load builds');
    const allBuilds = await res.json();
    
    // Filter: exclude 'queued' and 'building'
    const builds = allBuilds.filter(b => b.status !== 'queued' && b.status !== 'building' && b.status !== 'archived');

    // Calculate stats
    const reviewCount = builds.filter(b => b.status === 'review' || b.status === 'done').length;
    const approvedCount = builds.filter(b => b.status === 'approved' || b.status === 'live').length;
    const rejectedCount = builds.filter(b => b.status === 'rejected').length;
    
    if (statsContainer) {
        statsContainer.innerHTML = `
            <div class="stats-pill"><span style="color:#ffc107">‚óè</span> In Review: ${reviewCount}</div>
            <div class="stats-pill"><span style="color:#4caf50">‚óè</span> Approved: ${approvedCount}</div>
            <div class="stats-pill"><span style="color:#f44336">‚óè</span> Rejected: ${rejectedCount}</div>
        `;
    }


    // === TITAN'S WORKSHOP (queued + building) ===
    const wShop = document.getElementById('titan-workshop');
    const wGrid = document.getElementById('titan-workshop-grid');
    if (wShop && wGrid) {
      const inProgress = allBuilds.filter(b => b.status === 'queued' || b.status === 'building');
      if (inProgress.length > 0) {
        wShop.style.display = 'block';
        const wCount = document.getElementById('titan-count');
        if (wCount) wCount.textContent = '(' + inProgress.length + ' active)';
        wGrid.innerHTML = '';
        inProgress.forEach(b => {
          const card = document.createElement('div');
          card.className = 'beta-card';
          card.style.border = b.status === 'building' ? '1px solid #ff9800' : '1px solid #666';
          const nm = b.name || b.title || 'Untitled';
          const dot = b.status === 'building' 
            ? '<span style="display:inline-block;width:8px;height:8px;background:#ff9800;border-radius:50%;animation:pulse 1.5s infinite;margin-right:6px;"></span>Titan is building...'
            : '<span style="display:inline-block;width:8px;height:8px;background:#ffc107;border-radius:50%;margin-right:6px;"></span>Queued for Titan';
          card.innerHTML = `<div class="card-header"><h3 class="card-title">${nm}</h3><span style="font-size:11px;color:${b.status === 'building' ? '#ff9800' : '#ffc107'};display:flex;align-items:center;">${dot}</span></div>`
            + `<p style="font-size:12px;color:#888;margin:6px 0;">${b.description || ''}</p>`
            + (b.feedback ? `<div style="font-size:11px;color:#00ffff;margin:6px 0;padding:6px 8px;background:#00ffff08;border-radius:4px;border-left:2px solid #00ffff40;">\u{1f4dd} ${b.feedback.substring(0,200)}${b.feedback.length > 200 ? '...' : ''}</div>` : '');
          wGrid.appendChild(card);
        });
      } else {
        wShop.style.display = 'none';
      }
    }

    // === ARCHIVE SECTION ===
    const archDiv = document.getElementById('beta-archive-grid');
    if (archDiv) {
      const archived = allBuilds.filter(b => b.status === 'archived');
      if (archived.length === 0) {
        archDiv.innerHTML = '<div style="color:#666;font-size:13px;padding:20px;text-align:center;">No archived builds</div>';
      } else {
        archDiv.innerHTML = '';
        archived.forEach(b => {
          const card = document.createElement('div');
          card.className = 'beta-card';
          card.style.opacity = '0.6';
          const nm = b.name || b.title || 'Untitled';
          card.innerHTML = `<div class="card-header"><h3 class="card-title" style="font-size:13px;">${nm}</h3><span class="status-badge" style="background:#9e9e9e20;color:#9e9e9e;">Archived</span></div>`
            + `<p style="font-size:12px;color:#666;margin:6px 0;">${b.description || ''}</p>`
            + (b.feedback ? `<div style="font-size:11px;color:#ff9800;margin:4px 0;">\u{1f4dd} ${b.feedback}</div>` : '')
            + `<div class="beta-actions" style="margin-top:8px;"><button class="beta-btn" onclick="updateBetaStatus('${b.id}', 'review')" style="background:#00ffff15;color:#00ffff;border:1px solid #00ffff30;font-size:11px;">\u267b\ufe0f Restore</button></div>`;
          archDiv.appendChild(card);
        });
      }
    }

    container.innerHTML = '';
    
    if (builds.length === 0) {
      container.innerHTML = `
        <div class="empty-state" style="grid-column: 1/-1;">
          <div class="icon">üß™</div>
          <h3>No builds ready for review</h3>
          <p>Queue something in The Forge to see it here!</p>
        </div>`;
      return;
    }

    // Sort: review/done first, then by date descending
    builds.sort((a, b) => {
        const priority = { 'done': 0, 'review': 0, 'approved': 1, 'live': 1, 'rejected': 2 };
        const pA = priority[a.status] !== undefined ? priority[a.status] : 99;
        const pB = priority[b.status] !== undefined ? priority[b.status] : 99;
        
        if (pA !== pB) return pA - pB;
        return new Date(b.updatedAt || b.createdAt || 0) - new Date(a.updatedAt || a.createdAt || 0);
    });

    builds.forEach(build => {
      const card = document.createElement('div');
      card.className = 'card';
      
      let statusClass = build.status;
      let statusLabel = build.status.charAt(0).toUpperCase() + build.status.slice(1);
      
      if (build.status === 'done') {
         statusClass = 'review'; // treat 'done' as 'review' for visual consistency if backend hasn't updated yet
         statusLabel = 'Ready for Review';
      } else if (build.status === 'review') {
         statusLabel = 'Ready for Review';
      } else if (build.status === 'live') {
         statusLabel = 'üöÄ Live';
      }

      const tagsHtml = (build.stack || []).map(t => `<span class="tag">${t}</span>`).join('');
      const cost = build.costEstimate || 'Unknown';
      const dateStr = new Date(build.createdAt).toLocaleString();

      // Auto-detect preview URL from build name
      const slugMap2 = {
        'YouTube Transcriber': 'youtube-transcriber',
        'Crypto Portfolio Tracker': 'crypto-portfolio',
        'Discord Webhook Tester': 'discord-webhook-tester',
        'Trading Journal': 'trading-journal',
        'OpenClaw Templates': 'openclaw-templates'
      };
      const bName = build.name || build.title || '';
      let pUrl = build.previewUrl || '';
      if (!pUrl && bName) {
        const sl = slugMap2[bName];
        if (sl) pUrl = '/beta-preview/' + sl;
      }
      let previewBtn = '';
      if (pUrl) {
          previewBtn = `<button class="beta-btn" onclick="openBetaPreview('${pUrl}', '${bName.replace(/'/g, "")}')" style="background:#00ffff20;color:#00ffff;border:1px solid #00ffff40;">üëÅÔ∏è Preview</button>`;
      }

      // Action buttons logic based on status
      let actionsHtml = '';
      
      if (build.status === 'done' || build.status === 'review' || !build.status) {
         actionsHtml = `
            <button class="beta-btn approve" onclick="updateBetaStatus('${build.id}', 'approved')">‚úÖ Approve</button>
            <button class="beta-btn reject" onclick="updateBetaStatus('${build.id}', 'rejected')">‚ùå Reject</button>
                <button class="beta-btn" onclick="updateBetaStatus('${build.id}', 'archived')" style="background:#9e9e9e15;color:#9e9e9e;border:1px solid #9e9e9e30;">üì¶ Archive</button>
                <button class="beta-btn" onclick="sendToTitan('${build.id}')" style="background:#ff980020;color:#ff9800;border:1px solid #ff980040;">üîÑ Send to Titan</button>
         `;
      } else if (build.status === 'approved') {
         actionsHtml = `
            <button class="beta-btn golive" onclick="updateBetaStatus('${build.id}', 'live')">üöÄ Go Live</button>
            <button class="beta-btn reject" onclick="updateBetaStatus('${build.id}', 'rejected')">‚ùå Revoke</button>
                <button class="beta-btn" onclick="updateBetaStatus('${build.id}', 'archived')" style="background:#9e9e9e15;color:#9e9e9e;border:1px solid #9e9e9e30;">üì¶ Archive</button>
         `;
      } else if (build.status === 'rejected') {
         actionsHtml = `
            <button class="beta-btn rebuild" onclick="updateBetaStatus('${build.id}', 'queued')">üîÑ Rebuild</button>
            <button class="beta-btn approve" onclick="updateBetaStatus('${build.id}', 'approved')">‚úÖ Re-Approve</button>
         `;
      } else if (build.status === 'live') {
         actionsHtml = `
             <button class="beta-btn" disabled style="opacity:0.5; cursor:default;">Deployed</button>
             <button class="beta-btn reject" onclick="updateBetaStatus('${build.id}', 'rejected')">‚ùå Revoke</button>
         `;
      }

      card.innerHTML = `
        <div class="card-header">
          <h3 class="card-title">${build.name || build.title || 'Untitled Build'}</h3>
          <span class="status-badge ${statusClass}">${statusLabel}</span>
        </div>
        <div class="card-meta" style="margin-bottom:10px; font-size:0.8rem; color:#888;">
           <span>${dateStr}</span> ‚Ä¢ <span>Cost: ${cost}</span>
        </div>
        <p style="margin-bottom:15px; font-size:0.9rem; color:#aaa;">${build.description || 'No description provided.'}</p>
        
        <div style="margin:12px 0 8px;">
          <div style="font-size:11px;color:#00ffff;margin-bottom:4px;font-weight:600;">üìù Feedback & Improvements</div>
          <textarea id="feedback-${build.id}" style="width:100%;min-height:60px;background:#0a0a12;border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#ccc;padding:8px;font-size:12px;resize:vertical;font-family:inherit;" placeholder="Type improvements, additions, or notes here...">${build.feedback || ''}</textarea>
          <button onclick="saveBuildFeedback('${build.id}')" style="margin-top:4px;padding:4px 12px;background:#00ff8820;color:#00ff88;border:1px solid #00ff8840;border-radius:4px;cursor:pointer;font-size:11px;">üíæ Save Notes</button>
        </div>
        <div class="beta-actions">
           ${previewBtn}
           ${actionsHtml}
        </div>
      `;
      container.appendChild(card);
    });

  } catch (err) {
    console.error(err);
    container.innerHTML = `<div class="error">Error loading Beta Lab: ${err.message}</div>`;
  }
}

window.updateBetaStatus = async function(id, newStatus) {
    try {
        const res = await fetch(`/api/fountain/builds/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus })
        });
        if (!res.ok) throw new Error('Update failed');
        loadBetaBuilds(); // Refresh UI
    } catch(err) {
        console.error(err);
        alert('Failed to update build status');
    }
}

window.sendToTitan = async function(id) {
    // Save feedback first, then requeue
    const textarea = document.getElementById('feedback-' + id);
    const feedback = textarea ? textarea.value : '';
    try {
        await fetch('/api/fountain/builds/' + id, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ feedback: feedback, status: 'queued' })
        });
        loadBetaBuilds();
        if (typeof showToast === 'function') showToast('Sent back to Titan with feedback!', 'success');
        else alert('Sent back to Titan with your feedback!');
    } catch(e) { console.error(e); alert('Failed to send to Titan'); }
}

window.saveBuildFeedback = async function(id) {
    const textarea = document.getElementById('feedback-' + id);
    if (!textarea) return;
    try {
        const res = await fetch('/api/fountain/builds/' + id, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ feedback: textarea.value })
        });
        if (res.ok) {
            textarea.style.borderColor = '#00ff88';
            setTimeout(() => { textarea.style.borderColor = 'rgba(255,255,255,0.1)'; }, 1500);
        }
    } catch(e) { console.error(e); }
}


// === BETA LAB CLEAN REBUILD ===
// ============================================
// BETA LAB ‚Äî Clean Rebuild (Feb 12, 2026)
// Single source of truth. No duplicates.
// ============================================

const BETA_SLUG_MAP = {
  'YouTube Transcriber': 'youtube-transcriber',
  'Crypto Portfolio Tracker': 'crypto-portfolio',
  'Discord Webhook Tester': 'discord-webhook-tester',
  'Trading Journal': 'trading-journal',
  'OpenClaw Templates': 'openclaw-templates'
};

let betaRefreshInterval = null;

// === MAIN LOAD FUNCTION ===
async function loadBetaBuilds() {
  const container = document.getElementById('beta-builds-grid');
  const workshopSection = document.getElementById('titan-workshop');
  const workshopGrid = document.getElementById('titan-workshop-grid');
  const archiveGrid = document.getElementById('beta-archive-grid');
  const statsEl = document.getElementById('beta-stats');
  const titanStatus = document.getElementById('titan-status');

  try {
    const res = await fetch('/api/fountain/builds');
    if (!res.ok) throw new Error('Failed to load builds');
    const allBuilds = await res.json();

    // Categorize
    const inProgress = allBuilds.filter(b => b.status === 'queued' || b.status === 'building');
    const reviewable = allBuilds.filter(b => !['queued','building','archived'].includes(b.status));
    const archived = allBuilds.filter(b => b.status === 'archived');

    // Stats
    const reviewCount = allBuilds.filter(b => b.status === 'review' || b.status === 'done').length;
    const approvedCount = allBuilds.filter(b => b.status === 'approved' || b.status === 'live').length;
    const rejectedCount = allBuilds.filter(b => b.status === 'rejected').length;
    if (statsEl) {
      statsEl.innerHTML = `
        <span style="color:#ffc107">‚óè</span> In Review: ${reviewCount} &nbsp;
        <span style="color:#4caf50">‚óè</span> Approved: ${approvedCount} &nbsp;
        <span style="color:#f44336">‚óè</span> Rejected: ${rejectedCount}
      `;
    }

    // Titan status indicator
    const isBuilding = inProgress.some(b => b.status === 'building');
    if (titanStatus) {
      titanStatus.innerHTML = isBuilding
        ? '<span style="color:#ff9800;">üî® Titan Building...</span>'
        : inProgress.length > 0
          ? '<span style="color:#ffc107;">‚è≥ Titan Queued (' + inProgress.length + ')</span>'
          : '<span style="color:#666;">üí§ Titan Idle</span>';
    }

    // === WORKSHOP (queued/building) ===
    if (workshopSection && workshopGrid) {
      if (inProgress.length > 0) {
        workshopSection.style.display = 'block';
        const countEl = document.getElementById('titan-count');
        if (countEl) countEl.textContent = '(' + inProgress.length + ' active)';
        workshopGrid.innerHTML = '';
        inProgress.forEach(b => {
          const nm = b.name || b.title || 'Untitled';
          const isActive = b.status === 'building';
          const dot = isActive
            ? '<span class="pulse-dot" style="background:#ff9800;width:8px;height:8px;display:inline-block;border-radius:50%;margin-right:6px;"></span>Building...'
            : '<span style="background:#ffc107;width:8px;height:8px;display:inline-block;border-radius:50%;margin-right:6px;"></span>Queued';
          const card = document.createElement('div');
          card.className = 'beta-card';
          card.style.border = '1px solid ' + (isActive ? '#ff9800' : '#444');
          card.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
              <h3 style="font-size:14px;color:#fff;margin:0;">${esc(nm)}</h3>
              <span style="font-size:11px;color:${isActive?'#ff9800':'#ffc107'};display:flex;align-items:center;">${dot}</span>
            </div>
            <p style="font-size:12px;color:#888;margin:0 0 6px;">${esc(b.description || '')}</p>
            ${b.feedback ? `<div style="font-size:11px;color:#00ffff;padding:6px 8px;background:#00ffff08;border-radius:4px;border-left:2px solid #00ffff40;margin-top:6px;">üìù ${esc(b.feedback.substring(0,200))}${b.feedback.length>200?'...':''}</div>` : ''}
          `;
          workshopGrid.appendChild(card);
        });
      } else {
        workshopSection.style.display = 'none';
      }
    }

    // === REVIEW GRID ===
    container.innerHTML = '';
    if (reviewable.length === 0) {
      container.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#666;padding:40px;">No builds ready for review</div>';
    } else {
      reviewable.forEach(b => {
        const nm = b.name || b.title || 'Untitled';
        const slug = BETA_SLUG_MAP[nm];
        const previewUrl = b.previewUrl || (slug ? '/beta-preview/' + slug : '');
        const dateStr = new Date(b.createdAt).toLocaleString();
        const cost = b.costEstimate || '$0.00';

        // Status badge
        let badgeColor = '#ffc107', badgeText = b.status;
        if (b.status === 'review' || b.status === 'done') { badgeColor = '#ffc107'; badgeText = 'Ready for Review'; }
        else if (b.status === 'approved') { badgeColor = '#4caf50'; badgeText = 'Approved'; }
        else if (b.status === 'rejected') { badgeColor = '#f44336'; badgeText = 'Rejected'; }
        else if (b.status === 'live') { badgeColor = '#00ffff'; badgeText = 'üöÄ Live'; }

        // Action buttons based on status
        let actions = '';
        if (b.status === 'review' || b.status === 'done') {
          actions = `
            ${previewUrl ? `<button class="beta-btn" onclick="openBetaPreview('${previewUrl}','${esc(nm)}')" style="background:#00ffff20;color:#00ffff;border:1px solid #00ffff40;">üëÅÔ∏è Preview</button>` : ''}
            <button class="beta-btn" onclick="updateBuildStatus('${b.id}','approved')" style="background:#4caf5020;color:#4caf50;border:1px solid #4caf5040;">‚úÖ Approve</button>
            <button class="beta-btn" onclick="updateBuildStatus('${b.id}','rejected')" style="background:#f4433620;color:#f44336;border:1px solid #f4433640;">‚ùå Reject</button>
            <button class="beta-btn" onclick="updateBuildStatus('${b.id}','archived')" style="background:#9e9e9e15;color:#9e9e9e;border:1px solid #9e9e9e30;">üì¶ Archive</button>
            <button class="beta-btn" onclick="sendToTitan('${b.id}')" style="background:#ff980020;color:#ff9800;border:1px solid #ff980040;">üîÑ Send to Titan</button>
          `;
        } else if (b.status === 'approved' || b.status === 'live') {
          actions = `
            ${previewUrl ? `<button class="beta-btn" onclick="openBetaPreview('${previewUrl}','${esc(nm)}')" style="background:#00ffff20;color:#00ffff;border:1px solid #00ffff40;">üëÅÔ∏è Preview</button>` : ''}
            <button class="beta-btn" onclick="updateBuildStatus('${b.id}','archived')" style="background:#9e9e9e15;color:#9e9e9e;border:1px solid #9e9e9e30;">üì¶ Archive</button>
          `;
        } else if (b.status === 'rejected') {
          actions = `
            <button class="beta-btn" onclick="sendToTitan('${b.id}')" style="background:#ff980020;color:#ff9800;border:1px solid #ff980040;">üîÑ Send to Titan</button>
            <button class="beta-btn" onclick="updateBuildStatus('${b.id}','archived')" style="background:#9e9e9e15;color:#9e9e9e;border:1px solid #9e9e9e30;">üì¶ Archive</button>
          `;
        }

        const card = document.createElement('div');
        card.className = 'beta-card';
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <h3 style="font-size:14px;color:#fff;margin:0;">${esc(nm)}</h3>
            <span style="font-size:10px;padding:2px 8px;border-radius:4px;background:${badgeColor}20;color:${badgeColor};border:1px solid ${badgeColor}40;">${badgeText}</span>
          </div>
          <div style="font-size:11px;color:#666;margin-bottom:8px;">${dateStr} ‚Ä¢ Cost: ${cost}</div>
          <p style="font-size:12px;color:#aaa;margin-bottom:10px;">${esc(b.description || '')}</p>
          <div style="margin-bottom:10px;">
            <div style="font-size:11px;color:#00ffff;margin-bottom:4px;font-weight:600;">üìù Feedback & Improvements</div>
            <textarea id="feedback-${b.id}" style="width:100%;min-height:50px;background:#0a0a12;border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#ccc;padding:6px;font-size:12px;resize:vertical;font-family:inherit;" placeholder="Type improvements, additions, or notes...">${esc(b.feedback || '')}</textarea>
            <button onclick="saveBuildFeedback('${b.id}')" style="margin-top:4px;padding:3px 10px;background:#00ff8820;color:#00ff88;border:1px solid #00ff8840;border-radius:4px;cursor:pointer;font-size:11px;">üíæ Save Notes</button>
          </div>
          <div style="display:flex;flex-wrap:wrap;gap:6px;">${actions}</div>
        `;
        container.appendChild(card);
      });
    }

    // === ARCHIVE ===
    if (archiveGrid) {
      if (archived.length === 0) {
        archiveGrid.innerHTML = '<div style="color:#666;font-size:13px;padding:20px;text-align:center;">No archived builds</div>';
      } else {
        archiveGrid.innerHTML = '';
        archived.forEach(b => {
          const nm = b.name || b.title || 'Untitled';
          const card = document.createElement('div');
          card.className = 'beta-card';
          card.style.opacity = '0.6';
          card.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
              <h3 style="font-size:13px;color:#aaa;margin:0;">${esc(nm)}</h3>
              <span style="font-size:10px;padding:2px 6px;border-radius:4px;background:#9e9e9e20;color:#9e9e9e;">Archived</span>
            </div>
            <p style="font-size:11px;color:#666;margin:4px 0;">${esc(b.description || '')}</p>
            ${b.feedback ? `<div style="font-size:11px;color:#ff9800;margin:4px 0;">üìù ${esc(b.feedback)}</div>` : ''}
            <button onclick="updateBuildStatus('${b.id}','review')" style="margin-top:6px;padding:3px 10px;background:#00ffff15;color:#00ffff;border:1px solid #00ffff30;border-radius:4px;cursor:pointer;font-size:11px;">‚ôªÔ∏è Restore</button>
          `;
          archiveGrid.appendChild(card);
        });
      }
    }

  } catch (err) {
    console.error('Beta load error:', err);
    if (container) container.innerHTML = '<div style="color:#f44336;padding:20px;">Error loading builds: ' + err.message + '</div>';
  }
}

// === UPDATE BUILD STATUS ===
async function updateBuildStatus(id, newStatus) {
  try {
    const res = await fetch('/api/fountain/builds/' + id, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: newStatus })
    });
    if (!res.ok) throw new Error('Update failed');
    loadBetaBuilds();
    betaToast('Build ' + (newStatus === 'archived' ? 'archived' : 'marked as ' + newStatus), 'success');
  } catch(e) {
    console.error(e);
    betaToast('Failed to update build', 'error');
  }
}

// === SAVE FEEDBACK ===
async function saveBuildFeedback(id) {
  const textarea = document.getElementById('feedback-' + id);
  if (!textarea) return;
  try {
    const res = await fetch('/api/fountain/builds/' + id, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ feedback: textarea.value })
    });
    if (res.ok) {
      textarea.style.borderColor = '#00ff88';
      setTimeout(() => { textarea.style.borderColor = 'rgba(255,255,255,0.1)'; }, 1500);
      betaToast('Notes saved', 'success');
    }
  } catch(e) { console.error(e); }
}

// === SEND TO TITAN ===
async function sendToTitan(id) {
  const textarea = document.getElementById('feedback-' + id);
  const feedback = textarea ? textarea.value : '';
  try {
    await fetch('/api/fountain/builds/' + id, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ feedback: feedback, status: 'queued' })
    });
    loadBetaBuilds();
    betaToast('Sent to Titan with feedback!', 'success');
  } catch(e) {
    console.error(e);
    betaToast('Failed to send to Titan', 'error');
  }
}

// === PREVIEW OVERLAY ===
function openBetaPreview(url, name) {
  let overlay = document.getElementById('beta-preview-overlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'beta-preview-overlay';
    overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.92);z-index:10000;display:flex;flex-direction:column;padding:16px;';
    overlay.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
        <h3 id="beta-preview-title" style="color:#00ffff;margin:0;font-size:16px;">Preview</h3>
        <div style="display:flex;gap:8px;">
          <a id="beta-preview-newtab" href="#" target="_blank" style="color:#00ff88;font-size:13px;text-decoration:none;padding:6px 12px;border:1px solid #00ff8840;border-radius:6px;">‚Üó New Tab</a>
          <button onclick="closeBetaPreview()" style="background:#ff525230;color:#ff5252;border:1px solid #ff525240;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:13px;">‚úï Close</button>
        </div>
      </div>
      <iframe id="beta-preview-iframe" style="flex:1;border:1px solid rgba(255,255,255,0.1);border-radius:8px;background:#0a0a0f;" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
    `;
    document.body.appendChild(overlay);
  }
  overlay.style.display = 'flex';
  document.getElementById('beta-preview-title').textContent = 'üß™ ' + name;
  document.getElementById('beta-preview-newtab').href = url;
  document.getElementById('beta-preview-iframe').src = url;
}

function closeBetaPreview() {
  const overlay = document.getElementById('beta-preview-overlay');
  if (overlay) {
    overlay.style.display = 'none';
    document.getElementById('beta-preview-iframe').src = '';
  }
}

// === TOAST ===
function betaToast(msg, type) {
  if (typeof showToast === 'function') { showToast(msg, type); return; }
  const t = document.createElement('div');
  t.textContent = msg;
  t.style.cssText = 'position:fixed;bottom:20px;right:20px;padding:10px 20px;border-radius:8px;z-index:10001;font-size:13px;color:#fff;background:' + (type==='error'?'#f44336':'#4caf50') + ';box-shadow:0 4px 12px rgba(0,0,0,0.3);';
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

// === HELPER ===
function esc(str) {
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

// === AUTO-REFRESH ===
function startBetaRefresh() {
  if (betaRefreshInterval) clearInterval(betaRefreshInterval);
  betaRefreshInterval = setInterval(loadBetaBuilds, 30000);
}

function stopBetaRefresh() {
  if (betaRefreshInterval) { clearInterval(betaRefreshInterval); betaRefreshInterval = null; }
}

// Make functions global
window.updateBuildStatus = updateBuildStatus;
window.saveBuildFeedback = saveBuildFeedback;
window.sendToTitan = sendToTitan;
window.openBetaPreview = openBetaPreview;
window.closeBetaPreview = closeBetaPreview;
window.loadBetaBuilds = loadBetaBuilds;

</script>
</div><!-- end #app-content -->
</body>
</html>
